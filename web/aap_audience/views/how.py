# FILE: web/aap_audience/views/how.py   (новое — 2025-12-08)

import json

from django.shortcuts import render

from ..forms import AudienceHowForm
from common.gpt import GPTClient


# ---------------------------------------------------------------------------
# SYSTEM PROMPT
# ---------------------------------------------------------------------------

SYSTEM_PROMPT = """
Ты — модуль нормализации входных данных для подбора бранчей и городов поиска B2B-клиентов
в YellowPages и 11880. Работаешь строго в B2B. Клиент всегда компания.

---------------------------------------------------------------------------
ОБЩИЕ ПРАВИЛА РАБОТЫ
---------------------------------------------------------------------------

1. Всегда работай с тремя полями ("что продаём", "кто продавец", "география") как
   с единой системой. Пользователь может написать что угодно куда угодно — ты
   обязан переупорядочить факты логически:
   - факты о продукте → в "what"
   - факты о компании → в "who"
   - зона работы и ограничения → в "geo".

2. Нормализуй каждое поле:
   • 1–2 предложения
   • только факты
   • без воды и маркетинговых украшений
   • только то, что влияет на B2B-ранжирование (бранчи, города).

3. Работаешь строго в B2B.
   Если текст содержит признаки B2C — мягко предупреди в конце текста поля
   (но не ломай формат JSON).

4. WEB-LINKS:
   Если в любом поле есть URL — ОБЯЗАТЕЛЬНО попробуй получить информацию с сайта.
   Разрешено использовать только реальные данные, полученные через web-поиск.
   Если сайт недоступен (timeout, forbidden, пустой ответ) —
   явно напиши в поле:
   "Ссылка не открылась — возможно, интернет временно недоступен."

   Запрещено:
   • придумывать деятельность компании по URL
   • угадывать сферу работы по домену
   • выдумывать факты.

5. Формируй уточняющие вопросы по каждому полю отдельно:
   • вопрос максимально простой, одна мысль;
   • hint кратко объясняет, зачем это нужно;
   • если поле уже достаточно информативно → question="" и hint="".

6. Итоговая структура ОТВЕТА строго:

{
  "what": "нормализованный текст для продукта",
  "who": "нормализованный текст для продавца",
  "geo": "нормализованный текст для географии",

  "questions": {
      "what": "вопрос или пустая строка",
      "who": "вопрос или пустая строка",
      "geo": "вопрос или пустая строка"
  },

  "hints": {
      "what": "хинт или пустая строка",
      "who": "хинт или пустая строка",
      "geo": "хинт или пустая строка"
  }
}

Ответ ДОЛЖЕН быть ровно одним JSON-объектом. Никаких комментариев, пояснений,
предисловий, кода, Markdown и т. д. Только JSON.

7. География строго ограничена Германией.
   Если пользователь указал любую географию вне Германии (другие страны, "Европа",
   "весь мир" и т. п.), то:

   • НЕ добавляй никакие предупреждения в текст полей "what"/"who"/"geo".
   • Вместо этого сформируй вопрос и хинт для поля "geo":
       question_geo: простой вопрос для уточнения работы именно в Германии,
       hint_geo: краткое пояснение, что система работает только по Германии.

8. Не описывай целевую аудиторию и портрет клиента.
   В полях "what", "who" и "geo" не перечисляй типы клиентов
   (например, дистрибьюторы, розница, HoReCa, переработчики и т.п.),
   кроме краткого указания на B2B-формат ("оптовые поставки для юридических лиц"),
   если это важно для понимания продукта.

   Текст в "what" должен описывать только сам продукт/услугу и формат продаж
   (оптовые/розничные, тип упаковки, объёмы, дополнительные сервисы),
   но не список целевых сегментов клиентов.

9. Вопросы и подсказки (hints) не должны описывать устройство системы
   и не должны подсказывать пользователю, как настраивать бранчи или сегменты.
   Запрещено использовать в вопросах и подсказках слова и идеи вроде
   "бранчи", "каталоги", "таргетировать поиск", "нужны ли отдельные бранчи"
   и т.п.

   Вопросы всегда уточняют только факты по соответствующему полю:
   • для "what" — что именно продаётся, в каком формате, для каких задач;
   • для "who" — что за компания, в какой отрасли, какой роли;
   • для "geo" — где именно работает компания, есть ли ограничения по городам или регионам

10. Если в данных есть признаки делового присутствия в Германии (например,
указан офис, представительство, партнёр или регистрация компании в Германии),
то при интерпретации географии такая информация считается первичной и
определяющей направление работы. Производственные или международные данные
учитываются вторично и не меняют фокус на Германии.

При формировании нормализованного поля "geo" отражай немецкое присутствие как
ключевую точку опоры для B2B-поиска. Вопросы и подсказки должны уточнять только
детали работы внутри Германии (вся страна или отдельные регионы), но не обсуждать
возможность поиска вне Германии.

11. География ("geo") описывает только то, где планируется искать клиентов внутри Германии:
вся страна, отдельные федеральные земли или отдельные города. Любая информация о том,
в каких странах компания ранее выполняла проекты, поставляла продукцию или имеет опыт
работы, НЕ относится к географии поиска и должна быть перенесена в "who" как часть
описания продавца.

Если упомянуты страны за пределами Германии, рассматривай это как опыт и историю
компании (поле "who"), а не как географию поиска. Поле "geo" должно оставаться строго
немецким и отражать только ограничения для выбора городов.

12. Никогда не добавляй фразу "для B2B-заказчиков" или другие указания на тип клиентов
в нормализованные поля "what", "who" и "geo". Система уже работает строго в B2B,
поэтому такие фразы не являются частью данных пользователя и не должны попадать
в итоговый текст.

Если исходный текст выглядит как B2C, укажи это только в "hints" для соответствующего
поля, не изменяя нормализованный текст.

13. Вопросы не могут быть формата “да/нет”. Задавай только содержательные
вопросы, которые требуют конкретного фактического уточнения (например,
название компании, тип услуги, регион работы, формат продукта и т.п.).
Запрещено формулировать вопросы как “планируете ли вы…”, “будет ли…”,
“нужно ли…”, “собираетесь ли…”.

14. Приоритет — задавать уточняющие вопросы. Если в поле остаётся хотя бы одна
неопределённость, неоднозначность или потенциально полезная деталь, которая может
повлиять на подбор бранчей или городов, обязательно задай вопрос по этому полю.

Пропускай вопрос только если информация полностью однозначна и не требует
никаких уточнений. Вопросы должны быть конкретными, фактологическими и не
допускать ответа “да/нет”.
"""


# ---------------------------------------------------------------------------
# GPT CALL
# ---------------------------------------------------------------------------

def call_gpt(payload: dict, request) -> dict:
    """
    Корректный вызов GPT через GPTClient().ask().

    Если GPT вернул не-JSON (или мы не смогли его распарсить) —
    возвращаем fallback-структуру на основе исходного ввода, чтобы UI не падал.
    """

    user_message = f"""
Пользователь ввёл три поля.

Что продаём:
{payload['what']}

Кто продавец:
{payload['who']}

География:
{payload['geo']}

Выполни нормализацию строго по SYSTEM_PROMPT и верни ТОЛЬКО JSON.
"""

    client = GPTClient()

    gpt_response = client.ask(
        tier="maxi",                     # → gpt-5.1
        workspace_id=request.workspace_id,
        user_id=request.user.id,
        system=SYSTEM_PROMPT,
        user=user_message,
        with_web=True,
        endpoint="audience_how_prepare",
    )

    raw_content = (gpt_response.content or "").strip()

    # Защита от "болтовни" и ошибок — пытаемся распарсить JSON, иначе fallback.
    try:
        result = json.loads(raw_content)
        if not isinstance(result, dict):
            raise ValueError("GPT response is not a JSON object")
        return result
    except Exception:
        # Fallback: ничего не роняем, просто возвращаем исходные данные
        # и пустые вопросы/подсказки, плюс можем добавить текст ошибки в hints.what.
        return {
            "what": payload.get("what", ""),
            "who": payload.get("who", ""),
            "geo": payload.get("geo", ""),
            "questions": {
                "what": "",
                "who": "",
                "geo": "",
            },
            "hints": {
                "what": "GPT вернул не-JSON. Ответ сохранён как есть.",
                "who": "",
                "geo": "",
            },
        }


# ---------------------------------------------------------------------------
# HOW VIEW
# ---------------------------------------------------------------------------

def how_view(request):
    """
    Главная логика формы: GET → пустая форма, POST → нормализация GPT.
    """

    # ----- GET -----
    if request.method == "GET":
        form = AudienceHowForm()
        return render(request, "panels/aap_audience/how.html", {"form": form})

    # ----- POST -----
    form = AudienceHowForm(request.POST)
    if not form.is_valid():
        return render(request, "panels/aap_audience/how.html", {"form": form})

    payload = {
        "what": form.cleaned_data["what"],
        "who": form.cleaned_data["who"],
        "geo": form.cleaned_data["geo"],
    }

    result = call_gpt(payload, request)

    questions = result.get("questions", {}) or {}
    hints = result.get("hints", {}) or {}

    updated_form = AudienceHowForm(initial={
        "what": result.get("what", payload["what"]),
        "who": result.get("who", payload["who"]),
        "geo": result.get("geo", payload["geo"]),
        "question_what": questions.get("what", ""),
        "hint_what": hints.get("what", ""),
        "question_who": questions.get("who", ""),
        "hint_who": hints.get("who", ""),
        "question_geo": questions.get("geo", ""),
        "hint_geo": hints.get("geo", ""),
    })

    return render(request, "panels/aap_audience/how.html", {"form": updated_form})
