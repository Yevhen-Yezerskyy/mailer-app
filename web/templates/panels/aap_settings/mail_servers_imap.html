{% extends "panels/base.html" %}<!-- -->
{% load i18n %}<!-- -->
{% load static %}<!-- -->
<!-- FILE: web/templates/panels/aap_settings/mail_servers_imap.html  (–æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî 2026-01-23) -->
<!-- PURPOSE: Settings ‚Üí Mail servers: IMAP —Ñ–æ—Ä–º–∞ (—Ä—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–ª–∏ OAuth2). -->
<!-- CHANGE:
- Checks panel: domain only if not whitelisted; IMAP check only in login mode (JS hides in OAuth).
- Fix absolute URLs for checks/secret via data-* on form.
- Connect href set via data-oauth-* (JS). -->

{% block content %}

{% include "panels/aap_settings/partials/mail_secret_modal.html" %}

{{ presets|json_script:"yyPresets" }}

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-[60%]">
      <div class="YY-CARD_WHITE">

        <div class="YY-STATUS_BLUE mb-4">IMAP: {{ mb.email }}</div>

        <form id="yyMailServerForm"
              method="post"
              data-api-url="{% url 'settings:mail_servers_api' %}"
              data-secret-url="{% url 'settings:mail_server_secret' %}"
              data-oauth-google-url="{% url 'settings:mail_oauth_start' provider='google' kind='imap' mailbox_id=mb.id %}"
              data-oauth-microsoft-url="{% url 'settings:mail_oauth_start' provider='microsoft' kind='imap' mailbox_id=mb.id %}"
              data-next-url="{% url 'settings:mail_servers_imap' mb_token %}">
          {% csrf_token %}
          <input type="hidden" name="id" value="{{ mb_token }}">

          {% if form.non_field_errors %}
            <div class="YY-CARD_IN_FORM_ERROR mb-3">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="grid grid-cols-[2fr_1fr] gap-4 mb-6">
            <div>
              <label class="YY-LABEL">{% trans "–ü—Ä–µ—Å–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞" %}:</label>
              {{ form.preset_code }}
            </div>
            <div>
              <label class="YY-LABEL">Auth:</label>
              <div class="max-w-[220px]">
                {{ form.auth_type }}
              </div>
            </div>
          </div>

          <div id="yyManualBlock">
            <div class="grid grid-cols-2 gap-4 mb-2">
              <div>
                <label class="YY-LABEL">Host:</label>
                {{ form.host }}
              </div>
              <div>
                <label class="YY-LABEL">Port:</label>
                {{ form.port }}
              </div>
            </div>

            <div class="grid grid-cols-[1fr_3fr] gap-4 mb-6">
              <div>
                <label class="YY-LABEL">Security:</label>
                <div class="max-w-[220px]">
                  {{ form.security }}
                </div>
              </div>
              <div>
                <label class="YY-LABEL">Username:</label>
                {{ form.username }}
              </div>
            </div>

            <div class="mb-6">
              <label class="YY-LABEL">Password / Token:</label>
              <div class="relative">
                {{ form.secret }}
                <button type="button"
                        class="absolute right-2 top-1 text-[#006991] text-xl"
                        onclick="yyTogglePasswordOrReveal('imap', 'yySecret')">üëÅÔ∏é</button>
              </div>
            </div>
          </div>

          <div id="yyOauthBlock" class="hidden">
            <div class="YY-STATUS_YELLOW mb-4">
              {% trans "OAuth2 —Ä–µ–∂–∏–º: –Ω–∞–∂–º–∏—Ç–µ Connect. –†—É—á–Ω—ã–µ –ø–æ–ª—è —Å–∫—Ä—ã—Ç—ã." %}
            </div>
            <a id="yyConnectBtn" class="YY-BUTTON_MAIN inline-block" href="#">{% trans "Connect" %}</a>
          </div>

          <div class="flex gap-3 mt-6">
            <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN">{% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" %}</button>
            <button type="submit" name="action" value="delete_imap" class="YY-BUTTON_TAB_RED" formnovalidate>{% trans "–£–¥–∞–ª–∏—Ç—å IMAP" %}</button>
            <button type="submit" name="action" value="close" class="YY-BUTTON_MAIN" formnovalidate>{% trans "–ù–∞–∑–∞–¥" %}</button>
          </div>

        </form>

      </div>
    </td>

    <td class="YY-MAIN_TOP_RIGHT_TD w-[40%]">
      <div class="YY-CARD_WHITE">

        <div id="yyMailChecksDirtyHint" class="YY-STATUS_YELLOW hidden mb-4">
          {% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É." %}
        </div>

        <div id="yyMailChecksPanel">
          <div class="YY-STATUS_BLUE mb-3">{% trans "–ü—Ä–æ–≤–µ—Ä–∫–∏" %}</div>

          <div id="yyProtoChecksOauthHint" class="YY-STATUS_YELLOW hidden mb-3">
            {% trans "OAuth2: –ø—Ä–æ–≤–µ—Ä–∫–∞ IMAP –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è." %}
          </div>

          <div id="yyProtoChecksWrap" class="flex gap-3 flex-wrap mb-3">
            <button id="yyChkImap" type="button" class="YY-BUTTON_MAIN" onclick="yyMailServersCheck('check_imap','yyChkImap')">
              {% trans "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å IMAP" %}
            </button>
          </div>

          {% if domain_whitelisted %}
            <div class="YY-STATUS_GREEN mb-3">
              TRUSTED SERVICE PROVIDER ‚Äî CHECK IS NOT NEEDED
            </div>
          {% else %}
            <div class="flex gap-3 flex-wrap mb-3">
              <button id="yyChkDomain" type="button" class="YY-BUTTON_MAIN" onclick="yyMailServersCheck('check_domain','yyChkDomain')">
                {% trans "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–º–µ–Ω" %}
              </button>
            </div>
          {% endif %}

          <div class="mt-4">
            <textarea id="yyMailChecksOut" class="YY-INPUT w-full min-h-[350px]" readonly></textarea>
          </div>
        </div>

      </div>
    </td>
  </tr>
</table>

<script src="{% static 'js/aap_settings/mail_servers_secret.js' %}"></script>
<script src="{% static 'js/aap_settings/mail_servers_checks.js' %}"></script>
<script src="{% static 'js/aap_settings/mail_servers_presets.js' %}"></script>
<script src="{% static 'js/aap_settings/mail_servers_auth.js' %}"></script>

{% endblock %}
