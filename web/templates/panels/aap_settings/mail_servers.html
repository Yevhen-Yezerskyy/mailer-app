{% extends "panels/base.html" %}
{% load i18n %}
{% load static %}
<!-- FILE: web/templates/panels/aap_settings/mail_servers.html -->
<!-- DATE: 2026-01-26 -->
<!-- PURPOSE: Settings → Mail servers: mailbox list/add/edit/delete + status blocks for last checks. -->
<!-- CHANGE:
- FIX: форма должна иметь id="yySmtpForm" (mail_servers_checks.js ищет именно этот id).
- Статусы печатаются раздельно: dt / action / status.
- SMTP показывает две проверки: SMTP_AUTH_CHECK + SMTP_SEND_CHECK.
- Domain/IMAP тоже печатаются раздельно через rec-объекты из view. -->

{% block content %}

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-[69%]">
      <div class="YY-CARD_WHITE">

        {% if state == "add" or state == "edit" %}
          <form
            id="yySmtpForm"
            method="post"
            data-api-url="{% url 'settings:mail_servers_api' %}"
          >
            {% csrf_token %}

            {% if state == "edit" and edit_obj %}
              <input type="hidden" name="id" value="{{ edit_obj.ui_id }}">
            {% endif %}

            <div class="grid grid-cols-1 gap-4 mb-2">
              <div>
                <label class="YY-LABEL">{% trans "Электронная почта почтового сервиса" %}:</label>
                {{ form.email }}
                {% if form.email.errors %}
                  <div class="YY-CARD_IN_FORM_ERROR">{{ form.email.errors }}</div>
                {% endif %}
              </div>
            </div>

            {% if state == "edit" and edit_obj %}
              <div class="grid grid-cols-3 gap-3 mb-10 mt-4">

                <div>
                  <div class="YY-STATUS_BLUE mb-4 !text-sm">{% trans "Домен" %}: {{ edit_obj.domain_name }}</div>

                  {% if edit_obj.domain_whitelisted %}
                    <div class="YY-STATUS_GREEN !text-sm">{% trans "Публичный сервис-провайдер" %}<br>{% trans "Проверка домена не нужна" %}</div>
                  {% elif edit_obj.domain_tested %}
                      {% if edit_obj.domain_tech %}
                          {% if edit_obj.domain_tech.status == "GOOD" %} 
                            <div class="YY-STATUS_GREEN !text-sm !mb-2">
                          {% elif edit_obj.domain_tech.status == "NORMAL" %} 
                            <div class="YY-STATUS_YELLOW !text-sm !mb-2">
                          {% elif edit_obj.domain_tech.status == "BAD" %} 
                            <div class="YY-STATUS_RED !text-sm !mb-2">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm !mb-2">
                          {% endif %}
                          <div>{{ edit_obj.domain_tech.dt }}</div>
                          <div><b>{{ edit_obj.domain_tech.action }}: {{ edit_obj.domain_tech.status }}</b></div>
                        </div>
                      {% else %}
                        <div class="YY-STATUS_YELLOW !text-sm !mb-2">
                          {% trans "Не проверено" %}
                        </div>
                      {% endif %}
                    <div>
                      {% if edit_obj.domain_rep %}
                          {% if edit_obj.domain_rep.status == "NORMAL" %} 
                            <div class="YY-STATUS_GREEN !text-sm ">
                          {% elif edit_obj.domain_rep.status == "QUESTIONABLE" %} 
                            <div class="YY-STATUS_RED !text-sm ">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm ">
                          {% endif %}                      
                          <div>{{ edit_obj.domain_rep.dt }}</div>
                          <div><b>{{ edit_obj.domain_rep.action }}: {{ edit_obj.domain_rep.status }}</b></div>
                        </div>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="YY-STATUS_YELLOW mb-2 !text-sm">{% trans "Домен не проверен" %}</div>
                    <button
                      type="button"
                      class="YY-BUTTON_TAB_MAIN !text-sm"
                      onclick="document.getElementById('yyChkDomain')?.click();"
                    >
                      {% trans "Проверить домен" %}
                    </button>
                  {% endif %}
                </div>

                <div>
                  {% if not edit_obj.smtp_configured %}
                    <a href="{% url 'settings:mail_servers_smtp' edit_obj.ui_id %}" class="YY-BUTTON_TAB_MAIN mb-5 !text-sm">
                      {% trans "Настроить SMTP сервер" %}
                    </a>

                    <div class="YY-STATUS_YELLOW text-sm">{% trans "SMTP не настроен" %}</div>
                  {% else %}
                    <a href="{% url 'settings:mail_servers_smtp' edit_obj.ui_id %}" class="YY-BUTTON_TAB_MAIN mb-5 !text-sm">
                      {% trans "Изменить SMTP сервер" %}
                    </a>

                      {% if edit_obj.smtp_auth %}
                          {% if edit_obj.smtp_auth.status == "SUCCESS" %} 
                            <div class="YY-STATUS_GREEN !text-sm !mb-2">
                          {% elif edit_obj.smtp_auth.status == "FAIL" %} 
                            <div class="YY-STATUS_RED !text-sm !mb-2">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm !mb-2">
                          {% endif %}

                            <div>{{ edit_obj.smtp_auth.dt }}</div>
                            <div><b>{{ edit_obj.smtp_auth.action }}: {{ edit_obj.smtp_auth.status }}</b></div>
                          </div>
                      {% else %}
                        <div class="YY-STATUS_YELLOW !text-sm !mb-2">
                          {% trans "Не проверено" %}
                        </div>
                      {% endif %}
                     {% if edit_obj.smtp_send %}
                          {% if edit_obj.smtp_send.status == "SUCCESS" %} 
                            <div class="YY-STATUS_GREEN !text-sm !mb-2">
                          {% elif edit_obj.smtp_send.status == "FAIL" %} 
                            <div class="YY-STATUS_RED !text-sm !mb-2">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm !mb-2">
                          {% endif %}                     
                          <div>{{ edit_obj.smtp_send.dt }}</div>
                          <div><b>{{ edit_obj.smtp_send.action }}</b>: {{ edit_obj.smtp_send.status }}</div>
                        </div>
                      {% endif %}
                  {% endif %}
                </div>

                <div>
                  {% if not edit_obj.imap_configured %}
                    <a href="{% url 'settings:mail_servers_imap' edit_obj.ui_id %}" class="YY-BUTTON_TAB_MAIN mb-5 !text-sm">
                      {% trans "Настроить IMAP сервер" %}
                    </a>
                    <div class="YY-STATUS_YELLOW text-sm">{% trans "IMAP не настроен" %}</div>                    
                  {% else %}
                    <a href="{% url 'settings:mail_servers_imap' edit_obj.ui_id %}" class="YY-BUTTON_TAB_MAIN mb-5 !text-sm">
                      {% trans "Изменить IMAP сервер" %}
                    </a>

                      {% if edit_obj.imap_check %}
                          {% if edit_obj.imap_check.status == "SUCCESS" %} 
                            <div class="YY-STATUS_GREEN !text-sm !mb-2">
                          {% elif edit_obj.imap_check.status == "FAIL" %} 
                            <div class="YY-STATUS_RED !text-sm !mb-2">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm !mb-2">
                          {% endif %}                       
                          <div>{{ edit_obj.imap_check.dt }}</div>
                          <div><b>{{ edit_obj.imap_check.action }}</b>: {{ edit_obj.imap_check.status }}</div>
                        </div>
                      {% else %}
                        <div class="YY-STATUS_YELLOW !text-sm !mb-2">
                          {% trans "Не проверено" %}
                        </div>
                      {% endif %}
                  {% endif %}
                </div>

              </div>
            {% endif %}

            <div class="flex gap-3 mt-4">
              <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN w-full">
                {% if state == "edit" %}{% trans "Сохранить изменения" %}{% else %}{% trans "Сохранить" %}{% endif %}
              </button>
              <button type="submit" name="action" value="close" class="YY-BUTTON_MAIN w-full" formnovalidate>
                {% trans "Закрыть" %}
              </button>
            </div>

          </form>

        {% else %}
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div class="YY-STATUS_BLUE">{% trans "Ваши почтовые сервисы (SMTP / IMAP серверы):" %}</div>
          </div>
        {% endif %}

      </div>
    </td>

    <td class="YY-MAIN_TOP_RIGHT_TD w-[31%]">
      <div class="YY-CARD_WHITE">

        {% if state == "edit" and edit_obj %}

          {% if edit_obj.domain_whitelisted %}
            <div class="YY-STATUS_GREEN">{% trans "Публичный сервис-провайдер" %}<br>{% trans "Проверка домена не нужна" %}</div>
          {% else %}
            <div class="flex gap-3 flex-wrap mb-4">
              <button
                id="yyChkDomain"
                type="button"
                class="YY-BUTTON_MAIN"
                onclick="yyMailServersCheck('check_domain','yyChkDomain','yyMailChecksOut')"
              >
                {% trans "Проверить домен" %}
              </button>
            </div>

            <div class="mt-2">
              <textarea
                id="yyMailChecksOut"
                class="YY-INPUT w-full min-h-[300px] !mb-0"
                readonly></textarea>
            </div>
          {% endif %}

        {% elif state == "add" %}
          <p class="YY-LABEL">{% trans "Добавление почтового ящика" %}</p>
        {% else %}
          <a href="?state=add" class="YY-BUTTON_MAIN !py-2">
            {% trans "Добавить" %}
          </a>
        {% endif %}

      </div>
    </td>
  </tr>
</table>

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_BOTTOM_TD">
      {% if items %}
        <div class="YY-MAIN_BOTTOM_DIV">

          <table class="w-full text-left">
            <thead>
              <tr class="YY-TH_TR">
                <th class="YY-TH_TH w-[20%]">Email</th>
                <th class="YY-TH_TH w-[25%]">{% trans "Домен" %}</th>
                <th class="YY-TH_TH w-[25%]">SMTP</th>
                <th class="YY-TH_TH w-[25%]">IMAP</th>
                <th class="YY-TH_TH">&nbsp;</th>
              </tr>
            </thead>

            <tbody>
              {% for it in items %}
                <tr class="YY-TB_TR align-top">

                  <td class="YY-TB_TD">
                    <div class="YY-STATUS_BLUE mb-2">{{ it.email }}</div>
                  </td>

                  <td class="YY-TB_TD">
                    <div class="YY-STATUS_BLUE mb-2">{{ it.domain_name }}</div>

                    {% if it.domain_whitelisted %}
                      <div class="YY-STATUS_GREEN !text-sm">{% trans "Публичный сервис-провайдер" %}<br>{% trans "Проверка домена не нужна" %}</div>
                    {% elif it.domain_tested %}
                        {% if it.domain_tech %}
                          {% if it.domain_tech.status == "GOOD" %} 
                            <div class="YY-STATUS_GREEN !text-sm !mb-2">
                          {% elif it.domain_tech.status == "NORMAL" %} 
                            <div class="YY-STATUS_YELLOW !text-sm !mb-2">
                          {% elif it.domain_tech.status == "BAD" %} 
                            <div class="YY-STATUS_RED !text-sm !mb-2">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm !mb-2">
                          {% endif %}
                          <div>{{ it.domain_tech.dt }}</div>
                          <div><b>{{ it.domain_tech.action }}: {{ it.domain_tech.status }}</b></div>
                        </div>
                        {% else %}
                        <div class="YY-STATUS_YELLOW !text-sm !mb-2">
                          {% trans "Не проверено" %}
                        </div>
                        {% endif %}
                      </div>
                        {% if it.domain_rep %}
                          {% if it.domain_rep.status == "NORMAL" %} 
                            <div class="YY-STATUS_GREEN !text-sm ">
                          {% elif it.domain_rep.status == "QUESTIONABLE" %} 
                            <div class="YY-STATUS_RED !text-sm ">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm ">
                          {% endif %}
                          <div>{{ it.domain_rep.dt }}</div>
                          <div><b>{{ it.domain_rep.action }}: {{ it.domain_rep.status }}</b></div>
                        </div>
                    {% else %}
                    <div class="YY-STATUS_YELLOW !text-sm ">
                      {% trans "Не проверено" %}
                    </div>
                    {% endif %}
                  {% else %}
                    <div class="YY-STATUS_YELLOW !text-sm ">{% trans "Домен не протестирован" %}</div>
                  {% endif %}
                  </td>

                  <td class="YY-TB_TD">
                    {% if not it.smtp_configured %}
                      <a href="{% url 'settings:mail_servers_smtp' it.ui_id %}" class="YY-BUTTON_TAB_MAIN mb-2 ">
                        {% trans "Настроить SMTP сервер" %}
                      </a>
                      <div class="YY-STATUS_YELLOW !text-sm ">{% trans "SMTP не настроен" %}</div>
                    {% else %}
                      <a href="{% url 'settings:mail_servers_smtp' it.ui_id %}" class="YY-BUTTON_TAB_MAIN mb-2 ">
                        {% trans "Изменить SMTP сервер" %}
                      </a>
                        {% if it.smtp_auth %}
                          {% if it.smtp_auth.status == "SUCCESS" %} 
                            <div class="YY-STATUS_GREEN !text-sm !mb-2">
                          {% elif it.smtp_auth.status == "FAIL" %} 
                            <div class="YY-STATUS_RED !text-sm !mb-2">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm !mb-2">
                          {% endif %}
                            <div>{{ it.smtp_auth.dt }}</div>
                            <div><b>{{ it.smtp_auth.action }}: {{ it.smtp_auth.status }}</b></div>
                          </div>
                        {% else %}
                        <div class="YY-STATUS_YELLOW !text-sm !mb-2">
                          {% trans "Не проверено" %}
                        </div>
                        {% endif %}
                        {% if it.smtp_send %}
                          {% if it.smtp_send.status == "SUCCESS" %} 
                            <div class="YY-STATUS_GREEN !text-sm !mb-2">
                          {% elif it.smtp_send.status == "FAIL" %} 
                            <div class="YY-STATUS_RED !text-sm !mb-2">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm !mb-2">
                          {% endif %}
                            <div>{{ it.smtp_send.dt }}</div>
                            <div><b>{{ it.smtp_send.action }}: {{ it.smtp_send.status }}</b></div>
                          </div>
                        {% endif %}
                    {% endif %}
                  </td>

                  <td class="YY-TB_TD">
                    {% if not it.imap_configured %}
                      <a href="{% url 'settings:mail_servers_imap' it.ui_id %}" class="YY-BUTTON_TAB_MAIN mb-2 ">
                        {% trans "Настроить IMAP сервер" %}
                      </a>
                      <div class="YY-STATUS_YELLOW !text-sm ">{% trans "IMAP не настроен" %}</div>
                    {% else %}
                      <a href="{% url 'settings:mail_servers_imap' it.ui_id %}" class="YY-BUTTON_TAB_MAIN mb-2 ">
                        {% trans "Изменить IMAP сервер" %}
                      </a>
                        {% if it.imap_check %}
                          {% if it.imap_check.status == "SUCCESS" %} 
                            <div class="YY-STATUS_GREEN !text-sm !mb-2">
                          {% elif it.imap_check.status == "FAIL" %} 
                            <div class="YY-STATUS_RED !text-sm !mb-2">
                          {% else %} 
                            <div class="YY-STATUS_GRAY !text-sm !mb-2">
                          {% endif %}
                            <div>{{ it.imap_check.dt }}</div>
                            <div><b>{{ it.imap_check.action }}: {{ it.imap_check.status }}</b></div>
                          </div>
                        {% else %}
                        <div class="YY-STATUS_YELLOW !text-sm !mb-2">
                          {% trans "Не проверено" %}
                        </div>
                        {% endif %}
                    {% endif %}
                  </td>

                  <td class="YY-TB_TD">
                    <a href="?state=edit&id={{ it.ui_id }}" class="YY-BUTTON_TAB_MAIN !mb-2">
                      {% trans "Изменить" %}
                    </a>
                    <form method="post" onsubmit="return confirm('{% trans "Вы уверены?" %}');">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="id" value="{{ it.ui_id }}">
                      <button type="submit" class="YY-BUTTON_TAB_RED !mb-2">
                        {% trans "Удалить" %}
                      </button>
                    </form>
                  </td>

                </tr>
              {% endfor %}
            </tbody>
          </table>

        </div>
      {% else %}
        <div class="YY-CARD_WHITE mb-10">
          {% trans "Здесь пока нет данных" %}
        </div>
      {% endif %}
    </td>
  </tr>
</table>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/aap_settings/mail_servers_checks.js' %}"></script>
{% endblock %}
