{% extends "panels/base.html" %}
{% load i18n %}
{% load static %}
<!-- FILE: web/templates/panels/aap_settings/smtp_server.html  (–æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî 2026-01-25) -->
<!-- PURPOSE: Settings ‚Üí SMTP server (–æ—Ç–ø—Ä–∞–≤–∫–∞): —Ñ–æ—Ä–º–∞ SMTP + –ø–æ–∫–∞–∑ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É. -->
<!-- CHANGE:
- –î–æ–±–∞–≤–ª–µ–Ω data-secret-url –Ω–∞ form + –∫–Ω–æ–ø–∫–∞-–≥–ª–∞–∑ –¥–ª—è –ø–æ–ª—è –ø–∞—Ä–æ–ª—è (modal reveal).
- –ü–æ–¥–∫–ª—é—á–µ–Ω—ã partial mail_secret_modal.html –∏ js/aap_settings/mail_servers_secret.js.
- –û—Å—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞/–ø–æ–ª—è/—Å–∫—Ä–∏–ø—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. -->

{% block content %}

<script type="application/json" id="yyPresets">{{ presets_json|safe }}</script>

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-[65%]">
      <div class="YY-CARD_WHITE">
        <form
          id="yySmtpForm"
          method="post"
          data-api-url="{% url 'settings:mail_servers_api' %}"
          data-secret-url="{% url 'settings:mail_servers_smtp_secret' id=mailbox_ui_id %}"
        >
          {% csrf_token %}

          <input type="hidden" name="id" value="{{ mailbox_ui_id }}">
          {{ form.auth_type }}

          <div class="YY-STATUS_BLUE mb-4">SMTP {% trans "—Å–µ—Ä–≤–µ—Ä (–æ—Ç–ø—Ä–∞–≤–∫–∞)" %}</div>

          <div class="grid grid-cols-[2fr_2fr_1fr] gap-4 mb-7">
            <div>
              <label class="YY-LABEL">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å" %}:</label>
              {{ form.sender_name }}
              {% if form.sender_name.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.sender_name.errors }}</div>{% endif %}
            </div>

            <div>
              <label class="YY-LABEL">{% trans "From Email" %}:</label>
              {{ form.email }}
              {% if form.email.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.email.errors }}</div>{% endif %}
            </div>

            <div>
              <label class="YY-LABEL">{% trans "–õ–∏–º–∏—Ç/—á–∞—Å" %}:</label>
              {{ form.limit_hour_sent }}
              {% if form.limit_hour_sent.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.limit_hour_sent.errors }}</div>{% endif %}
            </div>
          </div>

          <div class="YY-CARD_WHITE border border-[#022a39] mt-[30px]">
            <div class="YY-STATUS_BLUE mb-4">{% trans "–î–æ—Å—Ç—É–ø" %}</div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center">
              <div class="YY-LABEL !mb-0">{% trans "–ü—Ä–æ–≤–∞–π–¥–µ—Ä" %}</div>
              <div class="flex gap-2 items-center">
                <select id="yyPresetSelect" class="YY-INPUT !px-1">
                  <option value="">{% trans "–ù–µ –≤—ã–±—Ä–∞–Ω" %}</option>
                  {% for id,name in preset_choices %}
                    <option value="{{ id }}">{{ name }}</option>
                  {% endfor %}
                </select>
                <div class="YY-STATUS_BLUE text-sm">{% trans "–ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ host/port/TLS" %}</div>
              </div>
            </div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center mt-3">
              <div class="YY-LABEL !mb-0">{% trans "Host" %}</div>
              <div>
                {{ form.host }}
                {% if form.host.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.host.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center mt-3">
              <div class="YY-LABEL !mb-0">{% trans "Port" %}</div>
              <div>
                {{ form.port }}
                {% if form.port.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.port.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center mt-3">
              <div class="YY-LABEL !mb-0">{% trans "TLS" %}</div>
              <div>
                {{ form.security }}
                {% if form.security.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.security.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center mt-3">
              <div class="YY-LABEL !mb-0">{% trans "–õ–æ–≥–∏–Ω" %}</div>
              <div>
                {{ form.username }}
                {% if form.username.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.username.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center">
              <div class="YY-LABEL !mb-0">{% trans "–ü–∞—Ä–æ–ª—å" %}</div>
              <div class="flex gap-2 items-center">
                <div class="flex-1">
                  {{ form.password }}
                  {% if form.password.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.password.errors }}</div>{% endif %}
                </div>
                <button
                  type="button"
                  class="YY-BUTTON_MAIN !px-3 !py-2"
                  onclick="yyTogglePasswordOrReveal('smtp','id_password')"
                  title="{% trans '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å' %}"
                >üëÅ</button>
              </div>
            </div>
          </div>

          <div id="yyOauthBlock" class="hidden">
            <div class="YY-CARD_WHITE border border-[#022a39] mt-[30px]">
              <div class="YY-STATUS_YELLOW mb-3">{% trans "OAuth 2.0" %}</div>
              <button type="button" id="yyOauthAuthorizeBtn" class="YY-BUTTON_MAIN w-full !py-4">
                {% trans "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è" %}
              </button>
              <div class="YY-STATUS_BLUE text-sm mt-3">{% trans "–ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞." %}</div>
            </div>
          </div>

          {% if form.non_field_errors %}
            <div class="YY-FORM_ERROR mt-4">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="flex gap-3 mt-6">
            <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN !py-4 w-full">
              {% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" %}
            </button>
            <button type="submit" name="action" value="close" class="YY-BUTTON_BLUE !py-4 w-[160px]">
              {% trans "–ó–∞–∫—Ä—ã—Ç—å" %}
            </button>
          </div>
        </form>

        {% if state == "edit" %}
          <div class="YY-CARD_WHITE border border-[#022a39] mt-[30px]">
            <div class="YY-STATUS_BLUE mb-4">{% trans "–ü—Ä–æ–≤–µ—Ä–∫–∞" %}</div>

            <button
              type="button"
              id="yyCheckSmtpBtn"
              class="YY-BUTTON_MAIN w-full !py-4"
              onclick="yyMailServersCheck('check_smtp', 'yyCheckSmtpBtn')"
            >
              {% trans "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SMTP" %}
            </button>

            <textarea
              id="yyMailChecksOut"
              class="YY-INPUT !min-h-[220px] !font-mono"
              placeholder="{% trans '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å' %}"
            ></textarea>

            <div class="YY-STATUS_BLUE text-sm mt-3">
              {% trans "–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:" %} {{ last_smtp_status|default:"‚Äî" }}
            </div>

            {% if last_smtp_payload %}
              <pre class="mt-2 p-2 bg-gray-50 border rounded text-xs overflow-auto max-h-[240px]">{{ last_smtp_payload }}</pre>
            {% else %}
              <div class="YY-STATUS_YELLOW text-sm mt-2">{% trans "–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ" %}</div>
            {% endif %}
          </div>
        {% endif %}

      </div>
    </td>
  </tr>
</table>

{% include "panels/aap_settings/partials/mail_secret_modal.html" %}

<script src="{% static 'js/aap_settings/mail_servers_secret.js' %}"></script>
<script src="{% static 'js/aap_settings/smtp_server.js' %}"></script>
<script src="{% static 'js/aap_settings/mail_servers_checks.js' %}"></script>

{% endblock %}
