{% extends "panels/base.html" %}
{% load i18n %}
{% load static %}
<!-- FILE: web/templates/panels/aap_settings/mail_servers.html  (–æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî 2026-01-22) -->
<!-- PURPOSE: Settings ‚Üí Mail servers: —Å–ø–∏—Å–æ–∫ —è—â–∏–∫–æ–≤ + add/edit —Ñ–æ—Ä–º–∞ (SMTP –æ–±—è–∑., IMAP –æ–ø—Ü.) + apply preset. -->
<!-- CHANGE:
- –í—ã–Ω–µ—Å–µ–Ω inline JS (secret reveal + modal) –≤ static js/aap_settings/mail_servers_secret.js
- –î–æ–±–∞–≤–ª–µ–Ω dirty-watch —Ñ–æ—Ä–º—ã: –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è".
- –î–æ–±–∞–≤–ª–µ–Ω—ã id –¥–ª—è —Ñ–æ—Ä–º—ã –∏ –±–ª–æ–∫–æ–≤ —Å–ø—Ä–∞–≤–∞ (–¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è). -->

{% block content %}

<div id="yy-secret-modal" class="fixed inset-0 hidden z-[9999]">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto mt-24 max-w-[520px]">
    <div class="YY-CARD_WHITE shadow-lg">
      <div class="YY-STATUS_YELLOW mb-4">
        {% trans "–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å?" %}
      </div>
      <div class="mb-6">
        {% trans "–ü–∞—Ä–æ–ª—å –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –Ω–∞ —ç–∫—Ä–∞–Ω–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?" %}
      </div>
      <div class="flex gap-3 justify-end">
        <button type="button" class="YY-BUTTON_MAIN" onclick="yySecretModalClose()">
          {% trans "–û—Ç–º–µ–Ω–∞" %}
        </button>
        <button type="button" class="YY-BUTTON_TAB_RED" onclick="yySecretModalConfirm()">
          {% trans "–ü–æ–∫–∞–∑–∞—Ç—å" %}
        </button>
      </div>
    </div>
  </div>
</div>

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-[60%]">
      <div class="YY-CARD_WHITE">

        {% if state == "add" or state == "edit" %}
          <form id="yyMailServerForm" method="post">
            {% csrf_token %}

            {% if state == "edit" and edit_obj %}
              <input type="hidden" name="id" value="{{ edit_obj.ui_id }}">
            {% endif %}

            {% if form.non_field_errors %}
              <div class="YY-CARD_IN_FORM_ERROR mb-3">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <div class="grid grid-cols-[2fr_2fr_1fr] gap-4 mb-7">
              <div>
                <label class="YY-LABEL">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å" %}:</label>
                {{ form.from_name }}
              </div>

              <div>
                <label class="YY-LABEL">Email:</label>
                {{ form.email }}
              </div>

              <div>
                <label class="YY-LABEL">{% trans "–õ–∏–º–∏—Ç/—á–∞—Å" %}:</label>
                {{ form.limit_hour_sent }}
              </div>
            </div>

            <div class="grid grid-cols-[1fr_2fr_auto] gap-4 mb-12">

              <div class="YY-STATUS_BLUE">
                {% trans "–ü—Ä–æ–≤–∞–π–¥–µ—Ä" %}:
              </div>

              <div>
                {{ form.preset_code }}
              </div>

              <div>
                <button
                  type="submit"
                  name="action"
                  value="apply_preset"
                  class="YY-BUTTON_MAIN !py-2"
                  formnovalidate
                >
                  OK
                </button>
              </div>
            </div>

            <div class="YY-STATUS_BLUE mb-2">
              SMTP:
            </div>

            <div class="grid grid-cols-2 gap-4 mb-2">
              <div>
                <label class="YY-LABEL">Host:</label>
                {{ form.smtp_host }}
              </div>
              <div>
                <label class="YY-LABEL">Port:</label>
                {{ form.smtp_port }}
              </div>
            </div>

            <div class="grid grid-cols-[1fr_1fr_3fr_3fr] gap-4 mb-12">
              <div>
                <label class="YY-LABEL">Security:</label>
                <div class="max-w-[220px]">
                  {{ form.smtp_security }}
                </div>
              </div>

              <div>
                <label class="YY-LABEL">Auth:</label>
                <div class="max-w-[220px]">
                  {{ form.smtp_auth_type }}
                </div>
              </div>

              <div>
                <label class="YY-LABEL">Username:</label>
                {{ form.smtp_username }}
              </div>

              <div>
                <label class="YY-LABEL">Password / Token</label>

                <div class="relative">
                  {{ form.smtp_secret }}
                  <button type="button"
                          class="absolute right-2 top-1 text-[#006991] text-xl"
                          onclick="yyTogglePasswordOrReveal('smtp', 'id_smtp_secret')">
                    üëÅÔ∏é
                  </button>
                </div>
              </div>
            </div>

            <div class="YY-STATUS_BLUE mb-2">
              IMAP:
            </div>

            <div class="grid grid-cols-2 gap-4 mb-2">
              <div>
                <label class="YY-LABEL">Host:</label>
                {{ form.imap_host }}
              </div>
              <div>
                <label class="YY-LABEL">Port:</label>
                {{ form.imap_port }}
              </div>
            </div>

            <div class="grid grid-cols-[1fr_1fr_3fr_3fr] gap-4">
              <div>
                <label class="YY-LABEL">Security:</label>
                <div class="max-w-[220px]">
                  {{ form.imap_security }}
                </div>
              </div>

              <div>
                <label class="YY-LABEL">Auth:</label>
                <div class="max-w-[220px]">
                  {{ form.imap_auth_type }}
                </div>
              </div>

              <div>
                <label class="YY-LABEL">Username:</label>
                {{ form.imap_username }}
              </div>

              <div>
                <label class="YY-LABEL">Password / Token:</label>

                <div class="relative">
                  {{ form.imap_secret }}
                  <button type="button"
                          class="absolute right-2 top-1 text-[#006991] text-xl"
                          onclick="yyTogglePasswordOrReveal('imap', 'id_imap_secret')">
                    üëÅÔ∏é
                  </button>
                </div>

              </div>
            </div>

            <div class="flex gap-3 mt-6">
              <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN">
                {% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" %}
              </button>
              <button type="submit" name="action" value="close" class="YY-BUTTON_MAIN" formnovalidate>
                {% trans "–ó–∞–∫—Ä—ã—Ç—å" %}
              </button>
            </div>

          </form>

        {% else %}
          <div class="YY-STATUS_BLUE">
            {% trans "–í–∞—à–∏ –ø–æ—á—Ç–æ–≤—ã–µ —Å–µ—Ä–≤–µ—Ä—ã:" %}
          </div>
        {% endif %}

      </div>
    </td>

    <td class="YY-MAIN_TOP_RIGHT_TD w-[40%]">
      <div class="YY-CARD_WHITE">

        {% if state == "edit" %}

          <div id="yyMailChecksDirtyHint" class="YY-STATUS_YELLOW hidden">
            {% trans "–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—á—Ç–æ–≤—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è." %}
          </div>

          <div id="yyMailChecksPanel">
            <div class="flex gap-3 flex-wrap">

              <button
                id="yyChkSmtp"
                type="button"
                class="YY-BUTTON_MAIN"
                onclick="yyMailServersCheck('check_smtp','yyChkSmtp')">
                {% trans "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SMTP" %}
              </button>

              <button
                id="yyChkImap"
                type="button"
                class="YY-BUTTON_MAIN"
                onclick="yyMailServersCheck('check_imap','yyChkImap')">
                {% trans "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å IMAP" %}
              </button>

              <button
                id="yyChkDomain"
                type="button"
                class="YY-BUTTON_MAIN"
                onclick="yyMailServersCheck('check_domain','yyChkDomain')">
                {% trans "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–º–µ–Ω" %}
              </button>

            </div>

            <div class="mt-6">
              <textarea
                id="yyMailChecksOut"
                class="YY-INPUT w-full min-h-[120px]"
                readonly></textarea>
            </div>
          </div>

        {% elif state == "add" %}
            <p class="YY-STATUS_BLUE"> {% trans "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞" %}</p>
        {% else %}
          <a href="?state=add" class="YY-BUTTON_MAIN">
            {% trans "–î–æ–±–∞–≤–∏—Ç—å –ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä" %}
          </a>
        {% endif %}

      </div>
    </td>
  </tr>
</table>

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_BOTTOM_TD">
      {% if items %}
        <div class="YY-MAIN_BOTTOM_DIV">

          <table class="w-full text-left">
            <thead>
              <tr class="YY-TH_TR">
                <th class="YY-TH_TH w-[50%]">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å" %}</th>
                <th class="YY-TH_TH w-[50%]">{% trans "Email" %}</th>
                <th class="YY-TH_TH whitespace-nowrap">{% trans "–õ–∏–º–∏—Ç/—á–∞—Å" %}</th>
                <th class="YY-TH_TH">&nbsp;</th>
                <th class="YY-TH_TH">&nbsp;</th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
                <tr class="YY-TB_TR align-top">
                  <td class="YY-TB_TD">
                    <div class="YY-STATUS_BLUE">{{ it.sender_name }}</div>
                    {% if not it.is_active %}
                      <div class="YY-STATUS_GRAY">{% trans "–í—ã–∫–ª—é—á–µ–Ω" %}</div>
                    {% endif %}
                  </td>
                  <td class="YY-TB_TD">
                    <div class="YY-STATUS_BLUE">{{ it.sender_label }}</div>
                  </td>
                  <td class="YY-TB_TD">
                    <div class="YY-STATUS_BLUE">{{ it.limit_hour_sent }}</div>
                  </td>
                  <td class="YY-TB_TD">
                    <a href="?state=edit&id={{ it.ui_id }}" class="YY-BUTTON_TAB_MAIN">
                      {% trans "–ò–∑–º–µ–Ω–∏—Ç—å" %}
                    </a>
                  </td>
                  <td class="YY-TB_TD">
                    <form method="post" onsubmit="return confirm('{% trans "–í—ã —É–≤–µ—Ä–µ–Ω—ã?" %}');">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="id" value="{{ it.ui_id }}">
                      <button type="submit" class="YY-BUTTON_TAB_RED">
                        {% trans "–£–¥–∞–ª–∏—Ç—å" %}
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

        </div>
      {% else %}
        <div class="YY-CARD_WHITE mb-10">
          {% trans "–ó–¥–µ—Å—å –ø–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö" %}
        </div>
      {% endif %}
    </td>
  </tr>
</table>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/aap_settings/mail_servers_secret.js' %}"></script>
<script src="{% static 'js/aap_settings/mail_servers_checks.js' %}"></script>
{% endblock %}
