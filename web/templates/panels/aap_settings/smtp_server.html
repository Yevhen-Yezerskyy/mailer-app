{% extends "panels/base.html" %}
{% load i18n %}
{% load static %}
<!-- FILE: web/templates/panels/aap_settings/smtp_server.html -->
<!-- DATE: 2026-01-25 -->
<!-- PURPOSE: Settings → SMTP server (отправка): UI под PU, где payload собирается строго по engine.common.mail.types. -->
<!-- CHANGE:
- Добавлен монохромный “глаз” внутри password-инпута.
- add: глаз делает только toggle password/text.
- edit: при masked — модалка → OK → reveal через /smtp/secret/.
- Подключены mail_secret_modal + mail_servers_secret.js.
- Ничего больше в структуре страницы не ломали. -->

{% block content %}

<script type="application/json" id="yyPresets">{{ presets_json|safe }}</script>

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-[65%]">
      <div class="YY-CARD_WHITE">
        <form
          id="yySmtpForm"
          method="post"
          data-api-url="{% url 'settings:mail_servers_api' %}"
          data-secret-url="{% url 'settings:mail_servers_smtp_secret' id=mailbox_ui_id %}"
          data-state="{{ state }}"
        >
          {% csrf_token %}

          <input type="hidden" name="id" value="{{ mailbox_ui_id }}">
          {{ form.auth_type }}

          <div class="YY-STATUS_BLUE mb-4">SMTP {% trans "сервер (отправка)" %}</div>

          <div class="grid grid-cols-[2fr_2fr_1fr] gap-4 mb-7">
            <div>
              <label class="YY-LABEL">{% trans "Отправитель" %}:</label>
              {{ form.sender_name }}
              {% if form.sender_name.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.sender_name.errors }}</div>{% endif %}
            </div>

            <div>
              <label class="YY-LABEL">{% trans "From Email" %}:</label>
              {{ form.email }}
              {% if form.email.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.email.errors }}</div>{% endif %}
            </div>

            <div>
              <label class="YY-LABEL">{% trans "Лимит / час" %}:</label>
              {{ form.limit_hour_sent }}
              {% if form.limit_hour_sent.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.limit_hour_sent.errors }}</div>{% endif %}
            </div>
          </div>

          <div class="flex items-center gap-2 mb-4">
            <button type="button" id="yyAuthBtnLogin" class="YY-BUTTON_TAB_MAIN !py-2 !px-3">{% trans "ЛОГИН (Стандарт)" %}</button>
            <button type="button" id="yyAuthBtnGoogle" class="YY-BUTTON_TAB_MAIN !py-2 !px-3">{% trans "Google OAuth 2.0" %}</button>
            <button type="button" id="yyAuthBtnMicrosoft" class="YY-BUTTON_TAB_MAIN !py-2 !px-3">{% trans "Microsoft OAuth 2.0" %}</button>
          </div>

          <div id="yyLoginBlock">
            <div class="YY-STATUS_GREEN mb-3">{% trans "ЛОГИН (Стандарт)" %}</div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center mb-3">
              <div class="YY-LABEL !mb-0">{% trans "Пресет" %}</div>
              <div>
                <select id="yyPresetSelect" class="YY-INPUT !px-1">
                  <option value="">{% trans "— не выбран —" %}</option>
                  {% for pid, pname in preset_choices %}
                    <option value="{{ pid }}">{{ pname }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="grid grid-cols-[2fr_3fr_1fr] gap-4 mb-3">
              <div>
                <label class="YY-LABEL">{% trans "Шифрование" %}:</label>
                {{ form.security }}
                {% if form.security.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.security.errors }}</div>{% endif %}
              </div>

              <div>
                <label class="YY-LABEL">{% trans "Сервер" %}:</label>
                {{ form.host }}
                {% if form.host.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.host.errors }}</div>{% endif %}
              </div>

              <div>
                <label class="YY-LABEL">{% trans "Порт" %}:</label>
                {{ form.port }}
                {% if form.port.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.port.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center mb-3">
              <div class="YY-LABEL !mb-0">{% trans "Логин" %}</div>
              <div>
                {{ form.username }}
                {% if form.username.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.username.errors }}</div>{% endif %}
              </div>
            </div>

            <!-- PASSWORD + EYE (inside input) -->
            <div class="grid grid-cols-[180px_1fr] gap-3 items-center">
              <div class="YY-LABEL !mb-0">{% trans "Пароль" %}</div>
              <div class="relative">
                {{ form.password }}
                <button
                  type="button"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800"
                  onclick="yyTogglePasswordOrReveal('smtp','yySecret')"
                  aria-label="password"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
                {% if form.password.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.password.errors }}</div>{% endif %}
              </div>
            </div>
          </div>

          <div id="yyOauthBlock" class="hidden">
            <div class="YY-CARD_WHITE border border-[#022a39] mt-[30px]">
              <div class="YY-STATUS_YELLOW mb-3">{% trans "OAuth 2.0" %}</div>
              <button type="button" id="yyOauthAuthorizeBtn" class="YY-BUTTON_MAIN w-full !py-4">
                {% trans "Авторизоваться" %}
              </button>
              <div class="YY-STATUS_BLUE text-sm mt-3">{% trans "Пока заглушка." %}</div>
            </div>
          </div>

          {% if form.non_field_errors %}
            <div class="YY-CARD_IN_FORM_ERROR mt-4">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="flex gap-3 mt-6">
            <div id="yySaveWrap" class="w-full">
              <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN w-full">
                {% trans "Сохранить" %}
              </button>
            </div>

            <button type="submit" name="action" value="close" class="YY-BUTTON_MAIN w-full" formnovalidate>
              {% trans "Закрыть" %}
            </button>
          </div>

        </form>
      </div>
    </td>

    <td class="YY-MAIN_TOP_RIGHT_TD w-[35%]">
      <div class="YY-CARD_WHITE">

        {% if state == "add" %}
          <div class="YY-STATUS_BLUE">{% trans "Добавление SMTP сервера" %}</div>
        {% else %}
          <div class="YY-STATUS_BLUE mb-3">{% trans "Проверка SMTP" %}</div>

          <button
            id="yyCheckSmtpBtn"
            type="button"
            class="YY-BUTTON_MAIN mb-3"
            onclick="yyMailServersCheck('check_smtp','yyCheckSmtpBtn')"
          >
            {% trans "Проверить SMTP" %}
          </button>

          <textarea
            id="yyMailChecksOut"
            class="YY-INPUT !min-h-[220px] !font-mono"
            placeholder="{% trans 'Результат проверки появится здесь' %}"
          ></textarea>

          <div class="YY-STATUS_BLUE text-sm mt-3">
            {% trans "Последняя проверка:" %} {{ last_smtp_status|default:"—" }}
          </div>

          {% if last_smtp_payload %}
            <pre class="mt-2 p-2 bg-gray-50 border rounded text-xs overflow-auto max-h-[240px]">{{ last_smtp_payload }}</pre>
          {% else %}
            <div class="YY-STATUS_YELLOW text-sm mt-2">{% trans "Не проверено" %}</div>
          {% endif %}
        {% endif %}

      </div>
    </td>
  </tr>
</table>

{% include "panels/aap_settings/partials/mail_secret_modal.html" %}

<script src="{% static 'js/aap_settings/smtp_server.js' %}"></script>
<script src="{% static 'js/aap_settings/mail_servers_checks.js' %}"></script>
<script src="{% static 'js/aap_settings/mail_servers_secret.js' %}"></script>

<script>
  // Приводим password к контракту JS: id=yySecret + место под кнопку справа
  (function () {
    const el = document.querySelector('input[name="password"]');
    if (!el) return;
    el.id = "yySecret";
    // резервируем место под кнопку глаза
    try { el.style.paddingRight = "2.75rem"; } catch (e) {}
  })();
</script>

{% endblock %}
