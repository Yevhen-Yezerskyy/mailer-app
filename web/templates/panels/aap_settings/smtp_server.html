{% extends "panels/base.html" %}
{% load i18n %}
{% load static %}
<!-- FILE: web/templates/panels/aap_settings/smtp_server.html  (обновлено — 2026-01-24) -->
<!-- PURPOSE: Settings → SMTP server: отдельная страница настройки SMTP (LOGIN + OAuth2-заглушки) + пресеты + проверка. -->

{% block content %}

<script type="application/json" id="yyPresets">{{ presets_json|safe }}</script>

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-[60%]">
      <div class="YY-CARD_WHITE">

        {% if form.non_field_errors %}
          <div class="YY-CARD_IN_FORM_ERROR mb-3">{{ form.non_field_errors }}</div>
        {% endif %}

        <form id="yyMailServerForm" method="post" data-api-url="{% url 'settings:mail_servers_api' %}">
          {% csrf_token %}
          <input type="hidden" name="id" value="{{ mailbox_ui_id }}">
          {{ form.auth_type }}

          <div class="flex items-center justify-between gap-3 mb-4">
            <div class="YY-STATUS_BLUE">SMTP — {{ mailbox.email }}</div>

            <div class="flex items-center gap-2">
              <div id="yySaveWrap">
                <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN">
                  {% trans "Сохранить" %}
                </button>
              </div>

              <button type="submit" name="action" value="close" class="YY-BUTTON_TAB_MAIN">
                {% trans "Закрыть" %}
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-4 mb-5">
            <div class="grid grid-cols-[180px_1fr] gap-3 items-center">
              <div class="YY-LABEL !mb-0">{% trans "Отправитель" %}</div>
              <div>
                {{ form.sender_name }}
                {% if form.sender_name.errors %}
                  <div class="YY-FORM_ERROR mt-1">{{ form.sender_name.errors }}</div>
                {% endif %}
              </div>
            </div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center">
              <div class="YY-LABEL !mb-0">{% trans "Email" %}</div>
              <div class="YY-STATUS_BLUE text-sm">{{ mailbox.email }}</div>
            </div>

            <div class="grid grid-cols-[180px_1fr] gap-3 items-center">
              <div class="YY-LABEL !mb-0">{% trans "Лимит/час" %}</div>
              <div>
                {{ form.limit_hour_sent }}
                {% if form.limit_hour_sent.errors %}
                  <div class="YY-FORM_ERROR mt-1">{{ form.limit_hour_sent.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="YY-STATUS_BLUE mb-2">{% trans "Авторизация" %}</div>

          <div class="flex items-center gap-2 mb-4">
            <button type="button" id="yyAuthBtnLogin" class="YY-BUTTON_TAB_MAIN !py-2 !px-3">{% trans "ЛОГИН" %}</button>
            <button type="button" id="yyAuthBtnGoogle" class="YY-BUTTON_TAB_MAIN !py-2 !px-3">{% trans "Google авторизация (OAuth 2.0)" %}</button>
            <button type="button" id="yyAuthBtnMicrosoft" class="YY-BUTTON_TAB_MAIN !py-2 !px-3">{% trans "Microsoft авторизация (OAuth 2.0)" %}</button>
          </div>

          <div id="yyLoginBlock">
            <div class="YY-CARD_WHITE border border-[#022a39] mt-[30px]">
              <div class="YY-STATUS_BLUE mb-3">{% trans "SMTP (LOGIN)" %}</div>

              <div class="grid grid-cols-[180px_1fr] gap-3 items-center mb-3">
                <div class="YY-LABEL !mb-0">{% trans "Пресет" %}</div>
                <div>
                  {{ form.preset_code }}
                </div>
              </div>

              <div class="grid grid-cols-[180px_1fr] gap-3 items-center mb-3">
                <div class="YY-LABEL !mb-0">Host</div>
                <div>
                  {{ form.host }}
                  {% if form.host.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.host.errors }}</div>{% endif %}
                </div>
              </div>

              <div class="grid grid-cols-[180px_1fr] gap-3 items-center mb-3">
                <div class="YY-LABEL !mb-0">Port</div>
                <div class="flex items-center gap-3">
                  {{ form.port }}
                  <div class="w-[220px]">
                    {{ form.security }}
                  </div>
                </div>
                {% if form.port.errors %}<div></div><div class="YY-FORM_ERROR -mt-2">{{ form.port.errors }}</div>{% endif %}
              </div>

              <div class="grid grid-cols-[180px_1fr] gap-3 items-center mb-3">
                <div class="YY-LABEL !mb-0">{% trans "Логин" %}</div>
                <div>
                  {{ form.username }}
                  {% if form.username.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.username.errors }}</div>{% endif %}
                </div>
              </div>

              <div class="grid grid-cols-[180px_1fr] gap-3 items-center">
                <div class="YY-LABEL !mb-0">{% trans "Пароль" %}</div>
                <div>
                  {{ form.password }}
                  {% if form.password.errors %}<div class="YY-FORM_ERROR mt-1">{{ form.password.errors }}</div>{% endif %}
                </div>
              </div>
            </div>
          </div>

          <div id="yyOauthBlock" class="hidden">
            <div class="YY-CARD_WHITE border border-[#022a39] mt-[30px]">
              <div class="YY-STATUS_YELLOW mb-3">{% trans "OAuth 2.0" %}</div>
              <button type="button" id="yyOauthAuthorizeBtn" class="YY-BUTTON_MAIN w-full !py-4">
                {% trans "Авторизоваться" %}
              </button>
              <div class="YY-STATUS_BLUE text-sm mt-3">{% trans "Пока не работает (заглушка)." %}</div>
            </div>
          </div>

        </form>

      </div>
    </td>

    <td class="YY-MAIN_TOP_RIGHT_TD w-[40%]">
      <div class="YY-CARD_WHITE">

        {% if state == "add" %}
          <div class="YY-STATUS_BLUE">{% trans "Добавление SMTP сервера" %}</div>
        {% else %}
          <div class="YY-STATUS_BLUE mb-3">{% trans "Проверка SMTP" %}</div>

          <button
            id="yyCheckSmtpBtn"
            type="button"
            class="YY-BUTTON_MAIN mb-3"
            onclick="yyMailServersCheck('check_smtp','yyCheckSmtpBtn')"
          >
            {% trans "Проверить SMTP" %}
          </button>

          <textarea
            id="yyMailChecksOut"
            class="YY-INPUT !min-h-[220px] !font-mono"
            placeholder="{% trans 'Результат проверки появится здесь' %}"
          ></textarea>

          <div class="YY-STATUS_BLUE text-sm mt-3">
            {% trans "Последняя проверка:" %} {{ last_smtp_status|default:"—" }}
          </div>

          {% if last_smtp_payload %}
            <pre class="mt-2 p-2 bg-gray-50 border rounded text-xs overflow-auto max-h-[240px]">{{ last_smtp_payload }}</pre>
          {% else %}
            <div class="YY-STATUS_YELLOW text-sm mt-2">{% trans "Не проверено" %}</div>
          {% endif %}
        {% endif %}

      </div>
    </td>
  </tr>
</table>

<script src="{% static 'js/aap_settings/smtp_server.js' %}"></script>
<script src="{% static 'js/aap_settings/mail_servers_checks.js' %}"></script>

{% endblock %}
