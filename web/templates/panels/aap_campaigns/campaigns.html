<!-- FILE: web/templates/panels/aap_campaigns/campaigns.html -->
<!-- DATE: 2026-01-19 -->
<!-- PURPOSE:
  Кампании — единая страница.
  A: спокойное состояние + кнопка добавления
  B: add/edit кампании (форма)
  C: редактор письма
  D: нижняя таблица кампаний
-->

{% extends "panels/base.html" %}
{% load i18n %}

{% block content %}

{# ==================== A. СПОКОЙНОЕ СОСТОЯНИЕ ==================== #}

{% if not state %}
<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-[70%]">
      <div class="YY-CARD_WHITE">
        <div class="YY-STATUS_BLUE">
          {% trans "Ваши кампании:" %}
        </div>
      </div>
    </td>

    <td class="YY-MAIN_TOP_RIGHT_TD w-[30%]">
      <div class="YY-CARD_WHITE">
        <a href="?state=add" class="YY-BUTTON_MAIN w-full mb-2">
          {% trans "Добавить кампанию" %}
        </a>
      </div>
    </td>
  </tr>
</table>
{% endif %}

{# ==================== B. ADD / EDIT КАМПАНИИ ==================== #}

{% if state == "add" or state == "edit" %}

<form method="post" id="yyCampaignForm">
  {% csrf_token %}
  {% if edit_obj %}
    <input type="hidden" name="id" value="{{ edit_obj.ui_id }}">
  {% endif %}

  <table class="YY-MAIN_TABLE">
    <tr>
      <!-- LEFT 50% -->
      <td class="YY-MAIN_TOP_LEFT_TD w-[50%] align-top">
        <div class="YY-CARD_WHITE">

          <label class="YY-LABEL">{% trans "Название кампании" %}</label>
          <input type="text" name="title" class="YY-INPUT mb-3"
                 value="{{ edit_obj.title|default:'' }}">

          <label class="YY-LABEL">{% trans "Список рассылки" %}</label>
          <select name="mailing_list" class="YY-INPUT mb-3">
            <option value="">{% trans "— не выбран —" %}</option>
            {% for it in list_items %}
              <option value="{{ it.ui_id }}"
                {% if edit_obj and edit_obj.mailing_list_id == it.id %}selected{% endif %}>
                {{ it.title }}
              </option>
            {% endfor %}
          </select>

          <label class="YY-LABEL">{% trans "Mailbox" %}</label>
          <select name="mailbox" class="YY-INPUT mb-3">
            <option value="">{% trans "— не выбран —" %}</option>
            {% for it in mb_items %}
              <option value="{{ it.ui_id }}"
                {% if edit_obj and edit_obj.mailbox_id == it.id %}selected{% endif %}>
                {{ it.name }} &lt;{{ it.email }}&gt;
              </option>
            {% endfor %}
          </select>

          <label class="YY-LABEL">{% trans "Шаблон письма" %}</label>
          <select name="template" class="YY-INPUT mb-4">
            <option value="">{% trans "— не выбран —" %}</option>
            {% for it in tpl_items %}
              <option value="{{ it.ui_id }}"
                {% if edit_obj and edit_obj.letter and edit_obj.letter.template_id == it.id %}selected{% endif %}>
                {{ it.template_name }}
              </option>
            {% endfor %}
          </select>

<div class="flex items-center gap-4 mb-4">
  <div class="YY-STATUS_BLUE !py-1 w-[250px] mr-4">{% trans "Дата начала кампании" %}:</div>

  <input type="number" inputmode="numeric" name="start_dd" maxlength="2"
         class="YY-DATE-INPUT w-[3.3rem] pl-2"
         placeholder="DD"
         value="{% if edit_obj and edit_obj.start_at %}{{ edit_obj.start_at|date:'d' }}{% endif %}">

  <input type="number" inputmode="numeric" name="start_mm" maxlength="2"
         class="YY-DATE-INPUT w-[3.3rem] pl-2"
         placeholder="MM"
         value="{% if edit_obj and edit_obj.start_at %}{{ edit_obj.start_at|date:'m' }}{% endif %}">

  <input type="number" inputmode="numeric" name="start_yy" maxlength="4"
         class="YY-DATE-INPUT w-[4.7rem] pl-2"
         placeholder="YYYY"
         value="{% if edit_obj and edit_obj.start_at %}{{ edit_obj.start_at|date:'Y' }}{% endif %}">
</div>

<div class="flex items-center gap-4 mb-4">
  <div class="YY-STATUS_BLUE !py-1 w-[250px] mr-4">{% trans "Дата конца компании" %}:</div>

  <input type="number" inputmode="numeric" name="end_dd" maxlength="2"
         class="YY-DATE-INPUT w-[3.3rem] pl-2"
         placeholder="DD"
         value="{% if edit_obj and edit_obj.end_at %}{{ edit_obj.end_at|date:'d' }}{% endif %}">

  <input type="number" inputmode="numeric" name="end_mm" maxlength="2"
         class="YY-DATE-INPUT w-[3.3rem] pl-2"
         placeholder="MM"
         value="{% if edit_obj and edit_obj.end_at %}{{ edit_obj.end_at|date:'m' }}{% endif %}">

  <input type="number" inputmode="numeric" name="end_yy" maxlength="4"
         class="YY-DATE-INPUT w-[4.7rem] pl-2"
         placeholder="YYYY"
         value="{% if edit_obj and edit_obj.end_at %}{{ edit_obj.end_at|date:'Y' }}{% endif %}">
</div>


          {% if state == "edit" and edit_obj and edit_obj.campaign_parent %}
            <div class="YY-TEXT mb-1">
              {% trans "Следуем за кампанией" %}: <strong>{{ edit_obj.campaign_parent.title }}</strong>
            </div>
            <label class="YY-LABEL">{% trans "Отправлять письма через (дней)" %}</label>
            <input type="number" name="send_after_parent_days"
                   class="YY-INPUT"
                   value="{{ edit_obj.send_after_parent_days }}">
          {% endif %}

        </div>
        <div class="YY-CARD_WHITE mt-2">
          <div class="flex gap-2">
            {% if state == "add" %}
              <button type="submit" name="action" value="add_campaign" class="YY-BUTTON_MAIN w-full">
                {% trans "Добавить" %}
              </button>
            {% else %}
              <button type="submit" name="action" value="save_campaign" class="YY-BUTTON_MAIN w-full">
                {% trans "Сохранить изменения" %}
              </button>
            {% endif %}
            <button type="submit" name="action" value="close" formnovalidate class="YY-BUTTON_MAIN w-full">
              {% trans "Закрыть" %}
            </button>
          </div>
        </div>
      </td>

      <!-- RIGHT 50% -->
      <td class="YY-MAIN_TOP_RIGHT_TD w-[50%] align-top">
        <div class="YY-CARD_WHITE">

          <label class="YY-TEXT flex items-center gap-2 mb-3">
            <input type="checkbox" id="yyUseGlobalWindow" name="use_global_window"
                   {% if not edit_obj or not edit_obj.window %}checked{% endif %}>
            {% trans "Использовать глобальные настройки окна отправки" %}
          </label>

          <textarea id="yyGlobalWindowJson" class="hidden">{{ global_window_json_str }}</textarea>
          <textarea name="window" id="yyValueJson" class="hidden">{{ edit_window_json_str }}</textarea>

          <div id="yyWindowBox">
            
            <table class="w-full text-left">
              <tbody id="yySendingBody">
                <tr data-yy-day="mon" class="border-b border-t border-[#71d0f4]">
                  <td class="align-top px-2 py-2 w-[35%]">
                    <div class="YY-STATUS_GREEN !py-1">{% trans "Понедельник" %}</div>
                  </td>
                  <td class="align-top px-2 py-2 w-[65%]"><div class="yy-day-windows"></div></td>
                </tr>
                <tr data-yy-day="tue" class="border-b border-[#71d0f4]">
                  <td class="align-top px-2 py-2">
                    <div class="YY-STATUS_GREEN !py-1">{% trans "Вторник" %}</div>
                  </td>
                  <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                </tr>

                <tr data-yy-day="wed" class="border-b border-[#71d0f4]">
                  <td class="align-top px-2 py-2">
                    <div class="YY-STATUS_GREEN !py-1">{% trans "Среда" %}</div>
                  </td>
                  <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                </tr>

                <tr data-yy-day="thu" class="border-b border-[#71d0f4]">
                  <td class="align-top px-2 py-2">
                    <div class="YY-STATUS_GREEN !py-1">{% trans "Четверг" %}</div>
                  </td>
                  <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                </tr>

                <tr data-yy-day="fri" class="border-b border-[#71d0f4]">
                  <td class="align-top px-2 py-2">
                    <div class="YY-STATUS_GREEN !py-1">{% trans "Пятница" %}</div>
                  </td>
                  <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                </tr>
                <tr data-yy-day="sat" class="border-b border-[#71d0f4]">
                  <td class="align-top px-2 py-2">
                    <div class="YY-STATUS_YELLOW !py-1">{% trans "Суббота" %}</div>
                  </td>
                  <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                </tr>
                <tr data-yy-day="sun" class="border-b border-[#71d0f4]">
                  <td class="align-top px-2 py-2">
                    <div class="YY-STATUS_YELLOW !py-1">{% trans "Воскресенье" %}</div>
                  </td>
                  <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                </tr>
                <tr data-yy-day="hol" class="border-b border-[#71d0f4]">
                  <td class="align-top px-2 py-2">
                    <div class="YY-STATUS_RED !py-1">{% trans "Праздники" %}</div>
                  </td>
                  <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                </tr>              
              </tbody>
            </table>


          </div>
        </div>
      </td>
    </tr>
  </table>
</form>

{% endif %}


{# ==================== C. РЕДАКТОР ПИСЬМА ==================== #}
{% if state == "letter" %}
  {{ block.super }}
{% endif %}

{# ==================== D. НИЖНЯЯ ТАБЛИЦА ==================== #}
{% if items %}
  <div class="YY-CARD_WHITE mt-10">
    <table class="w-full text-left">
      <tbody>
        {% for it in items %}
          <tr class="YY-TB_TR">
            <td class="YY-TB_TD"><div class="YY-STATUS_BLUE">{{ it.title }}</div></td>
            <td class="YY-TB_TD"><a href="?state=edit&id={{ it.ui_id }}" class="YY-BUTTON_TAB_MAIN">{% trans "Изменить" %}</a></td>
            <td class="YY-TB_TD"><a href="?state=letter&id={{ it.ui_id }}" class="YY-BUTTON_TAB_MAIN">{% trans "Письмо" %}</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  {% if state == "add" or state == "edit" %}
    <script src="/static/js/aap_settings/sending_campaign.js"></script>
  {% endif %}
{% endblock %}