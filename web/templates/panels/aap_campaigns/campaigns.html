<!-- FILE: web/templates/panels/aap_campaigns/campaigns.html -->
<!-- DATE: 2026-01-19 -->
<!-- PURPOSE:
  Кампании — единая страница.
  A: спокойное состояние + кнопка добавления
  B: add/edit кампании (форма)
  C: редактор письма
  D: нижняя таблица кампаний
-->

{% extends "panels/base.html" %}
{% load i18n %}

{% block content %}

{# ==================== A. СПОКОЙНОЕ СОСТОЯНИЕ ==================== #}

{% if not state %}
  <table class="YY-MAIN_TABLE">
    <tr>
      <td class="YY-MAIN_TOP_LEFT_TD w-[70%]">
        <div class="YY-CARD_WHITE">
          <div class="YY-STATUS_BLUE">
            {% trans "Ваши кампании:" %}
          </div>
        </div>
      </td>

      <td class="YY-MAIN_TOP_RIGHT_TD w-[30%]">
        <div class="YY-CARD_WHITE">
          <a href="?state=add" class="YY-BUTTON_MAIN w-full mb-2">
            {% trans "Добавить кампанию" %}
          </a>
        </div>
      </td>
    </tr>
  </table>
{% endif %}

{# ==================== B. ADD / EDIT КАМПАНИИ ==================== #}

{% if state == "add" or state == "edit" %}

  <form method="post" id="yyCampaignForm">
    {% csrf_token %}
    {% if edit_obj %}
      <input type="hidden" name="id" value="{{ edit_obj.ui_id }}">
    {% endif %}

    <table class="YY-MAIN_TABLE">
      <tr>
        <!-- LEFT 50% -->
        <td class="YY-MAIN_TOP_LEFT_TD w-[50%] align-top">
          <div class="YY-CARD_WHITE">

            <label class="YY-LABEL">{% trans "Название кампании" %}:</label>
            <input type="text" name="title" class="YY-INPUT mb-3" value="{{ edit_obj.title|default:'' }}">

            <label class="YY-LABEL">{% trans "Список рассылки" %}:</label>
            {% if form_error_msg %}
              <div class="YY-STATUS_RED mb-3 !py-1">{{ form_error_msg }}</div>
            {% endif %}
            <select name="mailing_list" class="YY-INPUT mb-3 {% if form_error_field == 'mailing_list' %}!border-red-500{% endif %}">
              <option value="">{% trans "— не выбран —" %}</option>
              {% for it in list_items %}
                <option value="{{ it.ui_id }}"
                  {% if edit_obj and edit_obj.mailing_list_id == it.id %}selected{% endif %}>
                  {{ it.title }}
                </option>
              {% endfor %}
            </select>

          <label class="YY-LABEL">{% trans "Отправка" %}:</label>
          <select name="mailbox" class="YY-INPUT mb-3">
            <option value="">{% trans "— не выбрано —" %}</option>
            {% for it in mb_items %}
              <option value="{{ it.ui_id }}"
                {% if edit_obj and edit_obj.mailbox_id == it.id %}selected{% endif %}>
                {{ it.sender_label }}
              </option>
            {% endfor %}
          </select>

            <label class="YY-LABEL">{% trans "Шаблон письма" %}:</label>
            <select name="template" class="YY-INPUT mb-4">
              <option value="">{% trans "— не выбран —" %}</option>

              {% for it in tpl_items %}
                <option value="{{ it.ui_id }}"
                  {% if edit_obj and edit_obj.letter and edit_obj.letter.template_id == it.id %}selected{% endif %}>
                  {{ it.template_name }}
                </option>
              {% endfor %}
            </select>

            <div class="flex items-center gap-4 mb-4">
              <div class="YY-STATUS_BLUE !py-1 w-[250px] mr-4">{% trans "Дата начала кампании" %}:</div>

              <input type="number" inputmode="numeric" name="start_dd" maxlength="2"
                     class="YY-DATE-INPUT w-[3.3rem] pl-2"
                     placeholder="DD"
                     value="{% if edit_obj and edit_obj.start_at %}{{ edit_obj.start_at|date:'d' }}{% endif %}">

              <input type="number" inputmode="numeric" name="start_mm" maxlength="2"
                     class="YY-DATE-INPUT w-[3.3rem] pl-2"
                     placeholder="MM"
                     value="{% if edit_obj and edit_obj.start_at %}{{ edit_obj.start_at|date:'m' }}{% endif %}">

              <input type="number" inputmode="numeric" name="start_yy" maxlength="4"
                     class="YY-DATE-INPUT w-[4.7rem] pl-2"
                     placeholder="YYYY"
                     value="{% if edit_obj and edit_obj.start_at %}{{ edit_obj.start_at|date:'Y' }}{% endif %}">
            </div>

            <div class="flex items-center gap-4 mb-4">
              <div class="YY-STATUS_BLUE !py-1 w-[250px] mr-4">{% trans "Дата конца компании" %}:</div>

              <input type="number" inputmode="numeric" name="end_dd" maxlength="2"
                     class="YY-DATE-INPUT w-[3.3rem] pl-2"
                     placeholder="DD"
                     value="{% if edit_obj and edit_obj.end_at %}{{ edit_obj.end_at|date:'d' }}{% endif %}">

              <input type="number" inputmode="numeric" name="end_mm" maxlength="2"
                     class="YY-DATE-INPUT w-[3.3rem] pl-2"
                     placeholder="MM"
                     value="{% if edit_obj and edit_obj.end_at %}{{ edit_obj.end_at|date:'m' }}{% endif %}">

              <input type="number" inputmode="numeric" name="end_yy" maxlength="4"
                     class="YY-DATE-INPUT w-[4.7rem] pl-2"
                     placeholder="YYYY"
                     value="{% if edit_obj and edit_obj.end_at %}{{ edit_obj.end_at|date:'Y' }}{% endif %}">
            </div>

            {% if state == "edit" and edit_obj and edit_obj.campaign_parent %}
              <div class="YY-TEXT mb-1">
                {% trans "Следуем за кампанией" %}: <strong>{{ edit_obj.campaign_parent.title }}</strong>
              </div>
              <label class="YY-LABEL">{% trans "Отправлять письма через (дней)" %}</label>
              <input type="number" name="send_after_parent_days"
                     class="YY-INPUT"
                     value="{{ edit_obj.send_after_parent_days }}">
            {% endif %}

          </div>

          <div class="YY-CARD_WHITE mt-2">
            <div class="flex gap-2">
              {% if state == "add" %}
                <button type="submit" name="action" value="add_campaign" class="YY-BUTTON_MAIN w-full">
                  {% trans "Добавить" %}
                </button>
              {% else %}
                <button type="submit" name="action" value="save_campaign" class="YY-BUTTON_MAIN w-full">
                  {% trans "Сохранить изменения" %}
                </button>
                <a href="?state=letter&id={{ edit_obj.ui_id }}"
                  class="YY-BUTTON_MAIN w-full text-center">
                    {% trans "Изменить письмо" %}
                </a>
              {% endif %}
              <button type="submit" name="action" value="close" formnovalidate class="YY-BUTTON_MAIN w-full">
                {% trans "Закрыть" %}
              </button>
            </div>
          </div>
        </td>

        <!-- RIGHT 50% -->
        <td class="YY-MAIN_TOP_RIGHT_TD w-[50%] align-top">
          <div class="YY-CARD_WHITE">

            <label class="YY-TEXT flex items-center gap-2 mb-3">
              <input type="checkbox" id="yyUseGlobalWindow" name="use_global_window"
                     {% if not edit_obj or not edit_obj.window %}checked{% endif %}>
              {% trans "Использовать глобальные настройки окна отправки" %}
            </label>

            <textarea id="yyGlobalWindowJson" class="hidden">{{ global_window_json_str }}</textarea>
            <textarea name="window" id="yyValueJson" class="hidden">{{ edit_window_json_str }}</textarea>

            <div id="yyWindowBox">
              <table class="w-full text-left">
                <tbody id="yySendingBody">
                  <tr data-yy-day="mon" class="border-b border-t border-[#71d0f4]">
                    <td class="align-top px-2 py-2 w-[35%]">
                      <div class="YY-STATUS_GREEN !py-1">{% trans "Понедельник" %}</div>
                    </td>
                    <td class="align-top px-2 py-2 w-[65%]"><div class="yy-day-windows"></div></td>
                  </tr>

                  <tr data-yy-day="tue" class="border-b border-[#71d0f4]">
                    <td class="align-top px-2 py-2">
                      <div class="YY-STATUS_GREEN !py-1">{% trans "Вторник" %}</div>
                    </td>
                    <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                  </tr>

                  <tr data-yy-day="wed" class="border-b border-[#71d0f4]">
                    <td class="align-top px-2 py-2">
                      <div class="YY-STATUS_GREEN !py-1">{% trans "Среда" %}</div>
                    </td>
                    <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                  </tr>

                  <tr data-yy-day="thu" class="border-b border-[#71d0f4]">
                    <td class="align-top px-2 py-2">
                      <div class="YY-STATUS_GREEN !py-1">{% trans "Четверг" %}</div>
                    </td>
                    <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                  </tr>

                  <tr data-yy-day="fri" class="border-b border-[#71d0f4]">
                    <td class="align-top px-2 py-2">
                      <div class="YY-STATUS_GREEN !py-1">{% trans "Пятница" %}</div>
                    </td>
                    <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                  </tr>

                  <tr data-yy-day="sat" class="border-b border-[#71d0f4]">
                    <td class="align-top px-2 py-2">
                      <div class="YY-STATUS_YELLOW !py-1">{% trans "Суббота" %}</div>
                    </td>
                    <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                  </tr>

                  <tr data-yy-day="sun" class="border-b border-[#71d0f4]">
                    <td class="align-top px-2 py-2">
                      <div class="YY-STATUS_YELLOW !py-1">{% trans "Воскресенье" %}</div>
                    </td>
                    <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                  </tr>

                  <tr data-yy-day="hol" class="border-b border-[#71d0f4]">
                    <td class="align-top px-2 py-2">
                      <div class="YY-STATUS_RED !py-1">{% trans "Праздники" %}</div>
                    </td>
                    <td class="align-top px-2 py-2"><div class="yy-day-windows"></div></td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </td>
      </tr>
    </table>
  </form>

{% endif %}

{# ==================== C. РЕДАКТОР ПИСЬМА ==================== #}

{% if state == "letter" and edit_obj %}

  <form method="post" id="yySendingForm">
    {% csrf_token %}

    <input type="hidden" id="yyCampaignId" value="{{ edit_obj.ui_id }}">
    <input type="hidden" name="editor_mode" id="yyEditorMode" value="user">
    <input type="hidden" name="editor_html" id="yyEditorHtml">
    <input type="hidden" name="subjects_json" id="yySubjectsJson">

    {# FIX: submit.js теперь ожидает headers_json; без него оно не вешает обработчик и "Сохранить" выглядит сломанным #}
    <input type="hidden" name="headers_json" id="yyHeadersJson">

    <textarea id="yyInitHtml" class="hidden">{{ letter_init_html }}</textarea>
    <textarea id="yyInitCss" class="hidden">{{ letter_init_css }}</textarea>
    <textarea id="yyInitSubjects" class="hidden">{{ letter_init_subjects }}</textarea>

    {# FIX: initial headers для правого JSON редактора/submit.js #}
    <textarea id="yyInitHeaders" class="hidden">{{ letter_init_headers }}</textarea>

    <textarea id="yyTemplateHtml" class="hidden">{{ letter_template_html }}</textarea>

    <table class="YY-MAIN_TABLE">
      <tr>
        <td class="YY-MAIN_TOP_LEFT_TD w-[60%]">
          <div class="YY-CARD_WHITE">

            <div id="yyUserModeLeft">
              <textarea id="yyTinyEditor"
                        class="border border-[#cbcbcb] bg-white w-full"
                        style="height:800px;"
                        spellcheck="false"></textarea>
            </div>

            <div id="yyAdvancedModeLeft" class="hidden">
              <textarea id="yyAdvHtml"
                        style="height:900px;"
                        spellcheck="false"></textarea>
            </div>

          </div>
        </td>

        <td class="YY-MAIN_TOP_RIGHT_TD w-[40%]">
          <div class="YY-CARD_WHITE">

            <!-- USER MODE -->
            <div id="yyUserModeRight">
              <div class="grid grid-cols-2 gap-3 mb-10">
                <button type="button" class="YY-BUTTON_MAIN" onclick="yyCampSwitchToAdvanced()">
                  {% trans "Экспертный режим" %}
                </button>
                <button type="button" class="YY-BUTTON_MAIN" onclick="yyCampPreviewCurrent()">
                  {% trans "Предпросмотр" %}
                </button>
              </div>
            </div>
            <!-- ADVANCED MODE -->
            <div id="yyAdvancedModeRight" class="hidden mb-6">
              <div class="grid grid-cols-2 gap-3 mb-5">
                <button type="button" class="YY-BUTTON_MAIN" onclick="yyCampSwitchToUser()">
                  {% trans "Визуальный режим" %}
                </button>
                <button type="button" class="YY-BUTTON_MAIN" onclick="yyCampPreviewCurrent()">
                  {% trans "Предпросмотр" %}
                </button>
              </div>

              <label class="YY-LABEL">
                {% trans "Дополнительные заголовки JSON" %}
              </label>
              <textarea id="yyHeadersJsonArea" spellcheck="false" style="height:240px;"></textarea>
            </div>

            <div class="mb-10">
              <label class="YY-LABEL">{% trans "Тема письма 1 (ротация)" %}:</label>
              <input type="text" id="yySubject1" class="YY-INPUT">

              <label class="YY-LABEL">{% trans "Тема письма 2 (ротация)" %}:</label>
              <input type="text" id="yySubject2" class="YY-INPUT">

              <label class="YY-LABEL">{% trans "Тема письма 3 (ротация)" %}:</label>
              <input type="text" id="yySubject3" class="YY-INPUT">
            </div>


            <!-- ACTIONS -->
            <div class="grid grid-cols-2 gap-3 mt-5">
              <button type="submit" name="action" value="save_letter" class="YY-BUTTON_MAIN">
                {% trans "Сохранить" %}
              </button>
              <button type="submit" name="action" value="close" class="YY-BUTTON_MAIN" formnovalidate>
                {% trans "Закрыть" %}
              </button>
            </div>
          </form>
          </div>
          
{% if has_letter %}          
<div class="YY-CARD_WHITE  mt-10">
  <form method="post" class="grid grid-cols-1 gap-2">
    {% csrf_token %}
    <input type="hidden" name="action" value="send_test">
    <input type="hidden" name="id" value="{{ edit_obj.ui_id }}">

    <label class="YY-LABEL">{% trans "Отправить тестовое письмо по адресу:" %}:</label>
    <input type="email" name="test_email" class="YY-INPUT !mb-1" placeholder="test@example.com" required>
    <button type="submit" class="YY-BUTTON_MAIN mb-2">
      {% trans "Отправить тестовое письмо" %}
    </button>
  </form>
</div>
{% endif %}


        </td>
      </tr>
    </table>
  

{% endif %}

{# ==================== D. НИЖНЯЯ ТАБЛИЦА ==================== #}

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_BOTTOM_TD">
      {% if items %}
        <div class="YY-MAIN_BOTTOM_DIV">
          <table class="w-full text-left">
            <thead>
              <tr class="YY-TH_TR">
                <th class="YY-TH_TH w-[100%]">{% trans "Кампания" %}</th>
                <th class="YY-TH_TH">{% trans "Письмо" %}</th>
                <th class="YY-TH_TH">{% trans "Статус" %}</th>
                <th class="YY-TH_TH">{% trans "Состояние" %}</th>
                <th class="YY-TH_TH">&nbsp;</th>
              </tr>
            </thead>

            <tbody>
              {% for it in items %}
                <tr class="YY-TB_TR align-top">
                  <td class="YY-TB_TD">
                    <p class="font-semibold">{{ it.title }}</p>
                    <p class="mb-4">{% trans "Активна с" %} {{ it.start_at|date:"d.m.Y" }} 
                      {% if it.end_at %}
                        {% trans "по" %} {{ it.end_at|date:"d.m.Y" }}
                      {% endif %}</p>
                      <div class="grid grid-cols-[150px_1fr] gap-x-2 gap-y-1">
                          <div class="font-semibold">{% trans "Список рассылки" %}:</div> <div>{{ it.mailing_list.title }}</div>
                          <div class="font-semibold">{% trans "Отправка" %}:</div><div>{{ it.sender_label }}</div>
                          <div class="font-semibold">{% trans "Шаблон письма:" %}:</div><div>{{ it.letter_tpl_label }}</div>
                      </div>
                  </td>
                  <td class="YY-TB_TD">
                    <button type="button" class="YY-BUTTON_TAB_MAIN mb-2" onclick="yyCampPreviewById('{{ it.ui_id }}')">
                      {% trans "Предпросмотр" %}
                    </button>
                    <a href="?state=letter&id={{ it.ui_id }}" class="YY-BUTTON_TAB_MAIN whitespace-nowrap">
                      {% trans "Изменить письмо" %}
                    </a>
                  </td>

     
                  <td class="YY-TB_TD">
                    <div class="grid grid-cols-[250px_1fr] gap-x-2 gap-y-2">
                      <div class="YY-STATUS_BLUE !py-1 !px-2">{% trans "Писем к отправке" %}:</div>
                      <div class="YY-STATUS_BLUE !py-1 !px-2">{{ it.stat_total }}</div>

                      <div class="YY-STATUS_GREEN !py-1 !px-2">{% trans "Отправлено" %}:</div>
                      <div class="YY-STATUS_GREEN !py-1 !px-2">{{ it.stat_sent }}</div>

                      <div class="YY-STATUS_YELLOW !py-1 !px-2">{% trans "Осталось" %}:</div>
                      <div class="YY-STATUS_YELLOW !py-1 !px-2">{{ it.stat_left }}</div>
                    </div>
                  </td>


                  <td class="YY-TB_TD">
                    {% if it.active %}
                      <div class="YY-STATUS_GREEN mb-2 !py-1">{% trans "Кампания включена" %}</div>
                      {% if it.is_in_window %}
                        <div class="YY-STATUS_GREEN !py-1 mb-2">{% trans "Идет рассылка" %}</div>
                      {% else %}
                        <div class="YY-STATUS_YELLOW !py-1 mb-2">{% trans "Ждем окно отправки" %}</div>
                      {% endif %}
                      <form method="post" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="pause">
                        <input type="hidden" name="id" value="{{ it.ui_id }}">
                        <button type="submit" class="YY-BUTTON_TAB_RED">
                          {% trans "Отключить" %}
                        </button>
                      </form>
                    {% else %}
                      <div class="YY-STATUS_GRAY mb-2 !py-1">{% trans "Кампания отключена" %}</div>
                      <form method="post" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="activate">
                        <input type="hidden" name="id" value="{{ it.ui_id }}">
                        <button type="submit" class="YY-BUTTON_TAB_MAIN">
                          {% trans "Включить" %}
                        </button>
                      </form>
                    {% endif %}
                  </td>

                  <td class="YY-TB_TD">
                    <a href="?state=edit&id={{ it.ui_id }}" class="YY-BUTTON_TAB_MAIN mb-2">
                      {% trans "Изменить" %}
                    </a>

                    <form method="post" onsubmit="return confirm('{% trans "Вы уверены?" %}');">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="id" value="{{ it.ui_id }}">
                      <button type="submit" class="YY-BUTTON_TAB_RED">
                        {% trans "Удалить" %}
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="YY-CARD_WHITE mb-10">
          {% trans "Здесь пока нет данных" %}
        </div>
      {% endif %}
    </td>
  </tr>
</table>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="/static/js/campaign_templates/campaigns_preview.js"></script>
  <script src="/static/js/campaign_templates/modal_preview.js"></script>
  {% if state == "add" or state == "edit" %}
    <script src="/static/js/aap_settings/sending_campaign.js"></script>
  {% endif %}

  {% if state == "letter" %}
    <!-- CodeMirror -->
    <link rel="stylesheet" href="/static/vendor/codemirror/codemirror.css">
    <link rel="stylesheet" href="/static/vendor/codemirror/theme/material-darker.css">
    <script src="/static/vendor/codemirror/codemirror.js"></script>
    <script src="/static/vendor/codemirror/mode/xml/xml.js"></script>
    <script src="/static/vendor/codemirror/mode/javascript/javascript.js"></script>
    <script src="/static/vendor/codemirror/mode/css/css.js"></script>
    <script src="/static/vendor/codemirror/mode/htmlmixed/htmlmixed.js"></script>

    <!-- Tiny -->
    <script src="/static/vendor/tinymce/tinymce.min.js"></script>
    <script src="/static/js/campaign_templates/campaign_letters/tinymce_config.js"></script>

    <!-- Campaign Letter Editor -->
    <script src="/static/js/campaign_templates/campaign_letters/tinymce.js"></script>
    <script src="/static/js/campaign_templates/campaign_letters/codemirror.js"></script>
    <script src="/static/js/campaign_templates/campaign_letters/mode_switch.js"></script>
    <script src="/static/js/campaign_templates/campaign_letters/subjects.js"></script>
    <script src="/static/js/campaign_templates/campaign_letters/preview.js"></script>
    <script src="/static/js/campaign_templates/campaign_letters/submit.js"></script>
  {% endif %}
{% endblock %}
