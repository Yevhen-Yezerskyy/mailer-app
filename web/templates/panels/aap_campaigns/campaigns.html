<!-- FILE: web/templates/panels/aap_campaigns/campaigns.html -->
<!-- DATE: 2026-01-19 -->
<!-- PURPOSE:
  Кампании — единая страница.
  A: спокойное состояние + кнопка добавления
  B: add/edit кампании (форма)
  C: редактор письма
  D: нижняя таблица кампаний
-->

{% extends "panels/base.html" %}
{% load i18n %}

{% block content %}

{# ==================== A. СПОКОЙНОЕ СОСТОЯНИЕ ==================== #}

{% if not state %}
<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-[70%]">
      <div class="YY-CARD_WHITE">
        <div class="YY-STATUS_BLUE">
          {% trans "Ваши кампании:" %}
        </div>
      </div>
    </td>

    <td class="YY-MAIN_TOP_RIGHT_TD w-[30%]">
      <div class="YY-CARD_WHITE">
        <a href="?state=add" class="YY-BUTTON_MAIN w-full mb-2">
          {% trans "Добавить кампанию" %}
        </a>
      </div>
    </td>
  </tr>
</table>
{% endif %}

{# ==================== B. ADD / EDIT КАМПАНИИ ==================== #}
{% if state == "add" or state == "edit" %}

<!-- FILE: web/templates/panels/aap_campaigns/campaigns.html -->
<!-- DATE: 2026-01-19 -->
<!-- PURPOSE: B-block add/edit form (полностью) + окно отправки справа (UI 1:1 как Settings). -->

<form method="post" id="yyCampaignForm">
  {% csrf_token %}
  {% if edit_obj %}
    <input type="hidden" name="id" value="{{ edit_obj.ui_id }}">
  {% endif %}

  <table class="YY-MAIN_TABLE">
    <tr>
      <!-- LEFT 50% -->
      <td class="YY-MAIN_TOP_LEFT_TD w-[50%] align-top">
        <div class="YY-CARD_WHITE">

          <label class="YY-LABEL">{% trans "Название кампании" %}</label>
          <input type="text" name="title" class="YY-INPUT mb-3"
                 value="{{ edit_obj.title|default:'' }}">

          <label class="YY-LABEL">{% trans "Список рассылки" %}</label>
          <select name="mailing_list" class="YY-INPUT mb-3">
            <option value="">{% trans "— не выбран —" %}</option>
            {% for it in list_items %}
              <option value="{{ it.ui_id }}"
                {% if edit_obj and edit_obj.mailing_list_id == it.id %}selected{% endif %}>
                {{ it.title }}
              </option>
            {% endfor %}
          </select>

          <label class="YY-LABEL">{% trans "Mailbox" %}</label>
          <select name="mailbox" class="YY-INPUT mb-3">
            <option value="">{% trans "— не выбран —" %}</option>
            {% for it in mb_items %}
              <option value="{{ it.ui_id }}"
                {% if edit_obj and edit_obj.mailbox_id == it.id %}selected{% endif %}>
                {{ it.name }} &lt;{{ it.email }}&gt;
              </option>
            {% endfor %}
          </select>

          <label class="YY-LABEL">{% trans "Шаблон письма" %}</label>
          <select name="template" class="YY-INPUT mb-4">
            <option value="">{% trans "— не выбран —" %}</option>
            {% for it in tpl_items %}
              <option value="{{ it.ui_id }}"
                {% if edit_obj and edit_obj.letter and edit_obj.letter.template_id == it.id %}selected{% endif %}>
                {{ it.template_name }}
              </option>
            {% endfor %}
          </select>

          <label class="YY-LABEL">{% trans "Дата старта" %}</label>
          <div class="flex gap-2 mb-3">
            <input type="number" name="start_dd" min="1" max="31" class="yy-input-date-dd" placeholder="DD">
            <input type="number" name="start_mm" min="1" max="12" class="yy-input-date-mm" placeholder="MM">
            <input type="number" name="start_yy" min="2020" max="2100" class="yy-input-date-yy" placeholder="YYYY">
          </div>

          <label class="YY-LABEL">{% trans "Дата конца" %}</label>
          <div class="flex gap-2 mb-4">
            <input type="number" name="end_dd" min="1" max="31" class="yy-input-date-dd" placeholder="DD">
            <input type="number" name="end_mm" min="1" max="12" class="yy-input-date-mm" placeholder="MM">
            <input type="number" name="end_yy" min="2020" max="2100" class="yy-input-date-yy" placeholder="YYYY">
          </div>

          {% if state == "edit" and edit_obj and edit_obj.campaign_parent %}
            <div class="YY-TEXT mb-1">
              {% trans "Следуем за кампанией" %}: <strong>{{ edit_obj.campaign_parent.title }}</strong>
            </div>
            <label class="YY-LABEL">{% trans "Отправлять письма через (дней)" %}</label>
            <input type="number" name="send_after_parent_days"
                   class="YY-INPUT"
                   value="{{ edit_obj.send_after_parent_days }}">
          {% endif %}

        </div>
      </td>

      <!-- RIGHT 50% -->
      <td class="YY-MAIN_TOP_RIGHT_TD w-[50%] align-top">
        <div class="YY-CARD_WHITE">

          <label class="YY-TEXT flex items-center gap-2 mb-3">
            <input type="checkbox" id="yyUseGlobalWindow" name="use_global_window"
                   {% if not edit_obj or not edit_obj.window %}checked{% endif %}>
            {% trans "Использовать глобальные настройки окна отправки" %}
          </label>

          <textarea id="yyGlobalWindowJson" class="hidden">{{ global_window_json_str }}</textarea>
          <textarea name="window" id="yyValueJson" class="hidden">
            {% if edit_obj and edit_obj.window %}{{ edit_obj.window|safe }}{% endif %}
          </textarea>

          <div id="yyWindowBox">
            <table class="w-full text-left">
              <thead>
                <tr class="YY-TH_TR">
                  <th class="YY-TH_TH w-[32%]">{% trans "День недели" %}</th>
                  <th class="YY-TH_TH">{% trans "Окна отправки писем" %}</th>
                </tr>
              </thead>
              <tbody id="yySendingBody">
                <tr data-yy-day="mon" class="YY-TB_TR align-top"><td class="YY-TB_TD"><div class="YY-STATUS_GREEN">{% trans "Понедельник" %}</div></td><td class="YY-TB_TD"><div class="yy-day-windows"></div></td></tr>
                <tr data-yy-day="tue" class="YY-TB_TR align-top"><td class="YY-TB_TD"><div class="YY-STATUS_GREEN">{% trans "Вторник" %}</div></td><td class="YY-TB_TD"><div class="yy-day-windows"></div></td></tr>
                <tr data-yy-day="wed" class="YY-TB_TR align-top"><td class="YY-TB_TD"><div class="YY-STATUS_GREEN">{% trans "Среда" %}</div></td><td class="YY-TB_TD"><div class="yy-day-windows"></div></td></tr>
                <tr data-yy-day="thu" class="YY-TB_TR align-top"><td class="YY-TB_TD"><div class="YY-STATUS_GREEN">{% trans "Четверг" %}</div></td><td class="YY-TB_TD"><div class="yy-day-windows"></div></td></tr>
                <tr data-yy-day="fri" class="YY-TB_TR align-top"><td class="YY-TB_TD"><div class="YY-STATUS_GREEN">{% trans "Пятница" %}</div></td><td class="YY-TB_TD"><div class="yy-day-windows"></div></td></tr>

                <tr class="YY-TB_TR"><td class="YY-TB_TD" colspan="2"><div class="h-[3px]"></div></td></tr>

                <tr data-yy-day="sat" class="YY-TB_TR align-top"><td class="YY-TB_TD"><div class="YY-STATUS_YELLOW">{% trans "Суббота" %}</div></td><td class="YY-TB_TD"><div class="yy-day-windows"></div></td></tr>
                <tr data-yy-day="sun" class="YY-TB_TR align-top"><td class="YY-TB_TD"><div class="YY-STATUS_YELLOW">{% trans "Воскресенье" %}</div></td><td class="YY-TB_TD"><div class="yy-day-windows"></div></td></tr>

                <tr class="YY-TB_TR"><td class="YY-TB_TD" colspan="2"><div class="h-[3px]"></div></td></tr>

                <tr data-yy-day="hol" class="YY-TB_TR align-top"><td class="YY-TB_TD"><div class="YY-STATUS_RED">{% trans "Праздники" %}</div></td><td class="YY-TB_TD"><div class="yy-day-windows"></div></td></tr>
              </tbody>
            </table>
          </div>

          <div class="flex justify-end gap-3 mt-6">
            <button type="submit" name="action"
                    value="{% if state == 'add' %}add_campaign{% else %}save_campaign{% endif %}"
                    class="YY-BUTTON_MAIN">
              {% trans "Сохранить изменения" %}
            </button>
            <button type="submit" name="action" value="close"
                    formnovalidate class="YY-BUTTON_MAIN">
              {% trans "Закрыть" %}
            </button>
          </div>

        </div>
      </td>
    </tr>
  </table>
</form>


{% endif %}

{# ==================== C. РЕДАКТОР ПИСЬМА ==================== #}
{% if state == "letter" %}
  {{ block.super }}
{% endif %}

{# ==================== D. НИЖНЯЯ ТАБЛИЦА ==================== #}
{% if items %}
  <div class="YY-CARD_WHITE mt-10">
    <table class="w-full text-left">
      <tbody>
        {% for it in items %}
          <tr class="YY-TB_TR">
            <td class="YY-TB_TD"><div class="YY-STATUS_BLUE">{{ it.title }}</div></td>
            <td class="YY-TB_TD"><a href="?state=edit&id={{ it.ui_id }}" class="YY-BUTTON_TAB_MAIN">{% trans "Изменить" %}</a></td>
            <td class="YY-TB_TD"><a href="?state=letter&id={{ it.ui_id }}" class="YY-BUTTON_TAB_MAIN">{% trans "Письмо" %}</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  {% if state == "add" or state == "edit" %}
    <script src="/static/js/aap_settings/sending_campaign.js"></script>
  {% endif %}
{% endblock %}