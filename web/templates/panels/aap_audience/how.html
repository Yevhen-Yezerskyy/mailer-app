{# FILE: web/templates/panels/aap_audience/how.html (–Ω–æ–≤–æ–µ) 2025-12-11 #}

{% extends "panels/base.html" %}

{% block title %}–ü–æ–¥–±–æ—Ä –∞–¥—Ä–µ—Å–∞—Ç–æ–≤ ‚Äî Serenity Mailer{% endblock %}

{% block sidebar_menu %}
  {% include "panels/aap_audience/menu_left.html" %}
{% endblock %}

{% block content %}

<div class="panel-page">

  {# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ –≤–∏–¥–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ #}
  <div class="panel-card" style="margin-bottom: 24px;">
    <ol style="margin: 0; padding-left: 20px; line-height: 1.6;">
      <li><strong>–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ —Å–µ–±—è –∏ —á—Ç–æ –≤—ã –ø—Ä–æ–¥–∞—ë—Ç–µ.</strong> –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –ª–∏—à–Ω–µ–µ.</li>
      <li>
        <strong>–î–∞–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç</strong> (–Ω–∞–ø—Ä–∏–º–µ—Ä: <span style="white-space: nowrap;">https://mysite.ua</span>).
        –°–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –ø–æ–¥—Ç—è–Ω–µ—Ç –Ω—É–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã.
      </li>
      <li><strong>–ü–∏—à–∏—Ç–µ –∫–∞–∫ —É–≥–æ–¥–Ω–æ</strong> ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Ä–∞–∑–ª–æ–∂–∏—Ç –ø–æ –ø–æ–ª–∫–∞–º.</li>
      <li>
        <strong>–õ–∏—à–Ω–µ–µ –∏ –Ω–µ–≤–∞–∂–Ω–æ–µ —Å–∏—Å—Ç–µ–º–∞ –≤—ã–∫–∏–Ω–µ—Ç.</strong>
        –ß—Ç–æ —É–¥–∞–ª–∏–ª–∏ ‚Äî –∏—Å—á–µ–∑–Ω–µ—Ç. –ß—Ç–æ –¥–æ–ø–∏—Å–∞–ª–∏ ‚Äî –æ—Ñ–æ—Ä–º–∏—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
      </li>
      <li>
        <strong>–û—Ç–≤–µ—á–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.</strong>
        –û–Ω–∏ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–∫–∞—Ç—å –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.
      </li>
    </ol>
  </div>

  <div class="panel-card">
    <form method="post" class="panel-form" id="how-form">
      {% csrf_token %}

      {# -------- –ß—Ç–æ –ø—Ä–æ–¥–∞—ë—Ç–µ -------- #}
      <div class="panel-form-group">
        <label class="panel-form-label" for="id_what">–ß—Ç–æ –ø—Ä–æ–¥–∞—ë—Ç–µ</label>
        {% if form.question_what.value %}
          <div class="gpt-question-block">
            <strong>–£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å:</strong> {{ form.question_what.value }}
            {% if form.hint_what.value %}
              <div class="gpt-hint">{{ form.hint_what.value }}</div>
            {% endif %}
          </div>
        {% endif %}

        <textarea
          name="{{ form.what.name }}"
          id="id_what"
          rows="4"
          class="panel-input-textarea"
          placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –∏–ª–∏ —É—Å–ª—É–≥—É –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–ª–æ–≤–∞—Ö."
        >{{ form.what.value|default_if_none:"" }}</textarea>

        {% if form.what.errors %}
          <div class="panel-form-error">{{ form.what.errors }}</div>
        {% endif %}
      </div>

      {# -------- –ö—Ç–æ –≤—ã –∫–∞–∫ –∫–æ–º–ø–∞–Ω–∏—è -------- #}
      <div class="panel-form-group">
        <label class="panel-form-label" for="id_who">–ö—Ç–æ –≤—ã –∫–∞–∫ –∫–æ–º–ø–∞–Ω–∏—è</label>
        {% if form.question_who.value %}
          <div class="gpt-question-block">
            <strong>–£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å:</strong> {{ form.question_who.value }}
            {% if form.hint_who.value %}
              <div class="gpt-hint">{{ form.hint_who.value }}</div>
            {% endif %}
          </div>
        {% endif %}

        <textarea
          name="{{ form.who.name }}"
          id="id_who"
          rows="4"
          class="panel-input-textarea"
          placeholder="–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏, —Å–∞–π—Ç –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ–∞–∫—Ç—ã –æ –±–∏–∑–Ω–µ—Å–µ: —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã."
        >{{ form.who.value|default_if_none:"" }}</textarea>

        {% if form.who.errors %}
          <div class="panel-form-error">{{ form.who.errors }}</div>
        {% endif %}
      </div>

      {# -------- –ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Ä–∞–±–æ—Ç—ã -------- #}
      <div class="panel-form-group">
        <label class="panel-form-label" for="id_geo">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Ä–∞–±–æ—Ç—ã</label>
        {% if form.question_geo.value %}
          <div class="gpt-question-block">
            <strong>–£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å:</strong> {{ form.question_geo.value }}
            {% if form.hint_geo.value %}
              <div class="gpt-hint">{{ form.hint_geo.value }}</div>
            {% endif %}
          </div>
        {% endif %}

        <textarea
          name="{{ form.geo.name }}"
          id="id_geo"
          rows="4"
          class="panel-input-textarea"
          placeholder="–†–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –ì–µ—Ä–º–∞–Ω–∏–∏: –æ—Ñ–∏—Å—ã, –ø–∞—Ä—Ç–Ω—ë—Ä—ã, —Å–∫–ª–∞–¥—ã, –æ—Ç–∫—É–¥–∞ –º–æ–∂–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –¥–æ—Å—Ç–∞–≤–ª—è—Ç—å."
        >{{ form.geo.value|default_if_none:"" }}</textarea>

        {% if form.geo.errors %}
          <div class="panel-form-error">{{ form.geo.errors }}</div>
        {% endif %}
      </div>

      {# —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤/—Ö–∏–Ω—Ç–æ–≤ (–∫–∞–∫ –µ—Å—Ç—å –≤ —Ñ–æ—Ä–º–µ) #}
      {{ form.question_what }}{{ form.hint_what }}
      {{ form.question_who }}{{ form.hint_who }}
      {{ form.question_geo }}{{ form.hint_geo }}
      {{ form.edit_id }}
      <input type="hidden" name="mode" id="id_mode" value="">

      <div class="panel-form-actions">
        <button type="submit" class="panel-button-primary" id="submit-btn">
          –û–±—Ä–∞–±–æ—Ç–∞—Ç—å
        </button>

        <button type="submit" name="save" value="1" class="panel-button-secondary" id="save-btn" style="margin-left: 8px;">
          {% if form.edit_id.value %}
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          {% else %}
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É
          {% endif %}
        </button>

        <button type="button" class="panel-button-secondary" id="clear-btn" style="margin-left: 8px;">
          –û—á–∏—Å—Ç–∏—Ç—å
        </button>
      </div>

      <div id="how-error" class="panel-form-error" style="display:none; margin-top: 8px;">
        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ.
      </div>

      <div class="panel-form-overlay">
        <div class="panel-form-overlay-inner">
          –î—É–º–∞—é‚Ä¶
        </div>
      </div>
    </form>
  </div>

</div>  {# /panel-page ‚Äî –ó–ê–ö–†–´–õ–ò #}


{# ----- –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (—à–∏—Ä–æ–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞ 95%) ----- #}
{% if tasks %}
  <div class="panel-card" style="margin-top: 24px; width: 95%; max-width: none; margin-left: auto; margin-right: auto;">
    <h3 class="panel-card-title" style="margin-bottom: 12px;">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3>

    <div class="panel-table-wrapper">
      <table class="panel-table">
        <thead>
          <tr>
            <th style="width: 10%;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th style="width: 30%;">Task</th>
            <th style="width: 30%;">Branches-–∑–∞–¥–∞—á–∞</th>
            <th style="width: 30%;">Geo-–∑–∞–¥–∞—á–∞</th>
            <th style="width: 110px; text-align: right;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tasks %}
            <tr>
              <td>
                <strong>{{ t.title }}</strong>
              </td>
              <td>
                {{ t.task|linebreaksbr }}
              </td>
              <td>
                {{ t.task_branches|linebreaksbr }}
              </td>
              <td>
                {{ t.task_geo|linebreaksbr }}
              </td>
              <td style="text-align: right;">
                <div style="display: inline-flex; gap: 8px; align-items: center;">
                  {# —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å #}
                  <a href="?edit={{ t.id }}"
                     class="panel-link task-edit-link"
                     style="font-size: 13px;"
                     title="–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É">
                    ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                  </a>

                  {# —É–¥–∞–ª–∏—Ç—å #}
                  <form method="post" style="margin: 0; display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="mode" value="delete">
                    <input type="hidden" name="delete_id" value="{{ t.id }}">
                    <button type="submit"
                            class="panel-link"
                            style="background: none; border: none; padding: 0; margin-left: 4px; font-size: 13px; color: #b91c1c; cursor: pointer;"
                            title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É"
                            onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?');">
                      üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}



<script>
  (function () {
    const form = document.getElementById("how-form");
    const submitBtn = document.getElementById("submit-btn");
    const saveBtn = document.getElementById("save-btn");
    const clearBtn = document.getElementById("clear-btn");
    const errorBox = document.getElementById("how-error");

    const whatField = document.getElementById("id_what");
    const whoField  = document.getElementById("id_who");
    const geoField  = document.getElementById("id_geo");
    const editIdField = document.getElementById("id_edit_id");
    const modeField = document.getElementById("id_mode");

    if (submitBtn) {
      submitBtn.addEventListener("click", function () {
        if (modeField) modeField.value = "process";
      });
    }

    if (saveBtn) {
      saveBtn.addEventListener("click", function () {
        if (modeField) modeField.value = "save";
      });
    }

    if (form) {
      form.addEventListener("submit", function (e) {
        const whatText = (whatField?.value || "").trim();
        const whoText  = (whoField?.value  || "").trim();
        const geoText  = (geoField?.value  || "").trim();

        // –ó–∞–ø—Ä–µ—Ç–∏—Ç—å POST, –µ—Å–ª–∏ –≤—Å–µ —Ç—Ä–∏ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ
        if (!whatText && !whoText && !geoText) {
          e.preventDefault();
          if (errorBox) errorBox.style.display = "block";
          (whatField || whoField || geoField)?.focus();
          return;
        }

        if (errorBox) errorBox.style.display = "none";

        form.classList.add("panel-form--loading");
        if (submitBtn) submitBtn.disabled = true;
        if (saveBtn) saveBtn.disabled = true;
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", function (e) {
        e.preventDefault();

        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) return;

        if (whatField) whatField.value = "";
        if (whoField)  whoField.value  = "";
        if (geoField)  geoField.value  = "";

        if (editIdField) editIdField.value = "";
        if (modeField) modeField.value = "";

        const metaIds = [
          "id_question_what",
          "id_question_who",
          "id_question_geo",
          "id_hint_what",
          "id_hint_who",
          "id_hint_geo",
        ];
        metaIds.forEach(function (id) {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });

        const questionBlocks = document.querySelectorAll(".gpt-question-block");
        questionBlocks.forEach(function (qb) {
          qb.style.display = "none";
        });

        if (errorBox) errorBox.style.display = "none";
      });
    }

    // –û–≤–µ—Ä–ª—ç–π "–î—É–º–∞—é..." –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ "–ò–∑–º–µ–Ω–∏—Ç—å" –≤ —Å–ø–∏—Å–∫–µ –∑–∞–¥–∞—á
    const editLinks = document.querySelectorAll(".task-edit-link");
    editLinks.forEach(function (link) {
      link.addEventListener("click", function () {
        if (form) {
          form.classList.add("panel-form--loading");
        }
      });
    });
  })();
</script>


{% endblock %}
