<!-- FILE: web/templates/panels/aap_audience/how.html -->
<!-- DATE: 2025-12-24 -->

{% extends "panels/base.html" %}
{% load i18n %}

{% block content %}

<form method="post">
  {% csrf_token %}

  <table class="YY-MAIN_TABLE">
    <tr>
      <td class="YY-MAIN_TOP_LEFT_TD w-1/2">
        <div class="YY-CARD_WHITE">
          <div class="YY-CARD_IN_FORM_BLANK mb-5">
            <div class="flex gap-3">
              <button
                type="button"
                onclick="location.href='?state={{ state }}&type=sell{% if id %}&id={{ id }}{% endif %}'"
                class="{% if type == 'sell' %}YY-BUTTON_GREEN{% else %}YY-BUTTON_MAIN{% endif %}">
                {% trans "Поиск клиентов" %}
              </button>

              <button
                type="button"
                onclick="location.href='?state={{ state }}&type=buy{% if id %}&id={{ id }}{% endif %}'"
                class="{% if type == 'buy' %}YY-BUTTON_GREEN{% else %}YY-BUTTON_MAIN{% endif %}">
                {% trans "Поиск поставщиков / подрядчиков" %}
              </button>
            </div>
          </div>

          {% if state == "how" %}
            <!-- WHAT -->
            <label class="YY-LABEL">
              {{ form.what.label }}
            </label>

            {% if q_what or h_what %}
              <div class="YY-CARD_IN_FORM">
                {% if q_what %}<p>{{ q_what }}</p>{% endif %}
                {% if h_what %}<p>{{ h_what }}</p>{% endif %}
              </div>
            {% endif %}

            {{ form.what }}

            <label class="YY-LABEL">
              {{ form.who.label }}
            </label>

            {% if q_who or h_who %}
              <div class="YY-CARD_IN_FORM">
                {% if q_who %}<p>{{ q_who }}</p>{% endif %}
                {% if h_who %}<p>{{ h_who }}</p>{% endif %}
              </div>
            {% endif %}

            {{ form.who }}

            <label class="YY-LABEL">
              {{ form.geo.label }}
            </label>

            {% if q_geo or h_geo %}
              <div class="YY-CARD_IN_FORM">
                {% if q_geo %}<p>{{ q_geo }}</p>{% endif %}
                {% if h_geo %}<p>{{ h_geo }}</p>{% endif %}
              </div>
            {% endif %}

            {{ form.geo }}

            <div class="flex gap-3">
              <button type="submit" name="action" value="process" class="YY-BUTTON_MAIN" data-loading="1">
                {% trans "Обработать" %}
              </button>
              <button type="submit" name="action" value="clear" class="YY-BUTTON_MAIN">
                {% trans "Очистить" %}
              </button>
              <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN" data-loading="1">
                {% trans "Сохранить" %}
              </button>
            </div>
          {% endif %}

          {% if state == "edit" %}
            <!-- WHAT -->
            <label class="YY-LABEL">
              {{ form.what.label }}
            </label>
            {{ form.what }}

            <!-- WHO -->
            <label class="YY-LABEL">
              {{ form.who.label }}
            </label>
            {{ form.who }}

            <!-- GEO -->
            <label class="YY-LABEL">
              {{ form.geo.label }}
            </label>
            {{ form.geo }}
          {% endif %}
        </div>
      </td>

      <td class="YY-MAIN_TOP_RIGHT_TD w-1/2">
        {% if state == "how" %}
          <div class="YY-CARD_BLUE">
            <p class="YY-TEXT">
              <strong>Инструкции</strong>
            </p>
            <ol class="YY-TEXT_OL">
              <li class="YY-TEXT_LI">
                <strong>{% trans "Предоставленная Вами информация является непубличной и не передаётся третьим лицам." %}</strong>
                {% trans "Она используется исключительно для оценки вероятности заключения сделки с контрагентами." %}
                <strong>{% trans "Недостоверные данные искажают результат и снижают эффективность подбора контрагентов." %}</strong>
                {% trans "Поэтому указывайте реальные факты, а не маркетинговые формулировки — это в Ваших интересах." %}
              </li>

              <li class="YY-TEXT_LI">
                <strong>{% trans "Это вспомогательный ассистент для формулирования критериев отбора и ранжирования контрагентов." %}</strong>
                {% trans "Ответственность за сохранённые данные лежит на Вас: Вы должны исправлять ошибки, удалять неверные предположения и добавлять корректные факты. Недостоверная информация искажает оценку вероятности сделки." %}
                
              </li>

              <li class="YY-TEXT_LI">
                <strong>{% trans "Ассистент задаёт вопросы, чтобы подсказать, какую информацию ещё можно добавить." %}</strong>
                {% trans "Отвечать на них не обязательно. Если вопрос кажется лишним или у Вас нет ответа, просто пропустите его. Вопросы будут появляться постоянно. Когда результат Вас устроит, сохраните его." %}
              </li>

              <li class="YY-TEXT_LI">
                <strong>{% trans "«Обработать» — вызвать ассистента для корректировки и дополнения введённой Вами информации." %}</strong>
                {% trans "При сохранении формируются критерии выбора контрагентов, бизнес-категорий и городов Германии. Вы сможете отредактировать эти данные. Сбор и ранжирование контрагентов запускаются отдельно." %}
              </li>

              <li class="YY-TEXT_LI">
                <strong>{% trans "Указывайте интернет-адреса в виде ссылок (https://mysite.com)." %}</strong>
                {% trans "Если сомневаетесь, скопируйте адрес из строки браузера. Иначе ассистент не распознает, что это ссылка." %}
              </li>
            </ol>
          </div>
        {% endif %}
        {% if state == "edit" %}
          <div class="YY-CARD_WHITE">
            <label class="YY-LABEL">
              {{ form.title.label }}
            </label>
            {{ form.title }}

            <label class="YY-LABEL">
              {{ form.task_client.label }}
            </label>
            {{ form.task_client }}

            <label class="YY-LABEL">
              {{ form.task_branches.label }}
            </label>
            {{ form.task_branches }}

            <label class="YY-LABEL">
              {{ form.task_geo.label }}
            </label>
            {{ form.task_geo }}

            {% if form.non_field_errors %}
              <div class="YY-CARD_IN_FORM_ERROR mt-3">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <div class="flex gap-3 mt-3">
              <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN">
                {% trans "Сохранить изменения" %}
              </button>
              <button type="submit" name="action" value="cancel" class="YY-BUTTON_MAIN" formnovalidate>
                {% trans "Отменить" %}
              </button>
            </div>
          </div>
        {% endif %}
      </td>
    </tr>
  </table>

</form>

<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_BOTTOM_TD">
      {% if tasks %}
        <div class="YY-MAIN_BOTTOM_DIV">
          <table class="w-full text-left">
            <thead>
              <tr class="YY-TH_TR">
                <th class="YY-TH_TH w-[40%]">{% trans "Задача" %}</th>
                <th class="YY-TH_TH w-[40%]">{% trans "Критерии выбора" %}</th>
                <th class="YY-TH_TH">{% trans "Статус" %}</th>
                <th class="YY-TH_TH">{% trans "Действия" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tasks %}
                <tr class="YY-TB_TR">
                  <td class="YY-TB_TD">
                    {% if t.type == "sell" %}
                      <div class="YY-STATUS_GREEN mb-3">
                        {% trans "Поиск клиентов" %}
                      </div>
                    {% else %}
                      <div class="YY-STATUS_YELLOW mb-3">
                        {% trans "Поиск поставщиков / подрядчиков" %}
                      </div>
                    {% endif %}

                    <div class="mb-3 font-semibold">
                      {{ t.title }}
                    </div>
                    <div>
                      {{ t.task }}
                    </div>
                  </td>

                  <td class="YY-TB_TD">
                    <div data-tabs="choice-{{ t.id }}">
                      <div class="flex gap-3 mb-3">
                        <button type="button"
                          data-tab="client"
                          data-active-class="YY-BUTTON_GREEN"
                          data-idle-class="YY-BUTTON_MAIN"
                          class="YY-BUTTON_GREEN">
                          {% trans "Клиент" %}
                        </button>

                        <button type="button"
                          data-tab="branches"
                          data-active-class="YY-BUTTON_GREEN"
                          data-idle-class="YY-BUTTON_MAIN"
                          class="YY-BUTTON_MAIN">
                          {% trans "Категории" %}
                        </button>

                        <button type="button"
                          data-tab="geo"
                          data-active-class="YY-BUTTON_GREEN"
                          data-idle-class="YY-BUTTON_MAIN"
                          class="YY-BUTTON_MAIN">
                          {% trans "География" %}
                        </button>
                      </div>

                      <div data-panel="client">
                        {{ t.task_client|linebreaksbr }}
                      </div>
                      <div data-panel="branches" class="hidden">
                        {{ t.task_branches|linebreaksbr }}
                      </div>
                      <div data-panel="geo" class="hidden">
                        {{ t.task_geo|linebreaksbr }}
                      </div>
                    </div>
                  </td>

                  <td class="YY-TB_TD">
                    {% if t.run_processing %}
                      <div class="YY-STATUS_GREEN">
                        {% trans "В работе" %}
                      </div>
                    {% else %}
                      <div class="YY-STATUS_YELLOW">
                        {% trans "Не запущено" %}
                      </div>
                    {% endif %}
                  </td>

                  <td class="YY-TB_TD">
                    <a
                      href="?state=edit&type={{ t.type }}&id={{ t.ui_id }}"
                      class="YY-BUTTON_TAB_MAIN mb-2 inline-block">
                      {% trans "Изменить" %}
                    </a>
                    {% if not t.run_processing %}
                    <form method="post" class="inline-block"
                          onsubmit="return confirm('{% trans "Удалить задачу?" %}')">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="id" value="{{ t.ui_id }}">
                      <button type="submit" class="YY-BUTTON_TAB_RED">
                        {% trans "Удалить" %}
                      </button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="YY-CARD_WHITE mb-10">
          {% trans "Здесь пока нет данных" %}
        </div>
      {% endif %}
    </td>
  </tr>
</table>

{% endblock %}
