{% extends "panels/base.html" %}
{% load i18n %}

{% block content %}
<!-- FILE: web/templates/panels/aap_audience/status_task.html -->
<!-- DATE: 2026-01-20 -->
<!-- CHANGE:
- Добавлен toggle run_processing (Сбор контактов) сверху справа: одна строка (статус слева, кнопка справа).
- Остальная логика страницы сохранена. -->

<!-- TOP TABLE -->
<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_TOP_LEFT_TD w-1/2">
      <div class="YY-CARD_WHITE">
        {% if t.type == "sell" %}
          <div class="YY-STATUS_GREEN mb-8">
              {% trans "Поиск клиентов" %}:<br>
              {{ t.title }}
          </div>
        {% else %}
          <div class="YY-STATUS_YELLOW mb-8">
              {% trans "Поиск поставщиков / подрядчиков" %}:<br>
              {{ t.title }}
        </div>
        {% endif %}

        <div class="YY-STATUS_BLUE mb-2">
          {% trans "Контакты: присвоен рейтинг" %}: {{ contacts_rated }}
        </div>

        <div class="YY-STATUS_GRAY mb-2">
          {% trans "Всего собрано контактов" %}: {{ contacts_total }}
        </div>

        <div class="YY-STATUS_YELLOW mb-8">
          {% trans "Контактов к рейтингованию" %}: {{ t.subscribers_limit|default_if_none:0 }}
        </div>

        <a href="../" class="YY-BUTTON_MAIN">
          {% trans "Вернуться к аудиториям" %}
        </a>

      </div>
    </td>

    <td class="YY-MAIN_TOP_RIGHT_TD w-1/2">
      <div class="YY-CARD_WHITE">

        <div class="grid grid-cols-[2fr_1fr] gap-3 mb-12">
          {% if t.run_processing %}
            <div class="YY-STATUS_GREEN !mb-0 !py-1">
              {% trans "Сбор контактов включён" %}
            </div>
            <form method="post" class="!mb-0 w-full">
              {% csrf_token %}
              <button type="submit" name="action" value="toggle_processing" class="YY-BUTTON_MAIN w-full">
                {% trans "Отключить" %}
              </button>
            </form>
          {% else %}
            <div class="YY-STATUS_GRAY !mb-0 !py-1">
              {% trans "Сбор контактов отключён" %}
            </div>
            <form method="post" class="!mb-0 w-full">
              {% csrf_token %}
              <button type="submit" name="action" value="toggle_processing" class="YY-BUTTON_MAIN w-full">
                {% trans "Включить" %}
              </button>
            </form>
          {% endif %}
        </div>

        {% if rating_active_exists %}
          <div class="YY-STATUS_YELLOW mb-4">
            {% trans "Рейтингование контактов запущено" %}
          </div>
        {% else %}

          {% if criteria_changed %}
            <div class="YY-STATUS_YELLOW mb-2">
              {% trans "Критерии оценки изменены" %}
            </div>

            <form method="post" class="mb-2">
              {% csrf_token %}
              <button type="submit" name="action" value="rating_start_contacts_update" class="YY-BUTTON_MAIN w-full">
                {% trans "Провести повторное рейтингование" %}
              </button>
            </form>
          {% else %}
          <div class="flex gap-3 mb-6">
            <div class="YY-BUTTON_GREEN" style="width:250px !Important;margin-right:60px !Important;">
              {% trans "Присвоить рейтинг" %}:
            </div>

              <form method="post">
                {% csrf_token %}
                <button type="submit" name="action" value="rating_add_100" class="YY-BUTTON_MAIN">
                  {% trans "+ 100" %}
                </button>
              </form>

              <form method="post">
                {% csrf_token %}
                <button type="submit" name="action" value="rating_add_200" class="YY-BUTTON_MAIN">
                  {% trans "+ 200" %}
                </button>
              </form>

              <form method="post">
                {% csrf_token %}
                <button type="submit" name="action" value="rating_add_500" class="YY-BUTTON_MAIN">
                  {% trans "+ 500" %}
                </button>
              </form>

              <form method="post">
                {% csrf_token %}
                <button type="submit" name="action" value="rating_add_1000" class="YY-BUTTON_MAIN">
                  {% trans "+ 1 000" %}
                </button>
              </form>
            </div>
          {% endif %}

        {% endif %}

        <form method="post" class="mb-6">
          {% csrf_token %}
          <button type="submit" name="action" value="rating_clear_ratings" class="YY-BUTTON_MAIN w-full">
            {% trans "Удалить все рейтинги" %}
          </button>
        </form>

        <div class="YY-STATUS_BLUE w-full mb-1">
          {% trans "Контакты: присвоен рейтинг" %}: {{ contacts_rated }}
        </div>

        {% if contacts_rated|default:0|add:0 > 0 %}
          <a class="YY-STATUS_GREEN w-full mb-1 block"
             href="?id={{ request.GET.id }}&tab=rated&p_rated={{ bucket_1_30_page }}&p_all={{ all_page }}">
            - {% trans "Рейтинг 1-30" %}: {{ rated_1_30_cnt }} ({{ rated_1_30_pct }}%)
          </a>

          <a class="YY-STATUS_YELLOW w-full mb-1 block"
             href="?id={{ request.GET.id }}&tab=rated&p_rated={{ bucket_31_70_page }}&p_all={{ all_page }}">
            - {% trans "Рейтинг 31-70" %}: {{ rated_31_70_cnt }} ({{ rated_31_70_pct }}%)
          </a>

          <a class="YY-STATUS_GRAY w-full mb-1 block"
             href="?id={{ request.GET.id }}&tab=rated&p_rated={{ bucket_71_100_page }}&p_all={{ all_page }}">
            - {% trans "Рейтинг 71-100" %}: {{ rated_71_100_cnt }} ({{ rated_71_100_pct }}%)
          </a>
        {% endif %}

      </div>
    </td>
  </tr>
</table>

<!-- BOTTOM TABLE -->
<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_BOTTOM_TD">

      <div data-tabs="contacts">

        <!-- TABS -->
        <div class="flex gap-3 mb-4">
          <button type="button"
            data-tab="rated"
            data-active-class="YY-BUTTON_GREEN"
            data-idle-class="YY-BUTTON_MAIN"
            class="{% if tab == 'rated' %}YY-BUTTON_GREEN{% else %}YY-BUTTON_MAIN{% endif %}">
            {% trans "Контакты: присвоен рейтинг" %}
          </button>

          <button type="button"
            data-tab="all"
            data-active-class="YY-BUTTON_GREEN"
            data-idle-class="YY-BUTTON_MAIN"
            class="{% if tab == 'all' %}YY-BUTTON_GREEN{% else %}YY-BUTTON_MAIN{% endif %}">
            {% trans "Контакты: все собранные" %}
          </button>
        </div>

        <!-- ================= RATED ================= -->

        <div data-panel="rated" class="{% if tab != 'rated' %}hidden{% endif %}">
        {% if rated_rows %}
          <!-- PAGINATION TOP -->
          <div class="YY-CARD_WHITE flex items-center mb-4">
            {% if rated_page > 1 %}
              <a class="YY-BUTTON_MAIN mr-3"
                href="?id={{ request.GET.id }}&tab=rated&p_rated=1&p_all={{ all_page }}">
                << <<
              </a>
            {% endif %}

            {% if rated_page > 1 %}
              <a class="YY-BUTTON_MAIN mr-6"
                href="?id={{ request.GET.id }}&tab=rated&p_rated={{ rated_page|add:'-1' }}&p_all={{ all_page }}">
                <<
              </a>
            {% endif %}

            <div class="YY-TEXT-BOLD !mb-0">
              {% trans "Страницы" %}: {{ rated_page }} / {{ rated_pages }}
            </div>

            {% if rated_page < rated_pages %}
              <a class="YY-BUTTON_MAIN ml-6"
                href="?id={{ request.GET.id }}&tab=rated&p_rated={{ rated_page|add:'1' }}&p_all={{ all_page }}">
                >>
              </a>
            {% endif %}

            {% if rated_page < rated_pages %}
              <a class="YY-BUTTON_MAIN ml-3"
                href="?id={{ request.GET.id }}&tab=rated&p_rated={{ rated_pages }}&p_all={{ all_page }}">
                >> >>
              </a>
            {% endif %}
          </div>

          <div class="YY-MAIN_BOTTOM_DIV">
            <table class="w-full text-left">
              <thead>
                <tr class="YY-TH_TR">
                  <th class="YY-TH_TH w-[40%]">{% trans "Компания" %}</th>
                  <th class="YY-TH_TH w-[40%]">{% trans "Категории" %}</th>
                  <th class="YY-TH_TH w-[20%]">{% trans "Город" %}</th>
                  <th class="YY-TH_TH">{% trans "Поиск" %}</th>
                  <th class="YY-TH_TH">{% trans "Клиент" %}</th>
                  <th class="YY-TH_TH">&nbsp;</th>
                </tr>
              </thead>
              <tbody>
                {% for it in rated_rows %}
                  <tr class="YY-TB_TR align-top">
                    <td class="YY-TB_TD">
                      <span class="YY-TEXT-BOLD">{{ it.contact.company_name }}</span>
                      {{ it.contact.address }}
                    </td>
                    <td class="YY-TB_TD">{{ it.contact.branches_html|safe }}</td>
                    <td class="YY-TB_TD">{{ it.ratings.chosen_cb.city_land }}</td>
                    <td class="YY-TB_TD text-center">{{ it.ratings.rate_cb_100 }}</td>
                    <td class="YY-TB_TD text-center {{ it.ratings.rate_cl_bg }}">{{ it.ratings.rate_cl }}</td>
                    <td class="YY-TB_TD">
                      <a href="#"
                        class="YY-BUTTON_TAB_MAIN"
                        data-yy-modal="url=/panel/audience/status/task/modal/?id={{ it.ui_id }}">
                        {% trans "Больше" %}
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- PAGINATION BOTTOM -->
          <div class="YY-CARD_WHITE flex items-center mt-6">
            {% if rated_page > 1 %}
              <a class="YY-BUTTON_MAIN mr-3"
                href="?id={{ request.GET.id }}&tab=rated&p_rated=1&p_all={{ all_page }}">
                << <<
              </a>
            {% endif %}

            {% if rated_page > 1 %}
              <a class="YY-BUTTON_MAIN mr-6"
                href="?id={{ request.GET.id }}&tab=rated&p_rated={{ rated_page|add:'-1' }}&p_all={{ all_page }}">
                <<
              </a>
            {% endif %}

            <div class="YY-TEXT-BOLD !mb-0">
              {% trans "Страницы" %}: {{ rated_page }} / {{ rated_pages }}
            </div>

            {% if rated_page < rated_pages %}
              <a class="YY-BUTTON_MAIN ml-6"
                href="?id={{ request.GET.id }}&tab=rated&p_rated={{ rated_page|add:'1' }}&p_all={{ all_page }}">
                >>
              </a>
            {% endif %}

            {% if rated_page < rated_pages %}
              <a class="YY-BUTTON_MAIN ml-3"
                href="?id={{ request.GET.id }}&tab=rated&p_rated={{ rated_pages }}&p_all={{ all_page }}">
                >> >>
              </a>
            {% endif %}
          </div>

          {% else %}
            <div class="YY-CARD_WHITE">
              {% trans "Здесь пока нет данных" %}
            </div>
          {% endif %}

        </div>

        <!-- ================= ALL ================= -->

        <div data-panel="all" class="{% if tab != 'all' %}hidden{% endif %}">
          {% if all_rows %}
          <!-- PAGINATION TOP -->
          <div class="YY-CARD_WHITE flex items-center mb-4">
            {% if all_page > 1 %}
              <a class="YY-BUTTON_MAIN mr-3"
                href="?id={{ request.GET.id }}&tab=all&p_rated={{ rated_page }}&p_all=1">
                << <<
              </a>
            {% endif %}

            {% if all_page > 1 %}
              <a class="YY-BUTTON_MAIN mr-6"
                href="?id={{ request.GET.id }}&tab=all&p_rated={{ rated_page }}&p_all={{ all_page|add:'-1' }}">
                <<
              </a>
            {% endif %}

            <div class="YY-TEXT-BOLD !mb-0">
              {% trans "Страницы" %}: {{ all_page }} / {{ all_pages }}
            </div>

            {% if all_page < all_pages %}
              <a class="YY-BUTTON_MAIN ml-6"
                href="?id={{ request.GET.id }}&tab=all&p_rated={{ rated_page }}&p_all={{ all_page|add:'1' }}">
                >>
              </a>
            {% endif %}

            {% if all_page < all_pages %}
              <a class="YY-BUTTON_MAIN ml-3"
                href="?id={{ request.GET.id }}&tab=all&p_rated={{ rated_page }}&p_all={{ all_pages }}">
                >> >>
              </a>
            {% endif %}
          </div>

          <div class="YY-MAIN_BOTTOM_DIV">
            <table class="w-full text-left">
              <thead>
                <tr class="YY-TH_TR">
                  <th class="YY-TH_TH w-[40%]">{% trans "Компания" %}</th>
                  <th class="YY-TH_TH w-[40%]">{% trans "Категории" %}</th>
                  <th class="YY-TH_TH w-[20%]">{% trans "Город" %}</th>
                  <th class="YY-TH_TH">{% trans "Поиск" %}</th>
                  <th class="YY-TH_TH">&nbsp;</th>
                </tr>
              </thead>
              <tbody>
                {% for it in all_rows %}
                  <tr class="YY-TB_TR align-top">
                    <td class="YY-TB_TD">
                      <span class="YY-TEXT-BOLD">{{ it.contact.company_name }}</span>
                      {{ it.contact.address }}
                    </td>
                    <td class="YY-TB_TD">{{ it.contact.branches_html|safe }}</td>
                    <td class="YY-TB_TD">{{ it.ratings.chosen_cb.city_land }}</td>
                    <td class="YY-TB_TD text-center">{{ it.ratings.rate_cb_100 }}</td>
                    <td class="YY-TB_TD">
                      <a href="#"
                        class="YY-BUTTON_TAB_MAIN"
                        data-yy-modal="url=/panel/audience/status/task/modal/?id={{ it.ui_id }}">
                        {% trans "Больше" %}
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- PAGINATION BOTTOM -->
          <div class="YY-CARD_WHITE flex items-center mt-6">
            {% if all_page > 1 %}
              <a class="YY-BUTTON_MAIN mr-3"
                href="?id={{ request.GET.id }}&tab=all&p_rated={{ rated_page }}&p_all=1">
                << <<
              </a>
            {% endif %}

            {% if all_page > 1 %}
              <a class="YY-BUTTON_MAIN mr-6"
                href="?id={{ request.GET.id }}&tab=all&p_rated={{ rated_page }}&p_all={{ all_page|add:'-1' }}">
                <<
              </a>
            {% endif %}

            <div class="YY-TEXT-BOLD !mb-0">
              {% trans "Страницы" %}: {{ all_page }} / {{ all_pages }}
            </div>

            {% if all_page < all_pages %}
              <a class="YY-BUTTON_MAIN ml-6"
                href="?id={{ request.GET.id }}&tab=all&p_rated={{ rated_page }}&p_all={{ all_page|add:'1' }}">
                >>
              </a>
            {% endif %}

            {% if all_page < all_pages %}
              <a class="YY-BUTTON_MAIN ml-3"
                href="?id={{ request.GET.id }}&tab=all&p_rated={{ rated_page }}&p_all={{ all_pages }}">
                >> >>
              </a>
            {% endif %}
          </div>

          {% else %}
            <div class="YY-CARD_WHITE">
              {% trans "Здесь пока нет данных" %}
            </div>
          {% endif %}

        </div>

      </div>

    </td>
  </tr>
</table>

{% endblock %}
