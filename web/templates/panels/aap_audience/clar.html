<!-- FILE: web/templates/panels/aap_audience/clar.html -->
<!-- DATE: 2025-12-26 -->

{% extends "panels/base.html" %}
{% load i18n %}
{% block content %}


<!-- FILE: web/templates/panels/aap_audience/clar.html  (обновлено — 2025-12-26) -->
<!-- CHANGE: добавлен верхний глобальный блок (2 колонки) только для state=edit: слева форма, справа пусто. -->

{% if state == "edit" %}
    <table class="YY-MAIN_TABLE">
      <tr>
        <td class="YY-MAIN_TOP_LEFT_TD w-1/2">
          <div class="YY-CARD_WHITE">
            <form method="post">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="YY-CARD_IN_FORM_ERROR mb-3">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <label class="YY-LABEL">{{ form.title.label }}</label>
            {{ form.title }}

            <label class="YY-LABEL">{{ form.task.label }}</label>
            {{ form.task }}

            <label class="YY-LABEL">{{ form.task_client.label }}</label>
            {{ form.task_client }}

            <label class="YY-LABEL">{{ form.task_branches.label }}</label>
            {{ form.task_branches }}

            <label class="YY-LABEL">{{ form.task_geo.label }}</label>
            {{ form.task_geo }}

            <div class="flex gap-3 mt-3">
              <button type="submit" name="action" value="save" class="YY-BUTTON_MAIN" data-loading="1">
                {% trans "Сохранить изменения" %}
              </button>
              <button type="submit" name="action" value="cancel" class="YY-BUTTON_MAIN" formnovalidate>
                {% trans "Отменить" %}
              </button>
            </div>
            </form>
          </div>
        </td>

        <td class="YY-MAIN_TOP_RIGHT_TD w-1/2">
           <div class="YY-CARD_WHITE">

              <form method="post">
                {% csrf_token %}

                {% if not rating.has_any %}
                  <p class="YY-TEXT mb-3">Категории и география не обрабатываются</p>
                  <button type="submit" name="action" value="rating_start_all" class="YY-BUTTON_MAIN">
                    Включить обработку
                  </button>
                {% else %}

                  <!-- BRANCHES -->
                  <div class="mb-5">
                    <div class="YY-TEXT font-semibold mb-2">Категории</div>

                    {% if rating.branches.running %}
                      <div class="YY-TEXT">Обрабатываются</div>
                    {% else %}
                      {% if rating.branches.last_done_hash %}
                        {% if rating.branches.last_done_hash == rating_hashes.branches %}
                          <div class="YY-TEXT">Обработаны</div>
                        {% else %}
                          <div class="YY-TEXT mb-2">Задача изменилась</div>
                          <button type="submit" name="action" value="rating_restart_branches" class="YY-BUTTON_MAIN">
                            Обработать категории снова
                          </button>
                        {% endif %}
                      {% else %}
                        <div class="YY-TEXT mb-2">Не обрабатываются</div>
                        <button type="submit" name="action" value="rating_restart_branches" class="YY-BUTTON_MAIN">
                          Обработать категории
                        </button>
                      {% endif %}
                    {% endif %}
                  </div>

                  <!-- GEO -->
                  <div class="mb-5">
                    <div class="YY-TEXT font-semibold mb-2">География</div>

                    {% if rating.geo.running %}
                      <div class="YY-TEXT">Обрабатывается</div>
                    {% else %}
                      {% if rating.geo.last_done_hash %}
                        {% if rating.geo.last_done_hash == rating_hashes.geo %}
                          <div class="YY-TEXT">Обработана</div>
                        {% else %}
                          <div class="YY-TEXT mb-2">Задача изменилась</div>
                          <button type="submit" name="action" value="rating_restart_geo" class="YY-BUTTON_MAIN">
                            Обработать географию снова
                          </button>
                        {% endif %}
                      {% else %}
                        <div class="YY-TEXT mb-2">Не обрабатывается</div>
                        <button type="submit" name="action" value="rating_restart_geo" class="YY-BUTTON_MAIN">
                          Обработать географию
                        </button>
                      {% endif %}
                    {% endif %}
                  </div>

                {% endif %}
              </form>





            
             
            {% if edit_task.run_processing %}
              <form method="post">
              {% csrf_token %}
              <p class="YY-TEXT font-semibold mb-3">
                Обработка задачи включена
              </p>
              <button
                type="submit"
                name="action"
                value="toggle_processing"
                class="YY-BUTTON_MAIN">
                Отключить обработку задачи
              </button>
              </form>
            {% else %}
              <form method="post">
              {% csrf_token %}
              <p class="YY-TEXT font-semibold mb-3">
                Обработка задачи отключена
              </p>
              <button
                type="submit"
                name="action"
                value="toggle_processing"
                class="YY-BUTTON_MAIN">
                Включить обработку задачи
              </button>
              </form>
            {% endif %}

          </div>
        </td>
      </tr>
    </table>
{% endif %}


<table class="YY-MAIN_TABLE">
  <tr>
    <td class="YY-MAIN_BOTTOM_TD">
        {% if tasks %}
          <div class="YY-MAIN_BOTTOM_DIV">

            <table class="w-full text-left">
              <thead>
                <tr class="YY-TH_TR">
                  <th class="YY-TH_TH w-[30%]">{% trans "Аудитория" %}</th>
                  <th class="YY-TH_TH w-[35%]">{% trans "Критерии" %}</th>
                  <th class="YY-TH_TH w-[35%]">{% trans "ТОП-15" %}</th>
                  <th class="YY-TH_TH" >{% trans "Действия" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for t in tasks %}
                  <tr class="YY-TB_TR align-top">
                    <td class="YY-TB_TD">
                  
                      {% if t.type == "sell" %}
                        <div class="YY-STATUS_GREEN mb-3">
                          {% trans "Поиск клиентов" %}
                        </div>
                      {% else %}
                        <div class="YY-STATUS_YELLOW mb-3">
                          {% trans "Поиск поставщиков / подрядчиков" %}
                        </div>
                      {% endif %}

                      <div class="mb-3 font-semibold">
                        {{ t.title }}
                      </div>
                      <div>
                        {{ t.task }}
                      </div>

                    </td>
                    <td class="YY-TB_TD">
                      <div data-tabs="crit-{{ t.id }}">
                        <div class="flex gap-3 mb-3">
                          <button type="button"
                            data-tab="branches"
                            data-active-class="YY-BUTTON_GREEN"
                            data-idle-class="YY-BUTTON_MAIN"
                            class="YY-BUTTON_GREEN">
                            {% trans "Категории" %}
                          </button>
                          <button type="button"
                            data-tab="geo"
                            data-active-class="YY-BUTTON_GREEN"
                            data-idle-class="YY-BUTTON_MAIN"
                            class="YY-BUTTON_MAIN">
                            {% trans "География" %}
                          </button>
                          <button type="button"
                            data-tab="client"
                            data-active-class="YY-BUTTON_GREEN"
                            data-idle-class="YY-BUTTON_MAIN"
                            class="YY-BUTTON_MAIN">
                            {% trans "Клиент" %}
                          </button>
                        </div>

                        <div data-panel="branches">
                          {{ t.task_branches|linebreaksbr }}
                        </div>
                        <div data-panel="geo" class="hidden">
                          {{ t.task_geo|linebreaksbr }}
                        </div>
                        <div data-panel="client" class="hidden">
                          {{ t.task_client|linebreaksbr }}
                        </div>
                      </div>
                    </td>
                    <td class="YY-TB_TD">
                      <div data-tabs="res-{{ t.id }}">
                        <div class="flex gap-3 mb-3">
                          <button type="button"
                            data-tab="cities"
                            data-active-class="YY-BUTTON_GREEN"
                            data-idle-class="YY-BUTTON_MAIN"
                            class="YY-BUTTON_GREEN">
                            {% trans "Города" %}
                          </button>
                          <button type="button"
                            data-tab="branches"
                            data-active-class="YY-BUTTON_GREEN"
                            data-idle-class="YY-BUTTON_MAIN"
                            class="YY-BUTTON_MAIN">
                            {% trans "Категории" %}
                          </button>
                        </div>
                        <div data-panel="cities">
                          {% with items=t.clar_city_items %}
                            {% if items %}
                              {% for item in items|slice:":15" %}
                                <div class="flex justify-between">
                                  <span>{{ item.value_text }}</span>
                                  <span class="text-slate-500">{{ item.rate }}</span>
                                </div>
                              {% endfor %}
                            {% else %}
                              <span class="text-slate-500 text-sm">
                                {% trans "В обработке" %}
                              </span>
                            {% endif %}
                          {% endwith %}
                        </div>
                        <div data-panel="branches" class="hidden">
                          {% with items=t.clar_branch_items %}
                            {% if items %}
                              {% for item in items|slice:":15" %}
                                <div class="flex justify-between">
                                  <span>{{ item.value_text }}</span>
                                  <span class="text-slate-500">{{ item.rate }}</span>
                                </div>
                              {% endfor %}
                            {% else %}
                              <span class="text-slate-500 text-sm">
                                {% trans "В обработке" %}
                              </span>
                            {% endif %}
                          {% endwith %}
                        </div>
                      </div>
                    </td>
                    <!-- ===== ДЕЙСТВИЯ ===== -->
                    <td class="YY-TB_TD">
                      <a href="?state=edit&id={{ t.ui_id }}" class="YY-BUTTON_TAB_MAIN mb-2 inline-block">
                        {% trans "Управлять" %}
                      </a>
                 </td>

                  </tr>
                {% endfor %}
              </tbody>
            </table>

          </div>
        {% else %}
          <div class="YY-CARD_WHITE mb-10">
            {% trans "Здесь пока нет данных" %}
          </div>
        {% endif %}
    </td>
  </tr>
</table>
{% endblock %}
