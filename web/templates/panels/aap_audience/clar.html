{% extends "panels/base.html" %}
{% load i18n %}
{% block content %}
<div class="w-[95%] max-w-none mx-auto">
<!-- FILE: web/templates/panels/aap_audience/clar.html  (–æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî 2025-12-19)
–°–º—ã—Å–ª: –ø—Ä–∏–≤–µ—Å—Ç–∏ clar.html –∫ —Å—Ç–∏–ª—é how.html –±–µ–∑ —Å—Ç–∞—Ä—ã—Ö –∫–ª–∞—Å—Å–æ–≤/inline; form –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –í–´–ö–õ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ form);
–≤–µ—Ä—Ö –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: 2 —Ä–∞–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ 50/50; —Å–ø—Ä–∞–≤–∞ –≥–æ—Ä–æ–¥–∞+–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (2 –∫–æ–ª–æ–Ω–∫–∏) —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º, –ë–ï–ó –≤–∫–ª–∞–¥–æ–∫;
–≤ —Ç–∞–±–ª–∏—Ü–µ: –≤–∫–ª–∞–¥–∫–∏ "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏/–ì–µ–æ–≥—Ä–∞—Ñ–∏—è/–ö–ª–∏–µ–Ω—Ç" –∏ –≤–∫–ª–∞–¥–∫–∏ "–ì–æ—Ä–æ–¥–∞/–ö–∞—Ç–µ–≥–æ—Ä–∏–∏"; –≤—ã–≤–æ–¥ –¢–û–ü 15; –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤/–∫–∞—Ç–µ–≥–æ—Ä–∏–π;
—Ç–µ–∫—Å—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è (mode/edit_id/task_id/delete_id) —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã -->  

  {% if form %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">

      <!-- ===================== LEFT (50%): EDIT FORM ===================== -->
      <!-- FILE: web/templates/panels/aap_audience/clar.html  (–æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî 2025-12-19)
–°–º—ã—Å–ª: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: —à–∏—Ä–∏–Ω—ã, —á–µ–∫–±–æ–∫—Å —Å–ø—Ä–∞–≤–∞, –ª–∏–º–∏—Ç —Å–ø—Ä–∞–≤–∞, textarea –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->

<!-- FILE: web/templates/panels/aap_audience/clar.html  (–æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî 2025-12-19)
–°–º—ã—Å–ª: –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –±–ª–æ–∫ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –±–ª–æ–∫): –≤—Å–µ –ø–æ–ª—è 100% –ø–æ —à–∏—Ä–∏–Ω–µ, textarea –Ω–µ –∑–∞–∂–∞—Ç—ã;
—á–µ–∫–±–æ–∫—Å —Ä—è–¥–æ–º —Å —Ç–µ–∫—Å—Ç–æ–º; subscribers_limit —Å–ø—Ä–∞–≤–∞ –∫–∞–∫ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π input —Å —Ä–∞–º–∫–æ–π; –∫–Ω–æ–ø–∫–∏ –∫–∞–∫ –≤ how.html; —Ç–µ–∫—Å—Ç—ã –ù–ï –º–µ–Ω—è–ª–∏—Å—å -->

<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">

  <form method="post" class="space-y-6">
    {% csrf_token %}
    <input type="hidden" name="mode" value="save">
    {{ form.edit_id }}

    <!-- –ê—É–¥–∏—Ç–æ—Ä–∏—è -->
    <div>
      <label for="id_title" class="block text-sm font-semibold text-slate-700 mb-2">
        {% trans "–ê—É–¥–∏—Ç–æ—Ä–∏—è" %}
      </label>
      <input
        type="text"
        name="{{ form.title.name }}"
        id="id_title"
        value="{{ form.title.value|default_if_none:'' }}"
        class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-800
               placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-[#0a5f85]/30 focus:border-[#0a5f85]"
      >
      {% if form.title.errors %}
        <div class="mt-2 text-sm text-red-600">
          {{ form.title.errors }}
        </div>
      {% endif %}
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ -->
    <div>
      <label for="id_task" class="block text-sm font-semibold text-slate-700 mb-2">
        {% trans "–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞" %}
      </label>
      <textarea
        name="{{ form.task.name }}"
        id="id_task"
        rows="8"
        class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-800
               placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-[#0a5f85]/30 focus:border-[#0a5f85]"
      >{{ form.task.value|default_if_none:"" }}</textarea>
      {% if form.task.errors %}
        <div class="mt-2 text-sm text-red-600">
          {{ form.task.errors }}
        </div>
      {% endif %}
    </div>

    <!-- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
    <div>
      <label for="id_task_branches" class="block text-sm font-semibold text-slate-700 mb-2">
        {% trans "–ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π" %}
      </label>
      <textarea
        name="{{ form.task_branches.name }}"
        id="id_task_branches"
        rows="8"
        class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-800
               placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-[#0a5f85]/30 focus:border-[#0a5f85]"
      >{{ form.task_branches.value|default_if_none:"" }}</textarea>
      {% if form.task_branches.errors %}
        <div class="mt-2 text-sm text-red-600">
          {{ form.task_branches.errors }}
        </div>
      {% endif %}
    </div>

    <!-- –ö—Ä–∏—Ç–µ—Ä–∏–∏, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –ø–æ–∏—Å–∫–∞ -->
    <div>
      <label for="id_task_geo" class="block text-sm font-semibold text-slate-700 mb-2">
        {% trans "–ö—Ä–∏—Ç–µ—Ä–∏–∏, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –ø–æ–∏—Å–∫–∞" %}
      </label>
      <textarea
        name="{{ form.task_geo.name }}"
        id="id_task_geo"
        rows="8"
        class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-800
               placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-[#0a5f85]/30 focus:border-[#0a5f85]"
      >{{ form.task_geo.value|default_if_none:"" }}</textarea>
      {% if form.task_geo.errors %}
        <div class="mt-2 text-sm text-red-600">
          {{ form.task_geo.errors }}
        </div>
      {% endif %}
    </div>

    <!-- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –æ—Ç–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div>
      <label for="id_task_client" class="block text-sm font-semibold text-slate-700 mb-2">
        {% trans "–ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –æ—Ç–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤" %}
      </label>
      <textarea
        name="{{ form.task_client.name }}"
        id="id_task_client"
        rows="8"
        class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-800
               placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-[#0a5f85]/30 focus:border-[#0a5f85]"
      >{{ form.task_client.value|default_if_none:"" }}</textarea>
      {% if form.task_client.errors %}
        <div class="mt-2 text-sm text-red-600">
          {{ form.task_client.errors }}
        </div>
      {% endif %}
    </div>

    <!-- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ -->
    <div class="flex items-center gap-3">
      <label class="text-sm font-semibold text-slate-700" for="id_run_processing">
        {% trans "–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞:" %}
      </label>
      <input
        type="checkbox"
        name="{{ form.run_processing.name }}"
        id="id_run_processing"
        class="panel-checkbox"
        {% if form.run_processing.value %}checked{% endif %}
      >
      {% if form.run_processing.errors %}
        <div class="text-sm text-red-600">
          {{ form.run_processing.errors }}
        </div>
      {% endif %}
    </div>

    <!-- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–¥–±–æ—Ä –∫–æ–º–ø–∞–Ω–∏–π -->
    <div class="flex items-center justify-between gap-6">
      <label class="text-sm font-semibold text-slate-700" for="id_subscribers_limit">
        {% trans "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–¥–±–æ—Ä –∫–æ–º–ø–∞–Ω–∏–π" %}
      </label>

      <input
        type="number"
        name="{{ form.subscribers_limit.name }}"
        id="id_subscribers_limit"
        value="{{ form.subscribers_limit.value|default_if_none:'' }}"
        min="1"
        max="1000000"
        class="w-[140px] rounded-xl border border-slate-200 bg-white px-4 py-2 text-slate-800
               focus:outline-none focus:ring-2 focus:ring-[#0a5f85]/30 focus:border-[#0a5f85]"
      >
    </div>
    {% if form.subscribers_limit.errors %}
      <div class="text-sm text-red-600">
        {{ form.subscribers_limit.errors }}
      </div>
    {% endif %}

    <!-- actions (–∫–∞–∫ –≤ how.html) -->
    <div class="flex flex-wrap gap-3 pt-2">
      <button
        type="submit"
        class="h-10 px-6 rounded-xl text-white font-semibold border border-[#084b69]"
        style="background:#0a5f85">
        {% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" %}
      </button>

      <a
        href="{% url 'audience:clar' %}"
        class="h-10 px-6 rounded-xl text-white font-semibold border border-[#084b69] flex items-center justify-center"
        style="background:#0a5f85">
        {% trans "–ó–∞–∫—Ä—ã—Ç—å" %}
      </a>
    </div>

    {% if form.non_field_errors %}
      <div class="mt-2 text-sm text-red-600">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

  </form>
</div>



      <!-- ===================== RIGHT (50%): CITIES + BRANCHES (NO TABS) ===================== -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

          <!-- ---------- CITIES ---------- -->
          <div>
            <h4 class="text-sm font-semibold text-slate-700 mb-3">{% trans "–ì–æ—Ä–æ–¥–∞ –ì–µ—Ä–º–∞–Ω–∏–∏" %}</h4>

            {% if current_task_id %}
              <div class="flex gap-2 mb-3 flex-wrap">
                <form method="post" class="inline m-0">
                  {% csrf_token %}
                  <input type="hidden" name="edit_id" value="{{ current_task_id }}">
                  <input type="hidden" name="mode" value="clear_city">
                  <input type="hidden" name="task_id" value="{{ current_task_id }}">
                  <button
                    type="submit"
                    onclick="return confirm('{% trans "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥–∞?" %}');"
                    class="px-3 h-8 flex items-center justify-center rounded-lg
                           text-red-700 bg-red-50 font-semibold text-sm
                           hover:bg-red-100 border border-red-200">
                    üóë {% trans "–£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥–∞" %}
                  </button>
                </form>
              </div>

              <p class="text-sm text-slate-700 mb-2">
                {% trans "–ì–æ—Ä–æ–¥–æ–≤:" %} {{ clar_city_count|default:0 }}
              </p>

              <div class="max-h-[800px] overflow-y-auto border border-slate-200 rounded-xl bg-slate-50 p-3 text-sm">
                {% if clar_city_items %}
                  <div class="space-y-1">
                    {% for item in clar_city_items %}
                      <div class="flex justify-between gap-3">
                        <span class="text-slate-800">{{ item.value_text }}</span>
                        <span class="text-slate-500">{{ item.rate }}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-slate-500">{% trans "–ü–æ–∫–∞ –Ω–µ—Ç –≥–æ—Ä–æ–¥–æ–≤." %}</div>
                {% endif %}
              </div>
            {% else %}
              <p class="text-sm text-slate-500">
                {% trans "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –Ω–∏–∂–µ (‚úèÔ∏è), —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≥–æ—Ä–æ–¥–∞–º–∏." %}
              </p>
            {% endif %}
          </div>

          <!-- ---------- BRANCHES ---------- -->
          <div>
            <h4 class="text-sm font-semibold text-slate-700 mb-3">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏" %}</h4>

            {% if current_task_id %}
              <div class="flex gap-2 mb-3 flex-wrap">
                <form method="post" class="inline m-0">
                  {% csrf_token %}
                  <input type="hidden" name="edit_id" value="{{ current_task_id }}">
                  <input type="hidden" name="mode" value="clear_branch">
                  <input type="hidden" name="task_id" value="{{ current_task_id }}">
                  <button
                    type="submit"
                    onclick="return confirm('{% trans "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏?" %}');"
                    class="px-3 h-8 flex items-center justify-center rounded-lg
                           text-red-700 bg-red-50 font-semibold text-sm
                           hover:bg-red-100 border border-red-200">
                    üóë {% trans "–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" %}
                  </button>
                </form>
              </div>

              <p class="text-sm text-slate-700 mb-2">
                {% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏–π:" %} {{ clar_branch_count|default:0 }}
              </p>

              <div class="max-h-[800px] overflow-y-auto border border-slate-200 rounded-xl bg-slate-50 p-3 text-sm">
                {% if clar_branch_items %}
                  <div class="space-y-1">
                    {% for item in clar_branch_items %}
                      <div class="flex justify-between gap-3">
                        <span class="text-slate-800">{{ item.value_text }}</span>
                        <span class="text-slate-500">{{ item.rate }}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-slate-500">{% trans "–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π." %}</div>
                {% endif %}
              </div>
            {% else %}
              <p class="text-sm text-slate-500">
                {% trans "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –Ω–∏–∂–µ (‚úèÔ∏è), —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±—Ä–∞–Ω—á–∞–º–∏." %}
              </p>
            {% endif %}
          </div>

        </div>
      </div>

    </div>
  {% endif %}

  <!-- ===================== TABLE (same width as top) ===================== -->
  {% if tasks %}
    <div class="mt-6">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr class="text-left text-slate-700 font-semibold">
                <th class="px-4 py-3 w-[30%]">{% trans "–ê—É–¥–∏—Ç–æ—Ä–∏—è –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞" %}</th>
                <th class="px-4 py-3 w-[35%]">{% trans "–ö—Ä–∏—Ç–µ—Ä–∏–∏" %}</th>
                <th class="px-4 py-3 w-[35%]">{% trans "–¢–û–ü 15 –≥–æ—Ä–æ–¥–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" %}</th>
                <th class="px-4 py-3 w-[110px] text-right">{% trans "–î–µ–π—Å—Ç–≤–∏—è" %}</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-slate-200">
              {% for t in tasks %}
                <tr class="align-top">
                  <td class="px-4 py-3">
                    <strong>{{ t.title }}</strong><br><br>
                    <b>{% trans "–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞" %}</b><br>
                    {{ t.task|linebreaksbr }}

                    <br><br>
                    <div class="text-xs text-slate-600 space-y-1">
                      <div>
                        {% trans "–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞:" %}
                        {% if t.run_processing %}{% trans "–¥–∞" %}{% else %}{% trans "–Ω–µ—Ç" %}{% endif %}
                      </div>
                      <div>
                        {% trans "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π:" %} {{ t.subscribers_limit }}
                      </div>
                    </div>
                  </td>

                  <!-- ===== CRITERIA TABS: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ / –ì–µ–æ–≥—Ä–∞—Ñ–∏—è / –ö–ª–∏–µ–Ω—Ç ===== -->
                  <td class="px-4 py-3 text-slate-700">
                    <div class="flex gap-2 mb-2 text-xs font-semibold" data-tab-group="crit-{{ t.id }}">
                      <button type="button"
                        class="tab-btn px-2 py-1 rounded bg-slate-200 text-slate-800"
                        data-target="crit-branches-{{ t.id }}">
                        {% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏" %}
                      </button>
                      <button type="button"
                        class="tab-btn px-2 py-1 rounded bg-slate-100 text-slate-600"
                        data-target="crit-geo-{{ t.id }}">
                        {% trans "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è" %}
                      </button>
                      <button type="button"
                        class="tab-btn px-2 py-1 rounded bg-slate-100 text-slate-600"
                        data-target="crit-client-{{ t.id }}">
                        {% trans "–ö–ª–∏–µ–Ω—Ç" %}
                      </button>
                    </div>

                    <div class="tab-scope text-sm">
                      <div id="crit-branches-{{ t.id }}" class="tab-content">
                        {{ t.task_branches|linebreaksbr }}
                      </div>
                      <div id="crit-geo-{{ t.id }}" class="tab-content hidden">
                        {{ t.task_geo|linebreaksbr }}
                      </div>
                      <div id="crit-client-{{ t.id }}" class="tab-content hidden">
                        {{ t.task_client|linebreaksbr }}
                      </div>
                    </div>
                  </td>

                  <!-- ===== RESULTS TABS: –ì–æ—Ä–æ–¥–∞ / –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (TOP 15) ===== -->
                  <td class="px-4 py-3 text-slate-700">
                    <div class="flex gap-2 mb-2 text-xs font-semibold" data-tab-group="res-{{ t.id }}">
                      <button type="button"
                        class="tab-btn px-2 py-1 rounded bg-slate-200 text-slate-800"
                        data-target="res-cities-{{ t.id }}">
                        {% trans "–ì–æ—Ä–æ–¥–∞" %}
                      </button>
                      <button type="button"
                        class="tab-btn px-2 py-1 rounded bg-slate-100 text-slate-600"
                        data-target="res-branches-{{ t.id }}">
                        {% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏" %}
                      </button>
                    </div>

                    <div class="tab-scope">
                      <div id="res-cities-{{ t.id }}" class="tab-content">
                        {% with items=t.clar_city_items %}
                          {% if items %}
                            <div class="text-xs text-slate-600 mb-2">
                              {% trans "–ì–æ—Ä–æ–¥–æ–≤:" %} {{ items|length }}
                            </div>
                            <div class="border border-slate-200 rounded-xl bg-slate-50 p-3 text-sm space-y-1">
                              {% for item in items|slice:":15" %}
                                <div class="flex justify-between gap-3">
                                  <span class="text-slate-800">{{ item.value_text }}</span>
                                  <span class="text-slate-500">{{ item.rate }}</span>
                                </div>
                              {% endfor %}
                            </div>
                          {% else %}
                            <span class="text-sm text-slate-500">{% trans "–ì–æ—Ä–æ–¥–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ." %}</span>
                          {% endif %}
                        {% endwith %}
                      </div>

                      <div id="res-branches-{{ t.id }}" class="tab-content hidden">
                        {% with items=t.clar_branch_items %}
                          {% if items %}
                            <div class="text-xs text-slate-600 mb-2">
                              {% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏–π:" %} {{ items|length }}
                            </div>
                            <div class="border border-slate-200 rounded-xl bg-slate-50 p-3 text-sm space-y-1">
                              {% for item in items|slice:":15" %}
                                <div class="flex justify-between gap-3">
                                  <span class="text-slate-800">{{ item.value_text }}</span>
                                  <span class="text-slate-500">{{ item.rate }}</span>
                                </div>
                              {% endfor %}
                            </div>
                          {% else %}
                            <span class="text-sm text-slate-500">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã." %}</span>
                          {% endif %}
                        {% endwith %}
                      </div>
                    </div>
                  </td>

                  <td class="px-4 py-3 text-right align-top">
                    <div class="flex flex-col items-end gap-2">

                      <a
                        href="?edit={{ t.id }}"
                        class="px-3 py-1.5 rounded-md text-sm font-semibold
                              text-[#0a5f85] bg-[#eff6fb]
                              hover:bg-[#e3f2f9] border border-slate-200">
                        {% trans "–ò–∑–º–µ–Ω–∏—Ç—å" %}
                      </a>

                      <form method="post" class="m-0">
                        {% csrf_token %}
                        <input type="hidden" name="mode" value="delete">
                        <input type="hidden" name="delete_id" value="{{ t.id }}">
                        <button
                          type="submit"
                          onclick="return confirm('{% trans "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?" %}');"
                          class="px-3 py-1.5 rounded-md text-sm font-semibold
                                text-red-700 bg-red-50
                                hover:bg-red-100 border border-red-200">
                          {% trans "–£–¥–∞–ª–∏—Ç—å" %}
                        </button>
                      </form>

                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      </div>
    </div>
  {% else %}
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mt-6">
      <p class="text-slate-700">
        {% trans "–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞¬ª." %}
      </p>
    </div>
  {% endif %}

</div>

<script>
(function () {
  document.addEventListener("click", function (e) {
    const btn = e.target.closest(".tab-btn");
    if (!btn) return;

    const groupEl = btn.closest("[data-tab-group]");
    if (!groupEl) return;

    const targetId = btn.getAttribute("data-target");
    if (!targetId) return;

    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥ –∫–Ω–æ–ø–æ–∫ –≤ —Ä–∞–º–∫–∞—Ö –≥—Ä—É–ø–ø—ã
    groupEl.querySelectorAll(".tab-btn").forEach(b => {
      b.classList.remove("bg-slate-200", "text-slate-800");
      b.classList.add("bg-slate-100", "text-slate-600");
    });
    btn.classList.add("bg-slate-200", "text-slate-800");

    // –ò—â–µ–º –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (tab-scope) —Ä—è–¥–æ–º —Å –≥—Ä—É–ø–ø–æ–π
    const scope = groupEl.parentElement.querySelector(".tab-scope") || groupEl.parentElement;
    scope.querySelectorAll(".tab-content").forEach(div => div.classList.add("hidden"));

    const target = scope.querySelector("#" + CSS.escape(targetId));
    if (target) target.classList.remove("hidden");
  });
})();
</script>
{% endblock %}
