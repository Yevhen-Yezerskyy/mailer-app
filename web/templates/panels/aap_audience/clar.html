<!-- FILE: web/templates/panels/aap_audience/clar.html  (–Ω–æ–≤–æ–µ) 2025-12-12 -->

{% extends "panels/base.html" %}

{% block title %}–£—Ç–æ—á–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ ‚Äî Serenity Mailer{% endblock %}

{% block sidebar_menu %}
  {% include "panels/aap_audience/menu_left.html" %}
{% endblock %}

{% block content %}

{# –í–µ—Ä—Ö–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å —Ñ–æ—Ä–º–æ–π (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) #}
{% if form %}
  <div class="panel-card" style="margin-bottom: 24px; width: 95%; max-width: none; margin-left: auto; margin-right: auto;">

    <h3 class="panel-card-title" style="margin-bottom: 12px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h3>

    <div style="display: grid; grid-template-columns: 40% 30% 30%; gap: 20px;">

      {# –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî —Å–∞–º–∞ —Ñ–æ—Ä–º–∞ #}
      <div>

        <form method="post" class="panel-form">
          {% csrf_token %}
          <input type="hidden" name="mode" value="save">
          {{ form.edit_id }}

          <div class="panel-form-group">
            <label class="panel-form-label" for="{{ form.title.id_for_label }}">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            {{ form.title }}
          </div>

          <div class="panel-form-group">
            <label class="panel-form-label" for="{{ form.task.id_for_label }}">–û—Å–Ω–æ–≤–Ω–æ–π task</label>
            {{ form.task }}
          </div>

          <div class="panel-form-group">
            <label class="panel-form-label" for="{{ form.task_branches.id_for_label }}">Branches-–∑–∞–¥–∞—á–∞</label>
            {{ form.task_branches }}
          </div>

          <div class="panel-form-group">
            <label class="panel-form-label" for="{{ form.task_geo.id_for_label }}">Geo-–∑–∞–¥–∞—á–∞</label>
            {{ form.task_geo }}
          </div>

          <div class="panel-form-group">
            <label class="panel-form-label" for="{{ form.task_client.id_for_label }}">Client-–∑–∞–¥–∞—á–∞</label>
            {{ form.task_client }}
          </div>

          <div class="panel-form-actions" style="display: flex; gap: 12px;">

            <button type="submit"
                    class="panel-btn panel-btn-primary"
                    style="background: #2563eb; color: white; padding: 8px 18px; border-radius: 8px;">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>

            <a href="{% url 'audience:clar' %}"
               class="panel-btn"
               style="background: #e5e7eb; padding: 8px 18px; border-radius: 8px; color: #111;">
              ‚úñ –ó–∞–∫—Ä—ã—Ç—å
            </a>

          </div>

        </form>

      </div>

      {# –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –≥–æ—Ä–æ–¥–∞ #}
      <div>
        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">–ì–æ—Ä–æ–¥–∞</h4>

        {% if current_task_id %}
          <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
            <form method="post" style="display: inline;">
              {% csrf_token %}
              <input type="hidden" name="edit_id" value="{{ current_task_id }}">
              <input type="hidden" name="mode" value="gen_city">
              <input type="hidden" name="task_id" value="{{ current_task_id }}">
              <button type="submit"
                      class="panel-btn panel-btn-primary"
                      style="font-size: 13px; padding: 6px 12px; border-radius: 8px;">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥–∞
              </button>
            </form>

            <form method="post" style="display: inline;">
              {% csrf_token %}
              <input type="hidden" name="edit_id" value="{{ current_task_id }}">
              <input type="hidden" name="mode" value="clear_city">
              <input type="hidden" name="task_id" value="{{ current_task_id }}">
              <button type="submit"
                      class="panel-btn"
                      style="font-size: 13px; padding: 6px 12px; border-radius: 8px; background: #fee2e2; color: #991b1b;">
                üóë –£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥–∞
              </button>
            </form>
          </div>

          <p style="font-size: 13px; margin-bottom: 6px;">
            –ì–æ—Ä–æ–¥–æ–≤: {{ clar_city_count|default:0 }}
          </p>

          <div style="max-height: 800px; max-width: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 10px; font-size: 13px;">
            {% if clar_city_items %}
              {% for item in clar_city_items %}
                <div style="display: flex; justify-content: space-between; gap: 8px; padding: 2px 0;">
                  <span>{{ item.value }}</span>
                  <span style="opacity: 0.7;">{{ item.rate }}</span>
                </div>
              {% endfor %}
            {% else %}
              <div style="opacity: 0.7;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤.</div>
            {% endif %}
          </div>
        {% else %}
          <p style="font-size: 13px; opacity: 0.7;">
            –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –Ω–∏–∂–µ (‚úèÔ∏è), —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≥–æ—Ä–æ–¥–∞–º–∏.
          </p>
        {% endif %}
      </div>

      {# –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –±—Ä–∞–Ω—á–∏ #}
      <div>
        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">–ë—Ä–∞–Ω—á–∏</h4>

        {% if current_task_id %}
          <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
            <form method="post" style="display: inline;">
              {% csrf_token %}
              <input type="hidden" name="edit_id" value="{{ current_task_id }}">
              <input type="hidden" name="mode" value="gen_branch">
              <input type="hidden" name="task_id" value="{{ current_task_id }}">
              <button type="submit"
                      class="panel-btn panel-btn-primary"
                      style="font-size: 13px; padding: 6px 12px; border-radius: 8px;">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –±—Ä–∞–Ω—á–∏
              </button>
            </form>

            <form method="post" style="display: inline;">
            <input type="hidden" name="edit_id" value="{{ current_task_id }}">
              {% csrf_token %}
              <input type="hidden" name="mode" value="clear_branch">
              <input type="hidden" name="task_id" value="{{ current_task_id }}">
              <button type="submit"
                      class="panel-btn"
                      style="font-size: 13px; padding: 6px 12px; border-radius: 8px; background: #fee2e2; color: #991b1b;">
                üóë –£–¥–∞–ª–∏—Ç—å –±—Ä–∞–Ω—á–∏
              </button>
            </form>
          </div>

          <p style="font-size: 13px; margin-bottom: 6px;">
            –ë—Ä–∞–Ω—á–µ–π: {{ clar_branch_count|default:0 }}
          </p>

          <div style="max-height: 800px; max-width: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 10px; font-size: 13px;">
            {% if clar_branch_items %}
              {% for item in clar_branch_items %}
                <div style="display: flex; justify-content: space-between; gap: 8px; padding: 2px 0;">
                  <span>{{ item.value }}</span>
                  <span style="opacity: 0.7;">{{ item.rate }}</span>
                </div>
              {% endfor %}
            {% else %}
              <div style="opacity: 0.7;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±—Ä–∞–Ω—á–µ–π.</div>
            {% endif %}
          </div>
        {% else %}
          <p style="font-size: 13px; opacity: 0.7;">
            –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –Ω–∏–∂–µ (‚úèÔ∏è), —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±—Ä–∞–Ω—á–∞–º–∏.
          </p>
        {% endif %}
      </div>

    </div>
  </div>
{% endif %}


<!-- FILE: web/templates/panels/aap_audience/clar.html  (—Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã) 2025-12-12 -->

{# –ù–∏–∂–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π –∑–∞–¥–∞—á #}
{% if tasks %}
  <div class="panel-card" style="margin-top: 24px; width: 95%; max-width: none; margin-left: auto; margin-right: auto;">
    <h3 class="panel-card-title" style="margin-bottom: 12px;">–ó–∞–¥–∞—á–∏ HOW</h3>

    <div class="panel-table-wrapper">
      <table class="panel-table">
        <thead>
          <tr>
            <th style="width: 25%;">–ù–∞–∑–≤–∞–Ω–∏–µ + Task</th>
            <th style="width: 25%;">Branches / Geo / Client</th>
            <th style="width: 25%;">–ì–æ—Ä–æ–¥–∞ (—Ç–æ–ø-50)</th>
            <th style="width: 25%;">–ë—Ä–∞–Ω—á–∏ (—Ç–æ–ø-50)</th>
            <th style="width: 110px; text-align: right;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tasks %}
            <tr>
              <td>
                <strong>{{ t.title }}</strong><br><br>
                <b>–û—Å–Ω–æ–≤–Ω–æ–π task</b><br><br>
                {{ t.task|linebreaksbr }}
              </td>
              <td>
                <b>–ë—Ä–∞–Ω—á–∏ task</b><br><br>
                {{ t.task_branches|linebreaksbr }}<br><br><br>
                <b>–ì–µ–æ task</b><br><br>
                {{ t.task_geo|linebreaksbr }}<br><br><br>
                <b>Client task</b><br><br><br>
                {{ t.task_client|linebreaksbr }}
              </td>

              {# –ö–æ–ª–æ–Ω–∫–∞ 3 ‚Äî –≥–æ—Ä–æ–¥–∞ #}
              <td style="font-size: 12px; vertical-align: top;">
                {% with items=t.clar_city_items %}
                  {% if items %}
                    <div style="margin-bottom: 4px;">
                      –ì–æ—Ä–æ–¥–æ–≤: {{ items|length }}
                    </div>
                    <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px;">
                      {% for item in items|slice:":50" %}
                        <div style="display: flex; justify-content: space-between; gap: 6px;">
                          <span>{{ item.value }}</span>
                          <span style="opacity: 0.65;">{{ item.rate }}</span>
                        </div>
                      {% endfor %}
                      {% if items|length > 50 %}
                        <div style="text-align: center; opacity: 0.7; margin-top: 4px;">...</div>
                        <div style="text-align: center; opacity: 0.7;">...</div>
                      {% endif %}
                    </div>
                  {% else %}
                    <span style="opacity: 0.6;">–ì–æ—Ä–æ–¥–∞ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã.</span>
                  {% endif %}
                {% endwith %}
              </td>

              {# –ö–æ–ª–æ–Ω–∫–∞ 4 ‚Äî –±—Ä–∞–Ω—á–∏ #}
              <td style="font-size: 12px; vertical-align: top;">
                {% with items=t.clar_branch_items %}
                  {% if items %}
                    <div style="margin-bottom: 4px;">
                      –ë—Ä–∞–Ω—á–µ–π: {{ items|length }}
                    </div>
                    <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px;">
                      {% for item in items|slice:":50" %}
                        <div style="display: flex; justify-content: space-between; gap: 6px;">
                          <span>{{ item.value }}</span>
                          <span style="opacity: 0.65;">{{ item.rate }}</span>
                        </div>
                      {% endfor %}
                      {% if items|length > 50 %}
                        <div style="text-align: center; opacity: 0.7; margin-top: 4px;">...</div>
                        <div style="text-align: center; opacity: 0.7;">...</div>
                      {% endif %}
                    </div>
                  {% else %}
                    <span style="opacity: 0.6;">–ë—Ä–∞–Ω—á–∏ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã.</span>
                  {% endif %}
                {% endwith %}
              </td>

              <td style="text-align: right;">
                <div style="display: inline-flex; gap: 8px; align-items: center;">

                  {# —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å #}
                  <a href="?edit={{ t.id }}"
                     class="panel-link task-edit-link"
                     style="font-size: 13px;"
                     title="–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É">
                    ‚úèÔ∏è
                  </a>

                  {# —É–¥–∞–ª–∏—Ç—å #}
                  <form method="post" style="margin: 0; display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="mode" value="delete">
                    <input type="hidden" name="delete_id" value="{{ t.id }}">
                    <button type="submit"
                            class="panel-link"
                            style="background: none; border: none; padding-left: 4px; font-size: 13px; color: #b91c1c; cursor: pointer;"
                            title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É"
                            onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?');">
                      üóëÔ∏è
                    </button>
                  </form>

                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="panel-card" style="margin-top: 24px;">
    <p>–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ö–∞–∫ –∏—â–µ–º?¬ª.</p>
  </div>
{% endif %}


{% endblock %}
