# FILE: config/nginx/conf.d/30-serenity-stat.conf
# DATE: 2026-02-21
# PURPOSE: serenity-mail STAT domains with ACME on :80 and static HTML on :443.

map $arg_smrel $log_smrel {
    default 0;
    ""      0;
    ~.+     1;
}

log_format smrel '$time_iso8601\t$arg_smrel';

server {
    listen 80;
    listen [::]:80;
    server_name stat.serenity-mail.com stat.serenity-mail.de;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name stat.serenity-mail.com stat.serenity-mail.de;

    ssl_certificate     /etc/letsencrypt/live/serenity-mail.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/serenity-mail.com/privkey.pem;

    access_log /host-logs/smrel/smrel.log smrel if=$log_smrel;
    access_log /serenity-logs/smrel/smrel.log smrel if=$log_smrel;

    default_type text/html;
    add_header Cache-Control "no-store";

    return 200 '<html><head><title>Serenity Mailer Stat</title></head><body><h2>Serenity Mailer Stat</h2></body></html>';
}
