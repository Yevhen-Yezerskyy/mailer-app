# FILE: docker-compose.yml  (новое) 2025-12-11

services:
  # ------------ POSTGRES ------------
  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: mailersys
      POSTGRES_USER: mailersys_user
      POSTGRES_PASSWORD: secret
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - webnet

  # ------------ DJANGO (DEV) ------------
  mailer-web:
    image: python:3.12
    container_name: mailer-web
    working_dir: /app/web            # корень Django внутри общего репозитория
    restart: unless-stopped
    user: "1001:1001"
    depends_on:
      - mailer-db

    environment:
      # DB
      - DB_HOST=mailer-db
      - DB_PORT=5432
      - DB_NAME=mailersys
      - DB_USER=mailersys_user
      - DB_PASSWORD=secret

      # Python path — оба аппа доступны одинаково локально и в контейнере
      - PYTHONPATH=/app

      # API key (если есть в окружении хоста — прокинется)
      - OPENAI_API_KEY

    volumes:
      # Монтируем ВЕСЬ проект в контейнер
      - ./:/app

      # статика остаётся volume, чтобы collectstatic мог записывать
      - mailer-static:/app/web/staticfiles

    ports:
      - "8000:8000"

    command: >
      /app/.venv/bin/gunicorn mailer_web.wsgi:application
      --bind 0.0.0.0:8000
      --reload
      --workers 1
      --timeout 180
      --graceful-timeout 30
      --worker-tmp-dir /dev/shm

    networks:
      - webnet

volumes:
  mailer-db-data:
  mailer-static:

networks:
  webnet:
    external: true
