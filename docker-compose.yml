# FILE: docker-compose.yml
# DATE: 2026-02-21
# PURPOSE: Incremental compose bootstrap with one-shot secrets env initializer and unified service runner.

services:
  mailer-set-env:
    build:
      context: .
      dockerfile: config/docker/Dockerfile_mailer_python
    image: mailer-python:latest
    container_name: mailer-set-env
    working_dir: /app
    restart: unless-stopped
    stop_signal: SIGKILL
    stop_grace_period: 0s
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - ./config/sh/init_set_env.sh:/usr/local/bin/init_set_env.sh:ro
      - ./config/sh/trim_host_logs.sh:/usr/local/bin/trim_host_logs.sh:ro
      - mailer-app-prod:/app
      - serenity-secrets:/run/serenity-secrets
    command:
      - /bin/sh
      - /usr/local/bin/init_set_env.sh

  mailer-tools:
    image: mailer-python:latest
    container_name: mailer-tools
    working_dir: /app
    restart: unless-stopped
    stop_signal: SIGKILL
    stop_grace_period: 0s
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-redis:
        condition: service_started
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - serenity-redis-run:/app/run/redis
      - serenity-redis-run:/app-dev/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
      - /home/eee/.ssh:/root/.ssh:ro
      - ./:/app-dev
    command: ["/app/config/sh/with-secrets.sh", "sleep", "infinity"]

  mailer-redis:
    image: redis:7-alpine
    container_name: mailer-redis
    restart: unless-stopped
    command: >
      /bin/sh -c "exec redis-server /etc/redis/redis.conf"
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - ./config/redis/redis-prod.conf:/etc/redis/redis.conf:ro
      - serenity-redis-run:/app/run/redis

  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-db-data:/var/lib/postgresql/data
      - mailer-app-prod:/app:ro
      - serenity-secrets:/run/serenity-secrets:ro
    entrypoint: ["/app/config/sh/with-secrets.sh", "/bin/sh", "-c"]
    command:
      - |
        set -e
        mkdir -p /host-logs/postgres
        touch /host-logs/postgres/postgresql.log
        chown postgres:postgres /host-logs/postgres /host-logs/postgres/postgresql.log
        chmod 777 /host-logs/postgres
        chmod 640 /host-logs/postgres/postgresql.log
        exec docker-entrypoint.sh postgres \
          -c shared_preload_libraries=pg_stat_statements \
          -c pg_stat_statements.track=all \
          -c pg_stat_statements.max=10000 \
          -c logging_collector=on \
          -c log_destination=stderr \
          -c log_directory='/host-logs/postgres' \
          -c log_filename='postgresql.log' \
          -c log_truncate_on_rotation=off \
          -c log_rotation_age=0 \
          -c log_rotation_size=0 \
          -c log_min_messages=warning \
          -c log_min_error_statement=error \
          -c log_min_duration_statement=1000
    ports:
      - "5433:5432"

  mailer-web:
    image: mailer-python:latest
    container_name: mailer-web
    working_dir: /app/web
    restart: unless-stopped
    user: "1001:1001"
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      DEBUG: "1"
      DJANGO_INSTANCE: "dev"
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - ./:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    ports:
      - "8000:8000"
    command: ["/app/config/sh/with-secrets.sh", "python", "manage.py", "runserver", "0.0.0.0:8000"]

  mailer-web-prod:
    image: mailer-python:latest
    container_name: mailer-web-prod
    working_dir: /app/web
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      DEBUG: "0"
      DJANGO_INSTANCE: "prod"
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    ports:
      - "8001:8000"
    command:
      - /app/config/sh/with-secrets.sh
      - /bin/sh
      - -c
      - |
        set -e
        mkdir -p /host-logs/django-prod
        exec gunicorn mailer_web.wsgi:application \
          --bind 0.0.0.0:8000 \
          --workers 2 \
          --timeout 120 \
          --access-logfile /host-logs/django-prod/access.log \
          --error-logfile /host-logs/django-prod/error.log \
          --capture-output \
          --log-level info

  mailer-web-admin:
    image: mailer-python:latest
    container_name: mailer-web-admin
    working_dir: /app/web-admin
    restart: unless-stopped
    user: "1001:1001"
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      DEBUG: "1"
      DJANGO_INSTANCE: "admin-dev"
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - ./:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    ports:
      - "8002:8000"
    command: ["/app/config/sh/with-secrets.sh", "python", "manage.py", "runserver", "0.0.0.0:8000"]

  mailer-web-admin-prod:
    image: mailer-python:latest
    container_name: mailer-web-admin-prod
    working_dir: /app/web-admin
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      DEBUG: "0"
      DJANGO_INSTANCE: "admin-prod"
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    ports:
      - "8003:8000"
    command:
      - /app/config/sh/with-secrets.sh
      - /bin/sh
      - -c
      - |
        set -e
        mkdir -p /host-logs/django-admin-prod
        exec gunicorn web_admin.wsgi:application \
          --bind 0.0.0.0:8000 \
          --workers 2 \
          --timeout 120 \
          --access-logfile /host-logs/django-admin-prod/access.log \
          --error-logfile /host-logs/django-admin-prod/error.log \
          --capture-output \
          --log-level info

  mailer-engine-cb-prod:
    image: mailer-python:latest
    container_name: mailer-engine-cb-prod
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.15"
    command:
      [
        "/app/config/sh/with-secrets.sh",
        "python",
        "-m",
        "engine.core_prepare.prepare_cb_processor"
      ]

  mailer-engine-val-prod:
    image: mailer-python:latest
    container_name: mailer-engine-val-prod
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.15"
    command:
      [
        "/app/config/sh/with-secrets.sh",
        "python",
        "-m",
        "engine.core_validate.val_processor"
      ]

  mailer-engine-exp-prod:
    image: mailer-python:latest
    container_name: mailer-engine-exp-prod
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.15"
    command:
      [
        "/app/config/sh/with-secrets.sh",
        "python",
        "-m",
        "engine.core_validate.val_expand_processor"
      ]

  mailer-engine-rate-prod:
    image: mailer-python:latest
    container_name: mailer-engine-rate-prod
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.15"
    command:
      [
        "/app/config/sh/with-secrets.sh",
        "python",
        "-m",
        "engine.core_rate.rate_contacts_processor"
      ]

  mailer-engine-cr-prod:
    image: mailer-python:latest
    container_name: mailer-engine-cr-prod
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.10"
    command:
      [
        "/app/config/sh/with-secrets.sh",
        "python",
        "-m",
        "engine.crawler.cr_processor"
      ]

  mailer-engine-stat-prod:
    image: mailer-python:latest
    container_name: mailer-engine-stat-prod
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.10"
    command:
      [
        "/app/config/sh/with-secrets.sh",
        "python",
        "-m",
        "engine.core_stats.stat_processor"
      ]

  mailer-engine-sender-prod:
    image: mailer-python:latest
    container_name: mailer-engine-sender-prod
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      PYTHONPATH: /app
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.10"
    command:
      [
        "/app/config/sh/with-secrets.sh",
        "python",
        "-m",
        "engine.core_sender.sender"
      ]

  nginx:
    image: nginx:1.26
    container_name: serenity-nginx
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 4096
        hard: 4096
    depends_on:
      certbot-init:
        condition: service_completed_successfully
      mailer-web:
        condition: service_started
      mailer-web-prod:
        condition: service_started
      mailer-web-admin:
        condition: service_started
      mailer-web-admin-prod:
        condition: service_started
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./config/nginx/includes:/etc/nginx/includes:ro
      - mailer-app-prod:/app
      - mailer-static:/var/www/mail-static:ro
      - mailer-media:/var/www/mail-media
      - certbot-www:/var/www/certbot
      - certbot-etc:/etc/letsencrypt
    command:
      - /bin/sh
      - -c
      - |
        set -e
        mkdir -p /host-logs/nginx
        mkdir -p /serenity-logs/nginx
        mkdir -p /host-logs/smrel
        mkdir -p /serenity-logs/smrel
        chmod 777 /host-logs/nginx /serenity-logs/nginx /host-logs/smrel /serenity-logs/smrel || true
        exec nginx -g 'daemon off;'

  certbot-init:
    image: certbot/certbot:latest
    container_name: serenity-certbot-init
    restart: "no"
    environment:
      CERTBOT_MODE: "init"
      CERTBOT_EMAIL: "yevhen.yezerskyy@gmail.com"
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./config/sh/certbot_run.sh:/usr/local/bin/certbot_run.sh:ro
      - certbot-www:/var/www/certbot
      - certbot-etc:/etc/letsencrypt
    ports:
      - "80:80"
      - "443:443"
    entrypoint: ["/bin/sh", "/usr/local/bin/certbot_run.sh"]

  certbot:
    image: certbot/certbot:latest
    container_name: serenity-certbot
    restart: unless-stopped
    pid: "service:nginx"
    stop_signal: SIGKILL
    stop_grace_period: 0s
    depends_on:
      nginx:
        condition: service_started
    environment:
      CERTBOT_MODE: "renew"
      CERTBOT_EMAIL: "yevhen.yezerskyy@gmail.com"
      CERTBOT_RENEW_INTERVAL_SECONDS: "43200"
    volumes:
      - ./logs:/host-logs
      - serenity-logs:/serenity-logs
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./config/sh/certbot_run.sh:/usr/local/bin/certbot_run.sh:ro
      - certbot-www:/var/www/certbot
      - certbot-etc:/etc/letsencrypt
    entrypoint: ["/bin/sh", "/usr/local/bin/certbot_run.sh"]

volumes:
  mailer-db-data:
    external: true
  mailer-app-prod:
    external: true
  mailer-static:
    external: true
  mailer-media:
    external: true
  serenity-redis-run:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=64m,uid=1001,gid=1001,mode=0777"
  serenity-secrets:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=16m,uid=0,gid=0,mode=0777"
  serenity-logs:
  certbot-www:
  certbot-etc:
