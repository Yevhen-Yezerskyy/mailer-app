# FILE: docker-compose.yml  (обновлено — 2026-01-05)
# PURPOSE: DEV compose + Redis через UNIX-socket ВНУТРИ проекта (./run/redis/redis.sock),
#          чтобы и контейнеры, и хост видели один и тот же файл сокета по одному пути в проекте.

services:
  # ------------ POSTGRES ------------
  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: mailersys
      POSTGRES_USER: mailersys_user
      POSTGRES_PASSWORD: secret
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - webnet

  # ------------ REDIS (UNIX SOCKET IN PROJECT) ------------
  mailer-redis:
    image: redis:7-alpine
    container_name: mailer-redis
    restart: unless-stopped
    command:
      - redis-server
      - /app/run/redis/redis.conf
    volumes:
      - ./:/app
    networks:
      - webnet

  # ------------ DJANGO (DEV, RUNSERVER) ------------
  mailer-web:
    build:
      context: .
      dockerfile: Dockerfile_Django
    container_name: mailer-web
    working_dir: /app/web
    restart: unless-stopped
    user: "1001:1001"
    depends_on:
      - mailer-db

    environment:
      # DB
      DB_HOST: mailer-db
      DB_PORT: 5432
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret

      # DEV
      DEBUG: "1"
      PYTHONPATH: /app

      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

    volumes:
      # весь проект — live
      - ./:/app

    ports:
      - "8000:8000"

    command: >
      /app/.venv/bin/python manage.py runserver 0.0.0.0:8000

    networks:
      - webnet

volumes:
  mailer-db-data:

networks:
  webnet:
    external: true
