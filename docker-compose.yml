# FILE: docker-compose.yml

services:
  # ------------ POSTGRES ------------
  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: mailersys
      POSTGRES_USER: mailersys_user
      POSTGRES_PASSWORD: secret
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
    # наружу даём НЕ стандартный порт, чтобы не пересечься с другим postgres
    ports:
      - "5433:5432"
    networks:
      - webnet

  # ------------ DJANGO (DEV) ------------
  mailer-web:
    image: python:3.12
    container_name: mailer-web
    working_dir: /app
    restart: unless-stopped
    user: "1001:1001"
    depends_on:
      - mailer-db

    # тут ЗАМЕНИЛ на список, чтобы аккуратно прокинуть OPENAI_API_KEY из среды машинки
    environment:
      - DB_HOST=mailer-db
      - DB_PORT=5432
      - DB_NAME=mailersys
      - DB_USER=mailersys_user
      - DB_PASSWORD=secret
      - PYTHONPATH=/app:/engine
      # берём значение переменной OPENAI_API_KEY с хоста, если оно там есть
      - OPENAI_API_KEY

    volumes:
      - ./web:/app          # твой Django-проект
      - ./engine:/engine    # движок с GPT-клиентом рядом
      - ./logs:/logs    # движок с GPT-клиентом рядом
      - mailer-static:/app/staticfiles

    ports:
      - "8000:8000"        # http://сервер:8000

    # как и было: gunicorn из venv
    command:  >  
      /app/.venv/bin/gunicorn mailer_web.wsgi:application
      --bind 0.0.0.0:8000
      --reload
      --workers 1

    networks:
      - webnet

volumes:
  mailer-db-data:
  mailer-static:

networks:
  webnet:
    external: true
