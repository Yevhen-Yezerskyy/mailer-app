# FILE: docker-compose.yml
# DATE: 2026-02-21
# PURPOSE: Incremental compose bootstrap with one-shot secrets env initializer and unified service runner.

services:
  mailer-set-env:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_mailer_python
    image: mailer-python:latest
    container_name: mailer-set-env
    working_dir: /app
    restart: "no"
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
    volumes:
      - mailer-app-prod:/app
      - serenity-secrets:/run/serenity-secrets
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        umask 077
        python -m config.load_keys --seal-only
        python -m config.load_keys --load-only --print-export > /run/serenity-secrets/runtime.env

  mailer-tools:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_mailer_python
    image: mailer-python:latest
    container_name: mailer-tools
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_completed_successfully
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
      - /home/eee/.ssh:/root/.ssh:ro
      - serenity-stat:/serenity-stat
      - ./:/app-dev
    command: ["/app/config/sh/with-secrets.sh", "sleep", "infinity"]

volumes:
  mailer-app-prod:
    external: true
  mailer-static:
    external: true
  mailer-media:
    external: true
  serenity-stat:
    external: true
  serenity-redis-run:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=64m,uid=1001,gid=1001,mode=0777"
  serenity-secrets:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=16m,uid=0,gid=0,mode=0777"
