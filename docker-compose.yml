# FILE: docker-compose.yml
# DATE: 2026-02-21
# PURPOSE: Incremental compose bootstrap with one-shot secrets env initializer and unified service runner.

services:
  mailer-set-env:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_mailer_python
    image: mailer-python:latest
    container_name: mailer-set-env
    working_dir: /app
    restart: unless-stopped
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
    volumes:
      - mailer-app-prod:/app
      - serenity-secrets:/run/serenity-secrets
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        umask 077
        python -m config.load_keys --seal-only
        python -m config.load_keys --load-only --print-export > /run/serenity-secrets/runtime.env
        chmod 644 /run/serenity-secrets/runtime.env
        exec sleep infinity

  mailer-tools:
    image: mailer-python:latest
    container_name: mailer-tools
    working_dir: /app
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
      - /home/eee/.ssh:/root/.ssh:ro
      - serenity-stat:/serenity-stat
      - ./:/app-dev
    command: ["/app/config/sh/with-secrets.sh", "sleep", "infinity"]

  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
      - mailer-app-prod:/app:ro
      - serenity-secrets:/run/serenity-secrets:ro
    entrypoint: ["/app/config/sh/with-secrets.sh", "docker-entrypoint.sh"]
    command:
      - postgres
      - -c
      - shared_preload_libraries=pg_stat_statements
      - -c
      - pg_stat_statements.track=all
      - -c
      - pg_stat_statements.max=10000
    ports:
      - "5433:5432"

  mailer-web:
    image: mailer-python:latest
    container_name: mailer-web
    working_dir: /app/web
    restart: unless-stopped
    user: "1001:1001"
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
    environment:
      DEBUG: "1"
      PYTHONPATH: /app
    volumes:
      - ./:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    ports:
      - "8000:8000"
    command: ["/app/config/sh/with-secrets.sh", "python", "manage.py", "runserver", "0.0.0.0:8000"]

  mailer-web-prod:
    image: mailer-python:latest
    container_name: mailer-web-prod
    working_dir: /app/web
    restart: unless-stopped
    depends_on:
      mailer-set-env:
        condition: service_started
      mailer-db:
        condition: service_started
    environment:
      DEBUG: "0"
      PYTHONPATH: /app
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    ports:
      - "8001:8000"
    command:
      [
        "/app/config/sh/with-secrets.sh",
        "gunicorn",
        "mailer_web.wsgi:application",
        "--bind",
        "0.0.0.0:8000",
        "--workers",
        "2",
        "--timeout",
        "120",
        "--access-logfile",
        "/app/logs/gunicorn_access.log",
        "--error-logfile",
        "/app/logs/gunicorn_error.log",
        "--capture-output",
        "--log-level",
        "info"
      ]

volumes:
  mailer-db-data:
    external: true
  mailer-app-prod:
    external: true
  mailer-static:
    external: true
  mailer-media:
    external: true
  serenity-stat:
    external: true
  serenity-redis-run:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=64m,uid=1001,gid=1001,mode=0777"
  serenity-secrets:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=16m,uid=0,gid=0,mode=0777"
