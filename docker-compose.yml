# FILE: docker-compose.yml  (обновлено — 2026-01-06)
# PURPOSE: Привести env DB_* и DEBUG к тому же формату, что использует Django settings + engine/common/db.py.

services:
  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: mailersys
      POSTGRES_USER: mailersys_user
      POSTGRES_PASSWORD: secret
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - webnet

  mailer-redis:
    image: redis:7-alpine
    container_name: mailer-redis
    restart: unless-stopped
    command:
      - redis-server
      - /app/config/redis/redis-dev.conf
    volumes:
      - ./:/app
    networks:
      - webnet

  mailer-web:
    build:
      context: .
      dockerfile: Dockerfile_Django
    container_name: mailer-web
    working_dir: /app/web
    restart: unless-stopped
    user: "1001:1001"
    depends_on:
      - mailer-db

    environment:
      # DB (container-mode)
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret

      # Django
      DEBUG: "1"
      PYTHONPATH: /app

      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

    volumes:
      - ./:/app

    ports:
      - "8000:8000"

    command: >
      /app/.venv/bin/python manage.py runserver 0.0.0.0:8000

    networks:
      - webnet

volumes:
  mailer-db-data:

networks:
  webnet:
    external: true
