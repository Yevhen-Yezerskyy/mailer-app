# FILE: docker-compose.yml
# DATE: 2026-01-25
# PURPOSE:
# - Switch secrets to config/load_keys.py (decrypt into process env at startup via SERENITY_KEYS_MASTER_KEY).
# - Remove plaintext DB_* / OPENAI_API_KEY from compose; services exec real process (gunicorn/python) as PID 1 after key-load.
# NOTE:
# - Provide SERENITY_KEYS_MASTER_KEY in host env (or .env) for containers that need secrets.

services:
  # -------- DEV --------
  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: mailersys
      POSTGRES_USER: mailersys_user
      POSTGRES_PASSWORD: secret
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
    command: >
      postgres -c shared_preload_libraries=pg_stat_statements
           -c pg_stat_statements.track=all
           -c pg_stat_statements.max=10000
    ports:
      - "5433:5432"
    networks: [webnet]

  mailer-redis:
    image: redis:7-alpine
    container_name: mailer-redis
    restart: unless-stopped
    command: ["redis-server", "/app/config/redis/redis-dev.conf"]
    volumes:
      - ./:/app
    networks: [webnet]

  mailer-web:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_Django
    container_name: mailer-web
    working_dir: /app/web
    restart: unless-stopped
    user: "1001:1001"
    depends_on: [mailer-db, mailer-redis]
    environment:
      PYTHONPATH: /app
      DEBUG: "1"
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - ./:/app
    ports:
      - "8000:8000"
    cpus: "0.5"
    command:
      [
        "/app/.venv/bin/python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('/app/.venv/bin/python',['/app/.venv/bin/python','manage.py','runserver','0.0.0.0:8000'])",
      ]
    networks: [webnet]

  # -------- PROD --------
  mailer-redis-prod:
    image: redis:7-alpine
    container_name: mailer-redis-prod
    restart: unless-stopped
    command: >
      /bin/sh -lc "mkdir -p /app/run/redis && chmod 777 /app/run/redis && exec redis-server /app/config/redis/redis-prod.conf"
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    networks: [webnet]

  # One-shot init: translate.py + collectstatic (только на compose up)
  mailer-init-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_web
    image: mailer-web-prod:latest
    container_name: mailer-init-prod
    working_dir: /app/web
    restart: "no"
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      DEBUG: "0"
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-redis-prod-run:/app/run/redis
    command: >
      /bin/sh -lc "
        eval \"$(python -m config.load_keys --print-export)\" &&
        python translate.py &&
        python manage.py collectstatic --noinput
      "
    networks: [webnet]

  mailer-web-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_web
    image: mailer-web-prod:latest
    container_name: mailer-web-prod
    working_dir: /app/web
    restart: unless-stopped
    depends_on:
      mailer-init-prod:
        condition: service_completed_successfully
      mailer-db:
        condition: service_started
      mailer-redis-prod:
        condition: service_started
    environment:
      PYTHONPATH: /app
      DEBUG: "0"
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-redis-prod-run:/app/run/redis
    ports:
      - "8001:8000"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('gunicorn',['gunicorn','mailer_web.wsgi:application','--bind','0.0.0.0:8000','--workers','2','--timeout','120'])",
      ]
    networks: [webnet]

  # Все воркеры на одном образе; каждому cap как было
  mailer-engine-cb-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_engine
    image: mailer-engine-prod:latest
    container_name: mailer-engine-cb-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_prepare.prepare_cb_processor'])",
      ]
    networks: [webnet]

  mailer-engine-val-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-val-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_validate.val_processor'])",
      ]
    networks: [webnet]

  mailer-engine-exp-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-exp-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_validate.val_expand_processor'])",
      ]
    networks: [webnet]

  mailer-engine-rate-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-rate-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_rate.rate_contacts_processor'])",
      ]
    networks: [webnet]

  mailer-engine-cr-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-cr-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.10"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.crawler.cr_processor'])",
      ]
    networks: [webnet]

  # -------- OPS / TOOLBOX --------
  mailer-ops-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_ops
    image: mailer-ops-prod:latest
    container_name: mailer-ops-prod
    working_dir: /app
    restart: unless-stopped
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-redis-prod-run:/app/run/redis
      - /home/eee/.ssh:/root/.ssh:ro
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('sh',['sh','-lc','sleep infinity'])",
      ]
    networks: [webnet]

  mailer-engine-stat-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-stat-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
      - serenity-stat:/var/www/serenity-stat
    cpus: "0.10"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_stats.stat_processor'])",
      ]
    networks: [webnet]

  mailer-engine-sender-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-sender-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.10"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_sender.sender'])",
      ]
    networks: [webnet]

volumes:
  mailer-db-data:

  mailer-app-prod:
    external: true

  mailer-static:
    external: true

  mailer-redis-prod-run:
    external: true
    name: mailer-redis-prod-run
    
  serenity-stat:
    external: true
    name: serenity-stat    

networks:
  webnet:
    external: true
