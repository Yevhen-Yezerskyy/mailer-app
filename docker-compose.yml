# FILE: docker-compose.yml
# DATE: 2026-02-09
# PURPOSE: PROD full stack (db+redis+web+engine+ops) + nginx+certbot.
#          DB_* secrets НЕ в compose: mailer-secrets-init расшифровывает через config/load_keys и пишет файлы в internal volume serenity-secrets.
#          Реально используемые данные-volumes = external: mailer-db-data, mailer-app-prod, mailer-static, mailer-media, mailer-redis-prod-run, serenity-stat.
#          Certbot + serenity-secrets = internal.

services:
  mailer-secrets-init:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_ops
    image: mailer-ops-prod:latest
    container_name: mailer-secrets-init
    working_dir: /app
    restart: "no"
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-secrets:/run/serenity-secrets
    command:
      - /bin/sh
      - -lc
      - |
        set -e
        eval "$(python -m config.load_keys --print-export)"
        umask 077
        mkdir -p /run/serenity-secrets

        [ -n "$${DB_NAME:-}" ] || { echo "DB_NAME missing" >&2; exit 2; }
        [ -n "$${DB_USER:-}" ] || { echo "DB_USER missing" >&2; exit 2; }
        [ -n "$${DB_PASSWORD:-}" ] || { echo "DB_PASSWORD missing" >&2; exit 2; }

        printf %s "$$DB_NAME" > /run/serenity-secrets/DB_NAME
        printf %s "$$DB_USER" > /run/serenity-secrets/DB_USER
        printf %s "$$DB_PASSWORD" > /run/serenity-secrets/DB_PASSWORD

  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    depends_on:
      mailer-secrets-init:
        condition: service_completed_successfully
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
      - serenity-secrets:/run/serenity-secrets:ro
    command: >
      bash -lc '
        export POSTGRES_DB="$(cat /run/serenity-secrets/DB_NAME)";
        export POSTGRES_USER="$(cat /run/serenity-secrets/DB_USER)";
        export POSTGRES_PASSWORD="$(cat /run/serenity-secrets/DB_PASSWORD)";
        exec docker-entrypoint.sh postgres
          -c shared_preload_libraries=pg_stat_statements
          -c pg_stat_statements.track=all
          -c pg_stat_statements.max=10000
      '

  mailer-redis-prod:
    image: redis:7-alpine
    container_name: mailer-redis-prod
    restart: unless-stopped
    command: >
      /bin/sh -lc "mkdir -p /app/run/redis && chmod 777 /app/run/redis && exec redis-server /app/config/redis/redis-prod.conf"
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis

  mailer-init-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_web
    image: mailer-web-prod:latest
    container_name: mailer-init-prod
    working_dir: /app/web
    restart: "no"
    depends_on:
      mailer-db:
        condition: service_started
      mailer-redis-prod:
        condition: service_started
    environment:
      PYTHONPATH: /app
      DEBUG: "0"
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - mailer-redis-prod-run:/app/run/redis
    command: >
      /bin/sh -lc "
        eval \"$(python -m config.load_keys --print-export)\" &&
        python translate.py &&
        python manage.py collectstatic --noinput
      "

  mailer-web-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_web
    image: mailer-web-prod:latest
    container_name: mailer-web-prod
    working_dir: /app/web
    restart: unless-stopped
    depends_on:
      mailer-init-prod:
        condition: service_completed_successfully
      mailer-db:
        condition: service_started
      mailer-redis-prod:
        condition: service_started
    environment:
      PYTHONPATH: /app
      DEBUG: "0"
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - mailer-redis-prod-run:/app/run/redis
    expose:
      - "8000"
    command:
      ["python","-c","import os; from config.load_keys import init_keys; init_keys(); os.execvp('gunicorn',['gunicorn','mailer_web.wsgi:application','--bind','0.0.0.0:8000','--workers','2','--timeout','120'])"]

  mailer-engine-cb-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_engine
    image: mailer-engine-prod:latest
    container_name: mailer-engine-cb-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command: ["python","-c","import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_prepare.prepare_cb_processor'])"]

  mailer-engine-val-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-val-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command: ["python","-c","import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_validate.val_processor'])"]

  mailer-engine-exp-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-exp-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command: ["python","-c","import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_validate.val_expand_processor'])"]

  mailer-engine-rate-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-rate-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command: ["python","-c","import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_rate.rate_contacts_processor'])"]

  mailer-engine-cr-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-cr-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.10"
    command: ["python","-c","import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.crawler.cr_processor'])"]

  mailer-engine-stat-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-stat-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
      - serenity-stat:/var/www/serenity-stat
    cpus: "0.10"
    command: ["python","-c","import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_stats.stat_processor'])"]

  mailer-engine-sender-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-sender-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.10"
    command: ["python","-c","import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_sender.sender'])"]

  mailer-ops-prod:
    image: mailer-ops-prod:latest
    container_name: mailer-ops-prod
    working_dir: /app
    restart: unless-stopped
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - mailer-redis-prod-run:/app/run/redis
      - /home/eee/.ssh:/root/.ssh:ro
    command: ["sh","-lc","sleep infinity"]

  nginx:
    image: nginx:1.26
    container_name: serenity-nginx
    restart: unless-stopped
    depends_on: [mailer-web-prod]
    ports: ["80:80","443:443"]
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./logs:/app/logs
      - mailer-static:/var/www/mail-static:ro
      - mailer-media:/var/www/mail-media:ro
      - serenity-stat:/var/www/serenity-stat:ro
      - certbot-www:/var/www/certbot
      - certbot-etc:/etc/letsencrypt

  certbot:
    image: certbot/certbot
    container_name: serenity-certbot
    restart: unless-stopped
    volumes:
      - certbot-www:/var/www/certbot
      - certbot-etc:/etc/letsencrypt
    command: >
      sh -c "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot; sleep 12h; done"

volumes:
  mailer-db-data:
    external: true
  mailer-app-prod:
    external: true
  mailer-static:
    external: true
  mailer-media:
    external: true
  mailer-redis-prod-run:
    external: true
  serenity-stat:
    external: true

  serenity-secrets:
  certbot-www:
  certbot-etc:
