# FILE: docker-compose.yml  (обновлено — 2026-01-06)
# PURPOSE: Ограничить CPU для dev Django (0.5) и для prod воркеров (0.20 каждый); prod web без лимита.

services:
  # -------- DEV --------
  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: mailersys
      POSTGRES_USER: mailersys_user
      POSTGRES_PASSWORD: secret
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
    command: >
      postgres -c shared_preload_libraries=pg_stat_statements
           -c pg_stat_statements.track=all
           -c pg_stat_statements.max=10000
    ports:
      - "5433:5432"
    networks: [webnet]

  mailer-redis:
    image: redis:7-alpine
    container_name: mailer-redis
    restart: unless-stopped
    command: ["redis-server", "/app/config/redis/redis-dev.conf"]
    volumes:
      - ./:/app
    networks: [webnet]

  mailer-web:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_Django
    container_name: mailer-web
    working_dir: /app/web
    restart: unless-stopped
    user: "1001:1001"
    depends_on: [mailer-db, mailer-redis]
    environment:
      PYTHONPATH: /app
      DEBUG: "1"
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - ./:/app
    ports:
      - "8000:8000"
    cpus: "0.5"
    command: >
      /app/.venv/bin/python manage.py runserver 0.0.0.0:8000
    networks: [webnet]

  # -------- PROD --------
  mailer-redis-prod:
    image: redis:7-alpine
    container_name: mailer-redis-prod
    restart: unless-stopped
    command: >
      /bin/sh -lc "mkdir -p /app/run/redis && chmod 777 /app/run/redis && exec redis-server /app/config/redis/redis-prod.conf"
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    networks: [webnet]

  mailer-web-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_web
    image: mailer-web-prod:latest
    container_name: mailer-web-prod
    working_dir: /app/web
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      DEBUG: "0"
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-redis-prod-run:/app/run/redis
    ports:
      - "8001:8000"
    command: >
      /bin/sh -lc "
        python manage.py collectstatic --noinput &&
        gunicorn mailer_web.wsgi:application --bind 0.0.0.0:8000 --workers 2 --timeout 120
      "
    networks: [webnet]

  # Все воркеры на одном образе; каждому cap 0.20 CPU
  mailer-engine-cb-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_engine
    image: mailer-engine-prod:latest
    container_name: mailer-engine-cb-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod]
    environment:
      PYTHONPATH: /app
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command: >
      /bin/sh -lc "python -m engine.core_prepare.prepare_cb_processor"
    networks: [webnet]

  mailer-engine-val-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-val-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command: >
      /bin/sh -lc "python -m engine.core_validate.val_processor"
    networks: [webnet]

  mailer-engine-exp-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-exp-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command: >
      /bin/sh -lc "python -m engine.core_validate.val_expand_processor"
    networks: [webnet]

  mailer-engine-rate-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-rate-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.15"
    command: >
      /bin/sh -lc "python -m engine.core_rate.rate_contacts_processor"
    networks: [webnet]

  mailer-engine-cr-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-cr-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis-prod, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-redis-prod-run:/app/run/redis
    cpus: "0.10"
    command: >
      /bin/sh -lc "python -m engine.crawler.cr_processor"
    networks: [webnet]

  # -------- OPS / TOOLBOX --------
  mailer-ops-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_ops
    image: mailer-ops-prod:latest
    container_name: mailer-ops-prod
    working_dir: /app
    restart: unless-stopped
    environment:
      PYTHONPATH: /app
      DB_HOST: mailer-db
      DB_PORT: "5432"
      DB_NAME: mailersys
      DB_USER: mailersys_user
      DB_PASSWORD: secret
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-redis-prod-run:/app/run/redis
      - /home/eee/.ssh:/root/.ssh:ro
    command: >
      /bin/sh -lc "sleep infinity"
    networks: [webnet]

volumes:
  mailer-db-data:

  mailer-app-prod:
    external: true

  mailer-static:
    external: true

  mailer-redis-prod-run:
    external: true
    name: mailer-redis-prod-run

networks:
  webnet:
    external: true
