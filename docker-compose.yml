# FILE: docker-compose.yml  (обновлено — 2026-02-09)
# PURPOSE:
# - Fix Postgres crash: do NOT use login-shell (-l) in db command (it can reset PATH => initdb not found).
# - Fix YAML issues: remove trailing commas in JSON-style command arrays (mailer-web / mailer-web-prod).
# - Keep secrets flow (serenity-secrets), single redis unix-socket tmpfs, nginx+certbot as-is.

services:
  # -------- SECRETS INIT (writes /run/serenity-secrets/*) --------

  mailer-secrets-init:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_ops
    image: mailer-ops-prod:latest
    container_name: mailer-secrets-init
    working_dir: /app
    restart: "no"
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-secrets:/run/serenity-secrets
    command:
      - /bin/sh
      - -c
      - |
        set -e
        python <<'PY'
        import os
        from pathlib import Path
        from config.load_keys import init_keys

        init_keys()

        base = Path("/run/serenity-secrets")
        base.mkdir(parents=True, exist_ok=True)

        for key in ("DB_NAME", "DB_USER", "DB_PASSWORD"):
            val = os.environ.get(key)
            if not val:
                raise SystemExit(f"{key} missing")
            (base / key).write_text(val)

        print("OK: serenity secrets written")
        PY

  # -------- ONE DB (dev+prod) --------
  mailer-db:
    image: postgres:16
    container_name: mailer-db
    restart: unless-stopped
    depends_on:
      mailer-secrets-init:
        condition: service_completed_successfully
    volumes:
      - mailer-db-data:/var/lib/postgresql/data
      - serenity-secrets:/run/serenity-secrets:ro
    command: >
      bash -c '
        export PATH="/usr/lib/postgresql/16/bin:$PATH";
        export POSTGRES_DB="$(cat /run/serenity-secrets/DB_NAME)";
        export POSTGRES_USER="$(cat /run/serenity-secrets/DB_USER)";
        export POSTGRES_PASSWORD="$(cat /run/serenity-secrets/DB_PASSWORD)";
        exec docker-entrypoint.sh postgres
          -c shared_preload_libraries=pg_stat_statements
          -c pg_stat_statements.track=all
          -c pg_stat_statements.max=10000
      '
    ports:
      - "5433:5432"

  # -------- ONE REDIS (dev+prod), unix-socket in tmpfs --------
  mailer-redis:
    image: redis:7-alpine
    container_name: mailer-redis
    restart: unless-stopped
    command: >
      /bin/sh -c "exec redis-server /etc/redis/redis.conf"
    volumes:
      - ./config/redis/redis-prod.conf:/etc/redis/redis.conf:ro
      - serenity-redis-run:/app/run/redis

  # -------- DEV: only mailer-web --------
  mailer-web:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_Django
    container_name: mailer-web
    working_dir: /app/web
    restart: unless-stopped
    user: "1001:1001"
    depends_on: [mailer-db, mailer-redis]
    environment:
      PYTHONPATH: /app
      DEBUG: "1"
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - ./:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    ports:
      - "8000:8000"
    cpus: "1.0"
    command:
      [
        "/app/.venv/bin/python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('/app/.venv/bin/python',['/app/.venv/bin/python','manage.py','runserver','0.0.0.0:8000'])"
      ]

  # -------- PROD: init (translate + collectstatic) --------
  mailer-init-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_web
    image: mailer-web-prod:latest
    container_name: mailer-init-prod
    working_dir: /app/web
    restart: "no"
    depends_on: [mailer-db, mailer-redis]
    environment:
      PYTHONPATH: /app
      DEBUG: "0"
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    command: >
      /bin/sh -c "
        eval \"$(python -m config.load_keys --print-export)\" &&
        python translate.py &&
        python manage.py collectstatic --noinput
      "

  mailer-web-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_web
    image: mailer-web-prod:latest
    container_name: mailer-web-prod
    working_dir: /app/web
    restart: unless-stopped
    depends_on:
      mailer-init-prod:
        condition: service_completed_successfully
      mailer-db:
        condition: service_started
      mailer-redis:
        condition: service_started
    environment:
      PYTHONPATH: /app
      DEBUG: "0"
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    ports:
      - "8001:8000"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('gunicorn',['gunicorn','mailer_web.wsgi:application','--bind','0.0.0.0:8000','--workers','2','--timeout','120'])"
      ]

  # -------- PROD ENGINE WORKERS --------
  mailer-engine-cb-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_prod_engine
    image: mailer-engine-prod:latest
    container_name: mailer-engine-cb-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.15"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_prepare.prepare_cb_processor'])"
      ]

  mailer-engine-val-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-val-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.15"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_validate.val_processor'])"
      ]

  mailer-engine-exp-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-exp-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.15"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_validate.val_expand_processor'])"
      ]

  mailer-engine-rate-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-rate-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.15"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_rate.rate_contacts_processor'])"
      ]

  mailer-engine-cr-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-cr-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis, mailer-engine-cb-prod]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.10"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.crawler.cr_processor'])"
      ]

  mailer-engine-stat-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-stat-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
      - serenity-stat:/var/www/serenity-stat
    cpus: "0.10"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_stats.stat_processor'])"
      ]

  mailer-engine-sender-prod:
    image: mailer-engine-prod:latest
    container_name: mailer-engine-sender-prod
    working_dir: /app
    restart: unless-stopped
    depends_on: [mailer-db, mailer-redis]
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
    cpus: "0.10"
    command:
      [
        "python",
        "-c",
        "import os; from config.load_keys import init_keys; init_keys(); os.execvp('python',['python','-m','engine.core_sender.sender'])"
      ]

  # -------- OPS / TOOLBOX --------
  mailer-ops-prod:
    build:
      context: .
      dockerfile: .DockerFiles/Dockerfile_ops
    image: mailer-ops-prod:latest
    container_name: mailer-ops-prod
    working_dir: /app
    restart: unless-stopped
    environment:
      PYTHONPATH: /app
      SERENITY_KEYS_MASTER_KEY: ${SERENITY_KEYS_MASTER_KEY:?missing}
      SERENITY_KEYS_MASTER_KEY_OLD: ${SERENITY_KEYS_MASTER_KEY_OLD:-}
    volumes:
      - mailer-app-prod:/app
      - mailer-static:/app/web/staticfiles
      - mailer-media:/app/web/media
      - serenity-redis-run:/app/run/redis
      - serenity-secrets:/run/serenity-secrets:ro
      - /home/eee/.ssh:/root/.ssh:ro
      - serenity-stat:/var/www/serenity-stat

    command: ["sh", "-c", "sleep infinity"]

  # -------- nginx + certbot --------
  nginx:
    image: nginx:1.26
    container_name: serenity-nginx
    restart: unless-stopped
    depends_on: [mailer-web-prod, mailer-web]
    ports: ["80:80", "443:443"]
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./logs:/app/logs
      - mailer-static:/var/www/mail-static:ro
      - mailer-media:/var/www/mail-media
      - serenity-stat:/var/www/serenity-stat
      - certbot-www:/var/www/certbot
      - certbot-etc:/etc/letsencrypt


volumes:
  mailer-db-data:
    external: true

  mailer-app-prod:
    external: true
  mailer-static:
    external: true
  mailer-media:
    external: true
  serenity-stat:
    external: true
    name: serenity-stat

  serenity-secrets:

  # shared in-RAM unix-socket volume for redis (/app/run/redis/redis.sock)
  serenity-redis-run:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=64m,uid=1001,gid=1001,mode=0777"

  certbot-www:
  certbot-etc:
